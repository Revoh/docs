<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1466.4001px" preserveAspectRatio="none" style="width:1449px;height:1466px;" version="1.1" viewBox="0 0 1449 1466" width="1449.6001px" zoomAndPan="magnify"><defs><filter height="300%" id="fi1umnw6vniy0" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.2000000476837158"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="2.4000000953674316" dy="2.4000000953674316" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="8.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="252" x="599.4" y="14.1211">6.2.1. postSettlementEvent POST: /settlementEventTrigger</text><rect fill="#FFB6C1" height="1439.2465" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="67.2" x="17.4" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="48.6" x="26.7" y="28.234">Central HUB</text><rect fill="#90EE90" height="1439.2465" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="685.5" x="314.7" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74.4" x="620.25" y="28.234">Settlement Service</text><rect fill="#FFFFE0" height="1439.2465" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="68.4" x="1200.6" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="1202.4" y="28.234">Central Services</text><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="17.5863" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="361.2" y="272.9672"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="136.077" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="361.2" y="1102.7473"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="114.6633" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="361.2" y="1278.1969"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="17.5863" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="647.4" y="290.5535"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="17.5863" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="647.4" y="1085.161"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="17.5863" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="647.4" y="1260.6106"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="952.4707" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="960.6" y="308.1399"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="1231.8" y="334.7262"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="1231.8" y="399.4852"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="1305.2743" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1435.2001" x="7.8" y="92.5723"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="87.3316" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="231" x="917.4" y="456.0305"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="44.959" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="219" x="923.4" y="494.2031"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="692.0485" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1423.2001" x="13.8" y="551.7621"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="493.0395" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="507.6" x="923.4" y="566.3485"/><rect fill="#FFFFFF" height="180.2227" style="stroke: none; stroke-width: 0.6000000238418579;" width="1423.2001" x="13.8" y="1063.5879"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="51" x2="51" y1="82.3723" y2="1408.0465"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="363.9" x2="363.9" y1="82.3723" y2="1408.0465"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="650.1" x2="650.1" y1="82.3723" y2="1408.0465"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="963.6" x2="963.6" y1="82.3723" y2="1408.0465"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="1234.8" x2="1234.8" y1="82.3723" y2="1408.0465"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="58.8" x="19.8" y="80.6004">Hub Employee</text><ellipse cx="51" cy="38.2793" fill="#FEFECE" filter="url(#fi1umnw6vniy0)" rx="4.8" ry="4.8" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><path d="M51,43.0793 L51,59.2793 M43.2,47.8793 L58.8,47.8793 M51,59.2793 L43.2,68.2793 M51,59.2793 L58.8,68.2793 " fill="none" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="58.8" x="19.8" y="1415.5676">Hub Employee</text><ellipse cx="51" cy="1423.3395" fill="#FEFECE" filter="url(#fi1umnw6vniy0)" rx="4.8" ry="4.8" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><path d="M51,1428.1395 L51,1444.3395 M43.2,1432.9395 L58.8,1432.9395 M51,1444.3395 L43.2,1453.3395 M51,1444.3395 L58.8,1453.3395 " fill="none" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="90.6" x="317.1" y="80.6004">Settlement Service API</text><path d="M351.9,55.6793 L351.9,70.0793 M351.9,62.8793 L362.1,62.8793 " fill="none" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><ellipse cx="369.3" cy="62.8793" fill="#FEFECE" filter="url(#fi1umnw6vniy0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="90.6" x="317.1" y="1415.5676">Settlement Service API</text><path d="M351.9,1419.7395 L351.9,1434.1395 M351.9,1426.9395 L362.1,1426.9395 " fill="none" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><ellipse cx="369.3" cy="1426.9395" fill="#FEFECE" filter="url(#fi1umnw6vniy0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="626.7" y="80.6004">Settlement</text><ellipse cx="650.4" cy="62.8793" fill="#FEFECE" filter="url(#fi1umnw6vniy0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><polygon fill="#A80036" points="648,55.6793,651.6,52.6793,650.4,55.6793,651.6,58.6793,648,55.6793" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="626.7" y="1415.5676">Settlement</text><ellipse cx="650.4" cy="1426.9395" fill="#FEFECE" filter="url(#fi1umnw6vniy0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><polygon fill="#A80036" points="648,1419.7395,651.6,1416.7395,650.4,1419.7395,651.6,1422.7395,648,1419.7395" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="929.4" y="80.6004">Settlement DAO</text><ellipse cx="963.6" cy="62.8793" fill="#FEFECE" filter="url(#fi1umnw6vniy0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="956.4" x2="970.8" y1="71.2793" y2="71.2793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="64.8" x="929.4" y="1415.5676">Settlement DAO</text><ellipse cx="963.6" cy="1426.9395" fill="#FEFECE" filter="url(#fi1umnw6vniy0)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="956.4" x2="970.8" y1="1435.3395" y2="1435.3395"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="1206" y="80.6004">Central Store</text><path d="M1224,50.8793 C1224,44.8793 1234.8,44.8793 1234.8,44.8793 C1234.8,44.8793 1245.6,44.8793 1245.6,50.8793 L1245.6,66.4793 C1245.6,72.4793 1234.8,72.4793 1234.8,72.4793 C1234.8,72.4793 1224,72.4793 1224,66.4793 L1224,50.8793 " fill="#FEFECE" filter="url(#fi1umnw6vniy0)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M1224,50.8793 C1224,56.8793 1234.8,56.8793 1234.8,56.8793 C1234.8,56.8793 1245.6,56.8793 1245.6,50.8793 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="1206" y="1415.5676">Central Store</text><path d="M1224,1423.3395 C1224,1417.3395 1234.8,1417.3395 1234.8,1417.3395 C1234.8,1417.3395 1245.6,1417.3395 1245.6,1423.3395 L1245.6,1438.9395 C1245.6,1444.9395 1234.8,1444.9395 1234.8,1444.9395 C1234.8,1444.9395 1224,1444.9395 1224,1438.9395 L1224,1423.3395 " fill="#FEFECE" filter="url(#fi1umnw6vniy0)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M1224,1423.3395 C1224,1429.3395 1234.8,1429.3395 1234.8,1429.3395 C1234.8,1429.3395 1245.6,1429.3395 1245.6,1423.3395 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="17.5863" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="361.2" y="272.9672"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="136.077" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="361.2" y="1102.7473"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="114.6633" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="361.2" y="1278.1969"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="17.5863" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="647.4" y="290.5535"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="17.5863" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="647.4" y="1085.161"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="17.5863" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="647.4" y="1260.6106"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="952.4707" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="960.6" y="308.1399"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="1231.8" y="334.7262"/><rect fill="#FFFFFF" filter="url(#fi1umnw6vniy0)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="1231.8" y="399.4852"/><path d="M7.8,92.5723 L136.2,92.5723 L136.2,96.7723 L130.2,102.7723 L7.8,102.7723 L7.8,92.5723 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="1305.2743" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1435.2001" x="7.8" y="92.5723"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101.4" x="16.8" y="100.7133">Trigger Settlement Event</text><path d="M54,105.9586 L54,231.3586 L158.4,231.3586 L158.4,111.9586 L152.4,105.9586 L54,105.9586 " fill="#FFFF00" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M152.4,105.9586 L152.4,111.9586 L158.4,111.9586 L152.4,105.9586 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="89.4" x="57.6" y="116.4996">settlementEventPayload</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="57.6" y="125.6859">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="65.4" x="62.4" y="134.8723">"settlementId": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="62.4" y="144.0586">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="87" x="62.4" y="153.2449">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="67.2" y="162.4313">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.2" x="72" y="171.6176">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="4.8" x="67.2" y="180.8039">},</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="67.2" y="189.9902">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.2" x="72" y="199.1766">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="67.2" y="208.3629">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="62.4" y="217.5492">]</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="57.6" y="226.7356">}</text><path d="M54,239.7809 L54,254.7809 L260.4,254.7809 L260.4,245.7809 L254.4,239.7809 L54,239.7809 " fill="#D3D3D3" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M254.4,239.7809 L254.4,245.7809 L260.4,245.7809 L254.4,239.7809 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="193.8" x="57.6" y="250.3219">verify if we need the rest of the Swagger messages?</text><polygon fill="#A80036" points="354,270.5672,360,272.9672,354,275.3672,356.4,272.9672" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="51" x2="357.6" y1="272.9672" y2="272.9672"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="55.2" y="270.3082">1</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="211.8" x="63" y="270.3082">API call Settlement Service to request a settlement event</text><polygon fill="#A80036" points="640.2,288.1535,646.2,290.5535,640.2,292.9535,642.6,290.5535" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="364.2" x2="643.8" y1="290.5535" y2="290.5535"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="368.4" y="287.8945">2</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="84" x="376.2" y="287.8945">Create new settlement</text><polygon fill="#A80036" points="953.4,305.7399,959.4,308.1399,953.4,310.5399,955.8,308.1399" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="650.4" x2="957" y1="308.1399" y2="308.1399"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="654.6" y="305.4809">3</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="86.4" x="662.4" y="305.4809">Initiate new settlement</text><polygon fill="#A80036" points="1224.6,332.3262,1230.6,334.7262,1224.6,337.1262,1227,334.7262" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="966.6" x2="1228.2" y1="334.7262" y2="334.7262"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="970.8" y="327.6604">4</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="81.6" x="978.6" y="323.0672">Insert new settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="978.6" y="332.2535">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="1024.8" y="332.2535">2001</text><polygon fill="#FFFFE0" filter="url(#fi1umnw6vniy0)" points="1213.2,360.8988,1255.8,360.8988,1261.8001,367.4988,1255.8,374.6988,1213.2,374.6988,1207.2,367.4988,1213.2,360.8988" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="40.2" x="1214.4" y="370.8399">settlement</text><polygon fill="#A80036" points="1224.6,397.0852,1230.6,399.4852,1224.6,401.8852,1227,399.4852" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="966.6" x2="1228.2" y1="399.4852" y2="399.4852"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="970.8" y="392.4194">5</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="126.6" x="978.6" y="387.8262">Get settlementWindow(s) from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="978.6" y="397.0125">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="1024.8" y="397.0125">2001</text><polygon fill="#FFFFE0" filter="url(#fi1umnw6vniy0)" points="1175.4,425.6578,1294.2001,425.6578,1300.2001,437.0578,1294.2001,448.4578,1175.4,448.4578,1169.4,437.0578,1175.4,425.6578" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="1176.6" y="435.5988">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="116.4" x="1176.6" y="444.7852">settlementWindowStateChange</text><path d="M917.4,456.0305 L1101,456.0305 L1101,460.2305 L1095,466.2305 L917.4,466.2305 L917.4,456.0305 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="87.3316" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="231" x="917.4" y="456.0305"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156.6" x="926.4" y="464.1715">Validate the list of settlement windows</text><path d="M969.6,469.4168 L969.6,484.4168 L1116.6,484.4168 L1116.6,475.4168 L1110.6,469.4168 L969.6,469.4168 " fill="#D3D3D3" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M1110.6,469.4168 L1110.6,475.4168 L1116.6,475.4168 L1110.6,469.4168 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="134.4" x="973.2" y="479.9578">allSettlementWindowsClosed = true</text><path d="M923.4,494.2031 L967.8,494.2031 L967.8,498.4031 L961.8,504.4031 L923.4,504.4031 L923.4,494.2031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="44.959" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="219" x="923.4" y="494.2031"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17.4" x="932.4" y="502.3442">loop</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="966.6" x2="991.8" y1="526.5621" y2="526.5621"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="991.8" x2="991.8" y1="526.5621" y2="534.3621"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="967.2" x2="991.8" y1="534.3621" y2="534.3621"/><polygon fill="#A80036" points="973.2,531.9621,967.2,534.3621,973.2,536.7621,970.8,534.3621" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="970.8" y="519.1237">6</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="978.6" y="514.5305">if settlementWindowStateId != 'CLOSED'</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="156.6" x="978.6" y="523.7168">then allSettlementWindowsClosed = false</text><path d="M13.8,551.7621 L51,551.7621 L51,555.9621 L45,561.9621 L13.8,561.9621 L13.8,551.7621 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="692.0485" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1423.2001" x="13.8" y="551.7621"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.2" x="22.8" y="559.9031">alt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129.6" x="60" y="559.343">[allSettlementWindowsClosed == true]</text><path d="M923.4,566.3485 L1022.4,566.3485 L1022.4,570.5485 L1016.4,576.5485 L923.4,576.5485 L923.4,566.3485 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="493.0395" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="507.6" x="923.4" y="566.3485"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="932.4" y="574.4895">DB TRANSACTION</text><polygon fill="#A80036" points="1227.6,586.9348,1233.6,589.3348,1227.6,591.7348,1230,589.3348" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="966.6" x2="1231.2" y1="589.3348" y2="589.3348"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="970.8" y="586.6758">7</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="136.8" x="978.6" y="586.6758">Insert the list of settlementWindows</text><polygon fill="#FFFFE0" filter="url(#fi1umnw6vniy0)" points="1178.4,597.3211,1290.6001,597.3211,1296.6001,603.9211,1290.6001,611.1211,1178.4,611.1211,1172.4,603.9211,1178.4,597.3211" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="109.8" x="1179.6" y="607.2621">settlementSettlementWindow</text><polygon fill="#A80036" points="1227.6,624.5074,1233.6,626.9074,1227.6,629.3074,1230,626.9074" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="966.6" x2="1231.2" y1="626.9074" y2="626.9074"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="970.8" y="624.2485">8</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="228" x="978.6" y="624.2485">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#fi1umnw6vniy0)" points="1050,634.8938,1419.0001,634.8938,1425.0001,696.6938,1419.0001,759.0938,1050,759.0938,1044,696.6938,1050,634.8938" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="1051.2" y="644.8348">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121.8" x="1101.6" y="644.8348">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="366.6" x="1051.2" y="654.0211">SELECT payload.settlementId AS settlementId, tp.participantCurrencyId, tp.participantRoleTypeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="186" x="1060.8" y="663.2074">tp.ledgerEntryTypeId, SUM(tp.amount) AS amount</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="1051.2" y="672.3938">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73.2" x="1075.2" y="672.3938">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="18" x="1150.8" y="672.3938">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="16.8" x="1051.2" y="681.5801">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="1070.4" y="681.5801">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="23.4" x="1156.2" y="681.5801">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="268.2" x="1051.2" y="690.7664">ON tsc.transferId = tf.transferId AND tsc.transferStateId = 'COMMITED'</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="16.8" x="1051.2" y="699.9528">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="1070.4" y="699.9528">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.8" x="1149" y="699.9528">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="117" x="1051.2" y="709.1391">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="129" x="1051.2" y="718.3254">WHERE tf.settlementWindowId IN (</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="106.2" x="1060.8" y="727.5117">SELECT settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="21.6" x="1060.8" y="736.6981">FROM</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="123" x="1084.8" y="736.6981">settlementSettelementWindow</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="168" x="1060.8" y="745.8844">WHERE settlementId = payload.settlementId)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="311.4" x="1051.2" y="755.0707">GROUP BY tp.participantCurrencyId, tp.participantRoleTypeId, tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1227.6,772.316,1233.6,774.716,1227.6,777.116,1230,774.716" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="966.6" x2="1231.2" y1="774.716" y2="774.716"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="970.8" y="772.0571">9</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="157.2" x="978.6" y="772.0571">Insert netAmount per participantCurrency</text><polygon fill="#FFFFE0" filter="url(#fi1umnw6vniy0)" points="1106.4,782.7024,1362.6001,782.7024,1368.6001,821.7024,1362.6001,860.7024,1106.4,860.7024,1100.4,821.7024,1106.4,782.7024" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="1107.6" y="792.6434">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="1158" y="792.6434">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="1107.6" y="801.8297">SELECT settlementId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="244.2" x="1117.2" y="811.016">SUM(CASE WHEN 'PAYER_DFSP', 'PRINCIPLE_VALUE' THEN amount</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="208.2" x="1138.8" y="820.2024">WHEN 'PAYEE_DFSP', 'PRINCIPLE_VALUE' THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="162" x="1138.8" y="829.3887">WHEN 'INTERCHANGE_FEE' THEN -amount)</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="135.6" x="1107.6" y="838.575">FROM settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="1107.6" y="847.7614">WHERE settlementId = payload.settlementId</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="173.4" x="1107.6" y="856.9477">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="1227.6,874.193,1233.6,876.593,1227.6,878.993,1230,876.593" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="966.6" x2="1231.2" y1="876.593" y2="876.593"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="970.8" y="873.934">10</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="984" y="873.934">Insert initial state change 'NOT_SETTLED'</text><polygon fill="#FFFFE0" filter="url(#fi1umnw6vniy0)" points="1096.2,884.5793,1372.8001,884.5793,1378.8001,904.9793,1372.8001,925.9793,1096.2,925.9793,1090.2,904.9793,1096.2,884.5793" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="1097.4" y="894.5203">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="175.2" x="1147.8" y="894.5203">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="274.2" x="1097.4" y="903.7067">SELECT settlementParticipantCurrencyId, 'NOT_SETTLED', payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138" x="1097.4" y="912.893">FROM settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="1097.4" y="922.0793">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="1227.6,939.3246,1233.6,941.7246,1227.6,944.1246,1230,941.7246" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="966.6" x2="1231.2" y1="941.7246" y2="941.7246"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="970.8" y="939.0657">11</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="181.8" x="984" y="939.0657">Insert initial state for settlement 'NOT_SETTLED'</text><polygon fill="#FFFFE0" filter="url(#fi1umnw6vniy0)" points="1133.4,949.711,1336.2001,949.711,1342.2001,970.111,1336.2001,991.111,1133.4,991.111,1127.4,970.111,1133.4,949.711" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="1134.6" y="959.652">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94.2" x="1185" y="959.652">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="200.4" x="1134.6" y="968.8383">SELECT settlementId, 'NOT_SETTLED', payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138" x="1134.6" y="978.0246">FROM settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="1134.6" y="987.211">WHERE settlementId = payload.settlementId</text><polygon fill="#A80036" points="1227.6,1004.4563,1233.6,1006.8563,1227.6,1009.2563,1230,1006.8563" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="966.6" x2="1231.2" y1="1006.8563" y2="1006.8563"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="970.8" y="1004.1973">12</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="984" y="1004.1973">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#fi1umnw6vniy0)" points="1116.6,1014.8426,1352.4001,1014.8426,1358.4001,1035.2426,1352.4001,1056.2426,1116.6,1056.2426,1110.6,1035.2426,1116.6,1014.8426" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48" x="1117.8" y="1024.7836">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="1168.2" y="1024.7836">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="233.4" x="1117.8" y="1033.97">SELECT settlementId, 'PENDING_SETTLEMENT', payload.reason</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138" x="1117.8" y="1043.1563">FROM settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="1117.8" y="1052.3426">WHERE settlementId = payload.settlementId</text><line style="stroke: #000000; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="13.8" x2="1437.0001" y1="1064.1879" y2="1064.1879"/><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132.6" x="16.8" y="1070.5688">[allSettlementWindowsClosed == false]</text><polygon fill="#A80036" points="660,1082.761,654,1085.161,660,1087.561,657.6,1085.161" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="656.4" x2="960" y1="1085.161" y2="1085.161"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="663.6" y="1082.502">13</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="177" x="676.8" y="1082.502">settlementWindows not closed - Return ERROR</text><polygon fill="#A80036" points="373.8,1100.3473,367.8,1102.7473,373.8,1105.1473,371.4,1102.7473" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="370.2" x2="649.8" y1="1102.7473" y2="1102.7473"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="377.4" y="1100.0883">14</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="51.6" x="390.6" y="1100.0883">Return ERROR</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="367.2" x2="392.4" y1="1120.52" y2="1120.52"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="392.4" x2="392.4" y1="1120.52" y2="1128.32"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="367.8" x2="392.4" y1="1128.32" y2="1128.32"/><polygon fill="#A80036" points="373.8,1125.92,367.8,1128.32,373.8,1130.72,371.4,1128.32" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="371.4" y="1117.6747">15</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="63.6" x="384.6" y="1117.6747">Update Event log</text><path d="M370.2,1136.12 L370.2,1160.12 L494.4,1160.12 L494.4,1142.12 L488.4,1136.12 L370.2,1136.12 " fill="#ADD8E6" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M488.4,1136.12 L488.4,1142.12 L494.4,1142.12 L488.4,1136.12 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="82.2" x="373.8" y="1146.661">Log ERROR Messages.</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="111.6" x="373.8" y="1155.8473">Update Event log with ERROR.</text><path d="M57,1168.8926 L57,1220.4926 L355.8,1220.4926 L355.8,1174.8926 L349.8,1168.8926 L57,1168.8926 " fill="#FFFF00" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M349.8,1168.8926 L349.8,1174.8926 L355.8,1174.8926 L349.8,1168.8926 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="60.6" y="1179.4336">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="41.4" x="65.4" y="1188.62">"status": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="281.4" x="65.4" y="1197.8063">"code": "(ERROR response code eg. '404' - Defined in swagger definition))",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="72" x="65.4" y="1206.9926">"message": "string"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="60.6" y="1216.179">}</text><polygon fill="#A80036" points="57.6,1236.4243,51.6,1238.8243,57.6,1241.2243,55.2,1238.8243" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="54" x2="363.6" y1="1238.8243" y2="1238.8243"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="61.2" y="1236.1653">16</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="51.6" x="74.4" y="1236.1653">Return ERROR</text><polygon fill="#A80036" points="660,1258.2106,654,1260.6106,660,1263.0106,657.6,1260.6106" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="656.4" x2="963" y1="1260.6106" y2="1260.6106"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="663.6" y="1257.9516">17</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="282.6" x="676.8" y="1257.9516">Results for participant netAmount per ledger for closed settlement window</text><polygon fill="#A80036" points="373.8,1275.7969,367.8,1278.1969,373.8,1280.5969,371.4,1278.1969" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="370.2" x2="649.8" y1="1278.1969" y2="1278.1969"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="377.4" y="1275.5379">18</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="255.6" x="390.6" y="1275.5379">Results for participant netAmount per ledger for settlement window</text><path d="M214.2,1286.1833 L214.2,1374.3833 L355.8,1374.3833 L355.8,1292.1833 L349.8,1286.1833 L214.2,1286.1833 " fill="#FFFF00" filter="url(#fi1umnw6vniy0)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M349.8,1286.1833 L349.8,1292.1833 L355.8,1292.1833 L349.8,1286.1833 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="217.8" y="1296.7243">{</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="48.6" x="222.6" y="1305.9106">"id": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="222.6" y="1315.0969">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="124.2" x="222.6" y="1324.2833">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="222.6" y="1333.4696">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="46.8" x="227.4" y="1342.6559">"amount": 0,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="71.4" x="227.4" y="1351.8422">"currency": "string"</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="222.6" y="1361.0286">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="217.8" y="1370.2149">}</text><polygon fill="#A80036" points="57.6,1390.4602,51.6,1392.8602,57.6,1395.2602,55.2,1392.8602" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="54" x2="363.6" y1="1392.8602" y2="1392.8602"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="61.2" y="1390.2012">19</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="282.6" x="74.4" y="1390.2012">Results for participant netAmount per ledger for closed settlement window</text><!--
@startuml
title 6.2.1. postSettlementEvent POST: /settlementEventTrigger

autonumber



actor "Hub Employee" as OPERATOR

boundary "Settlement Service API" as SSAPI
control "Settlement" as SETTLEMENT
entity "Settlement DAO" as SETTLE_DAO

database "Central Store" as DB

box "Central HUB" #LightPink
    participant OPERATOR
end box

box "Settlement Service" #LightGreen
    participant SSAPI
    participant SETTLEMENT
    participant SETTLE_DAO
end box

box "Central Services" #LightYellow
    participant DB
end box


group Trigger Settlement Event
    note right of OPERATOR #Yellow
        settlementEventPayload
        {
          "settlementId": 0,
          "reason": "string",
          "settlementWindows": [
            {
              "id": 1,
            },
            {
              "id": 2,
            }
          ]
        }
    end note
    note right of OPERATOR #LightGray
        verify if we need the rest of the Swagger messages?
    end note
    OPERATOR -> SSAPI: API call Settlement Service to request a settlement event
    activate SSAPI
    SSAPI-> SETTLEMENT: Create new settlement
    deactivate SSAPI
    activate SETTLEMENT
    SETTLEMENT -> SETTLE_DAO: Initiate new settlement
    deactivate SETTLEMENT
    activate SETTLE_DAO

    SETTLE_DAO -> DB: Insert new settlement \n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        settlement
    end hnote
    deactivate DB
    deactivate SETTLEMENT
    SETTLE_DAO -> DB: Get settlementWindow(s) from DB \n<color #FF0000><b>Error code:</b> 2001</color>
    activate DB
    hnote over DB #LightYellow
        settlementWindow
        settlementWindowStateChange
    end hnote
    deactivate DB
    group Validate the list of settlement windows
        note right of SETTLE_DAO #LightGray
            allSettlementWindowsClosed = true
        end note
        loop
            SETTLE_DAO <-> SETTLE_DAO: if settlementWindowStateId != 'CLOSED' \nthen allSettlementWindowsClosed = false
        end loop
    end
    alt allSettlementWindowsClosed == true
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Insert the list of settlementWindows
            hnote over DB #LightYellow
                settlementSettlementWindow
            end hnote
            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            hnote over DB #LightYellow
                INSERT INTO **settlementTransferParticipant**
                SELECT payload.settlementId AS settlementId, tp.participantCurrencyId, tp.participantRoleTypeId,
                    tp.ledgerEntryTypeId, SUM(tp.amount) AS amount
                FROM **transferFulfilment** AS tf
                JOIN **transferStateChange** AS tsc
                ON tsc.transferId = tf.transferId AND tsc.transferStateId = 'COMMITED'
                JOIN **transferParticipant** AS tp
                ON tp.transferId = tf.transferId
                WHERE tf.settlementWindowId IN (
                    SELECT settlementWindowId
                    FROM **settlementSettelementWindow**
                    WHERE settlementId = payload.settlementId)
                GROUP BY tp.participantCurrencyId, tp.participantRoleTypeId, tp.ledgerEntryTypeId
            end hnote

            SETTLE_DAO -> DB: Insert netAmount per participantCurrency
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrency**
                SELECT settlementId, participantCurrencyId,
                    SUM(CASE WHEN 'PAYER_DFSP', 'PRINCIPLE_VALUE' THEN amount
                             WHEN 'PAYEE_DFSP', 'PRINCIPLE_VALUE' THEN -amount
                             WHEN 'INTERCHANGE_FEE' THEN -amount)
                FROM settlementTransferParticipant
                WHERE settlementId = payload.settlementId
                GROUP BY settlementId, participantCurrencyId
            end hnote

            SETTLE_DAO -> DB: Insert initial state change 'NOT_SETTLED'
            hnote over DB #LightYellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                SELECT settlementParticipantCurrencyId, 'NOT_SETTLED', payload.reason
                FROM settlementParticipantCurrency
                WHERE settlementId = payload.settlementId
            end hnote

            SETTLE_DAO -> DB: Insert initial state for settlement 'NOT_SETTLED'
            hnote over DB #LightYellow
                INSERT INTO **settlementStateChange**
                SELECT settlementId, 'NOT_SETTLED', payload.reason
                FROM settlementParticipantCurrency
                WHERE settlementId = payload.settlementId
            end hnote

            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            hnote over DB #LightYellow
                INSERT INTO **settlementWindowStateChange**
                SELECT settlementId, 'PENDING_SETTLEMENT', payload.reason
                FROM settlementParticipantCurrency
                WHERE settlementId = payload.settlementId
            end hnote
        end

    else allSettlementWindowsClosed == false
        SETTLE_DAO -> SETTLEMENT: settlementWindows not closed - Return ERROR
        activate SETTLEMENT
        SETTLEMENT -> SSAPI: Return ERROR
        deactivate SETTLEMENT
        activate SSAPI
        SSAPI <-> SSAPI: Update Event log
        note right of SSAPI #LightBlue
            Log ERROR Messages.
            Update Event log with ERROR.
            end note
        note left of SSAPI #Yellow
            {
              "status": 0,
              "code": "(ERROR response code eg. '404' - Defined in swagger definition))",
              "message": "string"
            }
        end note
        OPERATOR <- SSAPI: Return ERROR
        deactivate SSAPI
    end

    SETTLEMENT <- SETTLE_DAO: Results for participant netAmount per ledger for closed settlement window
    deactivate SETTLE_DAO
    activate SETTLEMENT
    SETTLEMENT -> SSAPI: Results for participant netAmount per ledger for settlement window
    note left of SSAPI #Yellow
        {
          "id": "string",
          "reason": "string",
          "state": "PENDING_SETTLEMENT",
          "netSettlementAmount": {
            "amount": 0,
            "currency": "string"
          }
        }
    end note
    deactivate SETTLEMENT
    activate SSAPI
    SSAPI -> OPERATOR: Results for participant netAmount per ledger for closed settlement window
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b29
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>
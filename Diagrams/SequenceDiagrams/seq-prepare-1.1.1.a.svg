<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4753px" preserveAspectRatio="none" style="width:1961px;height:4753px;" version="1.1" viewBox="0 0 1961 4753" width="1961px" zoomAndPan="magnify"><defs><filter height="300%" id="f1k3d6d7g6g9qm" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="798.5" y="23.5352">1.1.1.a. Prepare Handler Consume (single message)</text><rect fill="#FFFFE0" height="4708.0215" style="stroke: #A80036; stroke-width: 1.0;" width="1845" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="891" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="4540.7344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="409" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="962" y="4042.1289"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252" y="4615.0215"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="726.1875"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="1154.5352"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="1369.0195"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="91.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="2306.5039"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="3072.8887"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="3362.2598"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1501.5" y="2466.0566"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1501.5" y="2720.8516"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="755.498"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="1183.8457"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="1398.3301"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="2495.3672"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="2750.1621"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="3102.1992"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="3391.5703"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="4526.7344" style="stroke: #000000; stroke-width: 2.0;" width="1937" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="315" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="325" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="852" x="325" y="337.1504"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="3074.041" style="stroke: #000000; stroke-width: 2.0;" width="1665" x="275" y="508.7031"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="1725.8691" style="stroke: #000000; stroke-width: 2.0;" width="1645" x="285" y="687.5664"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="1544.0059" style="stroke: #000000; stroke-width: 2.0;" width="1625" x="295" y="862.4297"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="852" x="325" y="886.7402"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="1147.3242" style="stroke: #000000; stroke-width: 2.0;" width="1605" x="305" y="1100.6035"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="828.6426" style="stroke: #000000; stroke-width: 2.0;" width="1585" x="315" y="1306.0879"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="797.332" style="stroke: #000000; stroke-width: 2.0;" width="1565" x="325" y="1330.3984"/><rect fill="#FFFFFF" height="57.2656" style="stroke: none; stroke-width: 1.0;" width="1565" x="325" y="1995.5781"/><rect fill="#FFFFFF" height="74.8867" style="stroke: none; stroke-width: 1.0;" width="1565" x="325" y="2052.8438"/><rect fill="#FFFFFF" height="106.1973" style="stroke: none; stroke-width: 1.0;" width="1605" x="305" y="2141.7305"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="77.2422" style="stroke: #000000; stroke-width: 2.0;" width="1015.5" x="325" y="2163.6855"/><rect fill="#FFFFFF" height="151.5078" style="stroke: none; stroke-width: 1.0;" width="1625" x="295" y="2254.9277"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1571" x="325" y="2427.4355"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1571" x="325" y="2682.2305"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1592" x="315" y="2994.6465"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1572" x="325" y="3018.957"/><rect fill="#FFFFFF" height="304.6816" style="stroke: none; stroke-width: 1.0;" width="1592" x="315" y="3271.0625"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1572" x="325" y="3293.0176"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="1015.5" x="325" y="3596.7441"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="1015.5" x="325" y="4080.1289"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="107" x2="107" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="414" x2="414" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="967" x2="967" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1114" x2="1114" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1256.5" x2="1256.5" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1389.5" x2="1389.5" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1506.5" x2="1506.5" y1="116.2871" y2="4677.0215"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1812" x2="1812" y1="116.2871" y2="4677.0215"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="30" y="101.334">Prepare-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="27" y="4676.0215"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="23" y="4680.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="30" y="4700.5566">Prepare-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="335" y="113.334">Prepare Event Handler</text><ellipse cx="414" cy="83.7988" fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="410,71.7988,416,66.7988,414,71.7988,416,76.7988,410,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="335" y="4689.5566">Prepare Event Handler</text><ellipse cx="414" cy="4708.5098" fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="410,4696.5098,416,4691.5098,414,4696.5098,416,4701.5098,410,4696.5098" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="886" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="882" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="889" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="886" y="4676.0215"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="882" y="4680.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="889" y="4700.5566">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1066" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1062" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1069" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1066" y="4676.0215"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1062" y="4680.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1069" y="4700.5566">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1187.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1183.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1190.5" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1187.5" y="4676.0215"/><rect fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1183.5" y="4680.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1190.5" y="4700.5566">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1340.5" y="113.334">Transfer DAO</text><ellipse cx="1390" cy="83.7988" fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1378" x2="1402" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1340.5" y="4689.5566">Transfer DAO</text><ellipse cx="1390" cy="4708.5098" fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1378" x2="1402" y1="4722.5098" y2="4722.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1449.5" y="113.334">Participant DAO</text><ellipse cx="1506.5" cy="83.7988" fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1494.5" x2="1518.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1449.5" y="4689.5566">Participant DAO</text><ellipse cx="1506.5" cy="4708.5098" fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1494.5" x2="1518.5" y1="4722.5098" y2="4722.5098"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1764" y="113.334">Central Store</text><path d="M1794,63.7988 C1794,53.7988 1812,53.7988 1812,53.7988 C1812,53.7988 1830,53.7988 1830,63.7988 L1830,89.7988 C1830,99.7988 1812,99.7988 1812,99.7988 C1812,99.7988 1794,99.7988 1794,89.7988 L1794,63.7988 " fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1794,63.7988 C1794,73.7988 1812,73.7988 1812,73.7988 C1812,73.7988 1830,73.7988 1830,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1764" y="4689.5566">Central Store</text><path d="M1794,4702.5098 C1794,4692.5098 1812,4692.5098 1812,4692.5098 C1812,4692.5098 1830,4692.5098 1830,4702.5098 L1830,4728.5098 C1830,4738.5098 1812,4738.5098 1812,4738.5098 C1812,4738.5098 1794,4738.5098 1794,4728.5098 L1794,4702.5098 " fill="#FEFECE" filter="url(#f1k3d6d7g6g9qm)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1794,4702.5098 C1794,4712.5098 1812,4712.5098 1812,4712.5098 C1812,4712.5098 1830,4712.5098 1830,4702.5098 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="4540.7344" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="409" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="962" y="4042.1289"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1252" y="4615.0215"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="726.1875"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="1154.5352"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="1369.0195"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="91.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="2306.5039"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="3072.8887"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1385" y="3362.2598"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1501.5" y="2466.0566"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1501.5" y="2720.8516"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="755.498"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="1183.8457"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="1398.3301"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="2495.3672"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="2750.1621"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="3102.1992"/><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1807" y="3391.5703"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4526.7344" style="stroke: #000000; stroke-width: 2.0;" width="1937" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Prepare Handler Consume</text><polygon fill="#A80036" points="123,167.9082,113,171.9082,123,175.9082,119,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="117" x2="408" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="129" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="142" y="167.166">Consume Prepare event message for Payer</text><path d="M315,216.9082 L399,216.9082 L399,223.9082 L389,233.9082 L315,233.9082 L315,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="315" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="330" y="230.4766">break</text><path d="M325,241.2188 L467,241.2188 L467,248.2188 L457,258.2188 L325,258.2188 L325,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="325" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="340" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="295.1504" y2="295.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="295.1504" y2="308.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="308.1504" y2="308.1504"/><polygon fill="#A80036" points="430,304.1504,420,308.1504,430,312.1504,426,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="282.7529">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="439" y="275.0977">Validate event - Rule: type == 'prepare' &amp;&amp; action == 'prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="439" y="290.4082">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="523" y="290.4082">2001</text><path d="M325,337.1504 L540,337.1504 L540,344.1504 L530,354.1504 L325,354.1504 L325,337.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="852" x="325" y="337.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="340" y="350.7188">Persist Event Information</text><polygon fill="#A80036" points="1102.5,396.7715,1112.5,400.7715,1102.5,404.7715,1106.5,400.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1108.5" y1="400.7715" y2="400.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="396.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="439" y="396.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="834" x="332" y="408.7715"/><polygon fill="#EEEEEE" points="332,408.7715,396,408.7715,396,415.7715,386,425.7715,332,425.7715,332,408.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="345" y="423.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="652" y="442.3398">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="810" y="442.3398">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="810" x2="842" y1="444.3398" y2="444.3398"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="842" y="442.3398">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="656" y="457.6504"/><path d="M275,508.7031 L494,508.7031 L494,515.7031 L484,525.7031 L275,525.7031 L275,508.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3074.041" style="stroke: #000000; stroke-width: 2.0;" width="1665" x="275" y="508.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="290" y="522.2715">Validate Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="547.3242" y2="547.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="547.3242" y2="560.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="560.3242" y2="560.3242"/><polygon fill="#A80036" points="430,556.3242,420,560.3242,430,564.3242,426,560.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="542.582">4</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="439" y="542.582">Schema validation of the incoming message</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="589.6348" y2="589.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="589.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="602.6348" y2="602.6348"/><polygon fill="#A80036" points="430,598.6348,420,602.6348,430,606.6348,426,602.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="584.8926">5</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="439" y="584.8926">Verify the message's signature (to be confirmed in future requirement)</text><path d="M424,615.6348 L424,670.6348 L789,670.6348 L789,625.6348 L779,615.6348 L424,615.6348 " fill="#D3D3D3" filter="url(#f1k3d6d7g6g9qm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M779,615.6348 L779,625.6348 L789,625.6348 L779,615.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="430" y="633.2031">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="430" y="648.5137">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="430" y="663.8242">It may need to be added in future for custom adapters.</text><path d="M285,687.5664 L496,687.5664 L496,694.5664 L486,704.5664 L285,704.5664 L285,687.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1725.8691" style="stroke: #000000; stroke-width: 2.0;" width="1645" x="285" y="687.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="166" x="300" y="701.1348">Validate Duplicate check</text><polygon fill="#A80036" points="1373,722.1875,1383,726.1875,1373,730.1875,1377,726.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1379" y1="726.1875" y2="726.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="721.4453">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="439" y="721.4453">Request to retrieve Transfer Hash for a transferId</text><polygon fill="#A80036" points="1795,751.498,1805,755.498,1795,759.498,1799,755.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1395" x2="1801" y1="755.498" y2="755.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1402" y="750.7559">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="1415" y="750.7559">Request Transfer Hash for a transferId</text><polygon fill="#FFFFE0" filter="url(#f1k3d6d7g6g9qm)" points="1736,768.498,1888,768.498,1898,779.498,1888,791.498,1736,791.498,1726,779.498,1736,768.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1738" y="785.0664">transferDuplicateCheck</text><polygon fill="#A80036" points="1406,814.1191,1396,818.1191,1406,822.1191,1402,818.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1400" x2="1811" y1="818.1191" y2="818.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1412" y="813.377">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1425" y="813.377">Return hash if it exists</text><polygon fill="#A80036" points="430,843.4297,420,847.4297,430,851.4297,426,847.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1389" y1="847.4297" y2="847.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="436" y="842.6875">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="449" y="842.6875">Return hash if it exists</text><path d="M295,862.4297 L357,862.4297 L357,869.4297 L347,879.4297 L295,879.4297 L295,862.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1544.0059" style="stroke: #000000; stroke-width: 2.0;" width="1625" x="295" y="862.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="310" y="875.998">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="372" y="875.0645">[If transferId exists]</text><path d="M325,886.7402 L540,886.7402 L540,893.7402 L530,903.7402 L325,903.7402 L325,886.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="852" x="325" y="886.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="340" y="900.3086">Persist Event Information</text><polygon fill="#A80036" points="1102.5,946.3613,1112.5,950.3613,1102.5,954.3613,1106.5,950.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1108.5" y1="950.3613" y2="950.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="945.6191">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="448" y="945.6191">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1k3d6d7g6g9qm)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="834" x="332" y="958.3613"/><polygon fill="#EEEEEE" points="332,958.3613,396,958.3613,396,965.3613,386,975.3613,332,975.3613,332,958.3613" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="345" y="972.9297">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="652" y="991.9297">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="810" y="991.9297">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="810" x2="842" y1="993.9297" y2="993.9297"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="842" y="991.9297">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="656" y="1007.2402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1072.6035" y2="1072.6035"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1072.6035" y2="1085.6035"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1085.6035" y2="1085.6035"/><polygon fill="#A80036" points="430,1081.6035,420,1085.6035,430,1089.6035,426,1085.6035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1067.8613">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="448" y="1067.8613">Generate Hash for the incoming message and compare hashes</text><path d="M305,1100.6035 L367,1100.6035 L367,1107.6035 L357,1117.6035 L305,1117.6035 L305,1100.6035 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1147.3242" style="stroke: #000000; stroke-width: 2.0;" width="1605" x="305" y="1100.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="320" y="1114.1719">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="175" x="382" y="1113.2383">[Transfer exists, hash matches]</text><polygon fill="#A80036" points="1373,1150.5352,1383,1154.5352,1373,1158.5352,1377,1154.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1379" y1="1154.5352" y2="1154.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1142.1377">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="448" y="1134.4824">Request to retrieve Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="448" y="1149.793">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="525" y="1149.793">2003</text><polygon fill="#A80036" points="1795,1179.8457,1805,1183.8457,1795,1187.8457,1799,1183.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1395" x2="1801" y1="1183.8457" y2="1183.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1402" y="1179.1035">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1424" y="1179.1035">Request Transfer state</text><polygon fill="#FFFFE0" filter="url(#f1k3d6d7g6g9qm)" points="1746,1196.8457,1877,1196.8457,1887,1215.8457,1877,1234.8457,1746,1234.8457,1736,1215.8457,1746,1196.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1748" y="1213.4141">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1748" y="1228.7246">transferStateChange</text><polygon fill="#A80036" points="1406,1257.7773,1396,1261.7773,1406,1265.7773,1402,1261.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1400" x2="1811" y1="1261.7773" y2="1261.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1412" y="1257.0352">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="1434" y="1257.0352">Return Transfer state</text><polygon fill="#A80036" points="430,1287.0879,420,1291.0879,430,1295.0879,426,1291.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1389" y1="1291.0879" y2="1291.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1286.3457">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="458" y="1286.3457">Return Transfer state</text><path d="M315,1306.0879 L399,1306.0879 L399,1313.0879 L389,1323.0879 L315,1323.0879 L315,1306.0879 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="828.6426" style="stroke: #000000; stroke-width: 2.0;" width="1585" x="315" y="1306.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="330" y="1319.6563">break</text><path d="M325,1330.3984 L387,1330.3984 L387,1337.3984 L377,1347.3984 L325,1347.3984 L325,1330.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="797.332" style="stroke: #000000; stroke-width: 2.0;" width="1565" x="325" y="1330.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="340" y="1343.9668">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="267" x="402" y="1343.0332">[If transferState IN ['COMMITTED', 'ABORTED']]</text><polygon fill="#A80036" points="1373,1365.0195,1383,1369.0195,1373,1373.0195,1377,1369.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1379" y1="1369.0195" y2="1369.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1364.2773">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="448" y="1364.2773">Request to retrieve fulfilment, completedTimestamp for the transferId</text><polygon fill="#A80036" points="1795,1394.3301,1805,1398.3301,1795,1402.3301,1799,1398.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1395" x2="1801" y1="1398.3301" y2="1398.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1402" y="1393.5879">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="1424" y="1393.5879">Request fulfilment, completedTimestamp for the transferId</text><polygon fill="#FFFFE0" filter="url(#f1k3d6d7g6g9qm)" points="1753,1411.3301,1870,1411.3301,1880,1422.3301,1870,1434.3301,1753,1434.3301,1743,1422.3301,1753,1411.3301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1755" y="1427.8984">transferFulfilment</text><polygon fill="#A80036" points="1406,1456.9512,1396,1460.9512,1406,1464.9512,1402,1460.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1400" x2="1811" y1="1460.9512" y2="1460.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1412" y="1456.209">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="1434" y="1456.209">Return fulfilment, completedTimestamp (if they exist)</text><polygon fill="#A80036" points="430,1486.2617,420,1490.2617,430,1494.2617,426,1490.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1389" y1="1490.2617" y2="1490.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1485.5195">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="458" y="1485.5195">Return fulfilment, completedTimestamp (if they exist)</text><path d="M424,1503.2617 L424,1941.2617 L910,1941.2617 L910,1513.2617 L900,1503.2617 L424,1503.2617 " fill="#FFFF00" filter="url(#f1k3d6d7g6g9qm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M900,1503.2617 L900,1513.2617 L910,1513.2617 L900,1503.2617 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="430" y="1520.8301">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="1536.1406">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="1551.4512">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="446" y="1566.7617">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="446" y="1582.0723">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="1597.3828">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="446" y="1612.6934">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="462" y="1628.0039">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="462" y="1643.3145">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="478" y="1658.625">transferState: "COMMITTED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="417" x="478" y="1673.9355">fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="478" y="1689.2461">completedTimestamp: "2018-10-24T08:38:08.699-04:00"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="1704.5566">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="446" y="1719.8672">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="446" y="1735.1777">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="462" y="1750.4883">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="478" y="1765.7988">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="478" y="1781.1094">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="478" y="1796.4199">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="478" y="1811.7305">action: prepare-duplicate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="478" y="1827.041">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="478" y="1842.3516">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="494" y="1857.6621">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="494" y="1872.9727">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="478" y="1888.2832">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="1903.5938">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="446" y="1918.9043">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="1934.2148">}</text><polygon fill="#A80036" points="1245,1983.5781,1255,1987.5781,1245,1991.5781,1249,1987.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1251" y1="1987.5781" y2="1987.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1975.1807">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="448" y="1967.5254">Publish Notification event for Payer with the completed transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="792" x="448" y="1982.8359">For the Data Model, refer to the Swagger (transferState - mandatory, fulfilment, completedTimestamp - sample values above).</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="325" x2="1890" y1="1996.5781" y2="1996.5781"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="256" x="330" y="2007.2129">[If transferState IN ['RECEIVED', 'RESERVED']]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="2031.8438" y2="2031.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="2031.8438" y2="2044.8438"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="2044.8438" y2="2044.8438"/><polygon fill="#A80036" points="430,2040.8438,420,2044.8438,430,2048.8438,426,2044.8438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2027.1016">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="507" x="448" y="2027.1016">This request can be ignored, because a callback is about to be sent to the client.</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="325" x2="1890" y1="2053.8438" y2="2053.8438"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="173" x="330" y="2064.4785">[If transferState does not exist]</text><polygon fill="#A80036" points="1245,2115.7305,1255,2119.7305,1245,2123.7305,1249,2119.7305" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1251" y1="2119.7305" y2="2119.7305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2099.6777">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="448" y="2084.3672">Send /error callback with appropriate error message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="448" y="2099.6777">(Invalid duplicate request)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="448" y="2114.9883">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="525" y="2114.9883">3100</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="305" x2="1910" y1="2142.7305" y2="2142.7305"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="310" y="2153.3652">[Transfer exists, hash does not match]</text><path d="M325,2163.6855 L409,2163.6855 L409,2170.6855 L399,2180.6855 L325,2180.6855 L325,2163.6855 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="77.2422" style="stroke: #000000; stroke-width: 2.0;" width="1015.5" x="325" y="2163.6855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="340" y="2177.2539">break</text><polygon fill="#A80036" points="1245,2228.9277,1255,2232.9277,1245,2236.9277,1249,2232.9277" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1251" y1="2232.9277" y2="2232.9277"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2212.875">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="448" y="2197.5645">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2212.875">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2212.875">3106</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="568" y="2212.875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="487" x="448" y="2228.1855">For the Data Model, refer to the final step in this diagram (has the same text).</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="295" x2="1920" y1="2255.9277" y2="2255.9277"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="300" y="2266.5625">[If transferId does NOT exist]</text><polygon fill="#A80036" points="1373,2302.5039,1383,2306.5039,1373,2310.5039,1377,2306.5039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1379" y1="2306.5039" y2="2306.5039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2294.1064">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="448" y="2286.4512">Request to persist Transfer Hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="448" y="2301.7617">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="525" y="2301.7617">2003</text><polygon fill="#A80036" points="1800,2331.8145,1810,2335.8145,1800,2339.8145,1804,2335.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1395" x2="1806" y1="2335.8145" y2="2335.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1402" y="2331.0723">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="1424" y="2331.0723">Persist Transfer message hash</text><polygon fill="#FFFFE0" filter="url(#f1k3d6d7g6g9qm)" points="1736,2348.8145,1888,2348.8145,1898,2359.8145,1888,2371.8145,1736,2371.8145,1726,2359.8145,1736,2348.8145" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1738" y="2365.3828">transferDuplicateCheck</text><polygon fill="#A80036" points="430,2394.4355,420,2398.4355,430,2402.4355,426,2398.4355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1389" y1="2398.4355" y2="2398.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="2393.6934">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="2393.6934">Return success</text><path d="M325,2427.4355 L467,2427.4355 L467,2434.4355 L457,2444.4355 L325,2444.4355 L325,2427.4355 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1571" x="325" y="2427.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="340" y="2441.0039">Validate Payer</text><polygon fill="#A80036" points="1489.5,2462.0566,1499.5,2466.0566,1489.5,2470.0566,1493.5,2466.0566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1495.5" y1="2466.0566" y2="2466.0566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2461.3145">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="448" y="2461.3145">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1795,2491.3672,1805,2495.3672,1795,2499.3672,1799,2495.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1511.5" x2="1801" y1="2495.3672" y2="2495.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1518.5" y="2490.625">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1540.5" y="2490.625">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f1k3d6d7g6g9qm)" points="1748,2508.3672,1876,2508.3672,1886,2527.3672,1876,2546.3672,1748,2546.3672,1738,2527.3672,1748,2508.3672" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1750" y="2524.9355">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1750" y="2540.2461">participantCurrency</text><polygon fill="#A80036" points="1522.5,2569.2988,1512.5,2573.2988,1522.5,2577.2988,1518.5,2573.2988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1516.5" x2="1811" y1="2573.2988" y2="2573.2988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1528.5" y="2568.5566">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1550.5" y="2568.5566">Return Participant details if it exists</text><polygon fill="#A80036" points="430,2598.6094,420,2602.6094,430,2606.6094,426,2602.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1505.5" y1="2602.6094" y2="2602.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="2597.8672">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="458" y="2597.8672">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="2647.2305" y2="2647.2305"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="2647.2305" y2="2660.2305"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="2660.2305" y2="2660.2305"/><polygon fill="#A80036" points="430,2656.2305,420,2660.2305,430,2664.2305,426,2660.2305" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2634.833">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="448" y="2627.1777">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2642.4883">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2642.4883">3202</text><path d="M325,2682.2305 L469,2682.2305 L469,2689.2305 L459,2699.2305 L325,2699.2305 L325,2682.2305 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1571" x="325" y="2682.2305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="340" y="2695.7988">Validate Payee</text><polygon fill="#A80036" points="1489.5,2716.8516,1499.5,2720.8516,1489.5,2724.8516,1493.5,2720.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1495.5" y1="2720.8516" y2="2720.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2716.1094">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="448" y="2716.1094">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1795,2746.1621,1805,2750.1621,1795,2754.1621,1799,2750.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1511.5" x2="1801" y1="2750.1621" y2="2750.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1518.5" y="2745.4199">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1540.5" y="2745.4199">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#f1k3d6d7g6g9qm)" points="1748,2763.1621,1876,2763.1621,1886,2782.1621,1876,2801.1621,1748,2801.1621,1738,2782.1621,1748,2763.1621" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1750" y="2779.7305">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1750" y="2795.041">participantCurrency</text><polygon fill="#A80036" points="1522.5,2824.0938,1512.5,2828.0938,1522.5,2832.0938,1518.5,2828.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1516.5" x2="1811" y1="2828.0938" y2="2828.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1528.5" y="2823.3516">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1550.5" y="2823.3516">Return Participant details if it exists</text><polygon fill="#A80036" points="430,2853.4043,420,2857.4043,430,2861.4043,426,2857.4043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1505.5" y1="2857.4043" y2="2857.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="2852.6621">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="458" y="2852.6621">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="2902.0254" y2="2902.0254"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="2902.0254" y2="2915.0254"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="2915.0254" y2="2915.0254"/><polygon fill="#A80036" points="430,2911.0254,420,2915.0254,430,2919.0254,426,2915.0254" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2889.6279">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="448" y="2881.9727">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2897.2832">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2897.2832">3203</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="2966.6465" y2="2966.6465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="2966.6465" y2="2979.6465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="2979.6465" y2="2979.6465"/><polygon fill="#A80036" points="430,2975.6465,420,2979.6465,430,2983.6465,426,2979.6465" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2954.249">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="448" y="2946.5938">Validate crypto-condition</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2961.9043">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2961.9043">3100</text><path d="M315,2994.6465 L377,2994.6465 L377,3001.6465 L367,3011.6465 L315,3011.6465 L315,2994.6465 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1592" x="315" y="2994.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="330" y="3008.2148">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="392" y="3007.2813">[Validate Prepare Transfer (success)]</text><path d="M325,3018.957 L797,3018.957 L797,3025.957 L787,3035.957 L325,3035.957 L325,3018.957 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1572" x="325" y="3018.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="427" x="340" y="3032.5254">Persist Transfer State (with transferState='RECEIVED-PREPARE')</text><polygon fill="#A80036" points="1373,3068.8887,1383,3072.8887,1373,3076.8887,1377,3072.8887" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1379" y1="3072.8887" y2="3072.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="3060.4912">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="448" y="3052.8359">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="3068.1465">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="3068.1465">2003</text><polygon fill="#A80036" points="1795,3098.1992,1805,3102.1992,1795,3106.1992,1799,3102.1992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1395" x2="1801" y1="3102.1992" y2="3102.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1402" y="3097.457">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1424" y="3097.457">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f1k3d6d7g6g9qm)" points="1746,3145.1992,1877,3145.1992,1887,3187.1992,1877,3229.1992,1746,3229.1992,1736,3187.1992,1746,3145.1992" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1748" y="3161.7676">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1748" y="3177.0781">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1748" y="3192.3887">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1748" y="3207.6992">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1748" y="3223.0098">ilpPacket</text><polygon fill="#A80036" points="430,3252.0625,420,3256.0625,430,3260.0625,426,3256.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1389" y1="3256.0625" y2="3256.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="3251.3203">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="3251.3203">Return success</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315" x2="1907" y1="3272.0625" y2="3272.0625"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="320" y="3282.6973">[Validate Prepare Transfer (failure)]</text><path d="M325,3293.0176 L1108,3293.0176 L1108,3300.0176 L1098,3310.0176 L325,3310.0176 L325,3293.0176 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1572" x="325" y="3293.0176"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="738" x="340" y="3306.5859">Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)</text><polygon fill="#A80036" points="1373,3358.2598,1383,3362.2598,1373,3366.2598,1377,3362.2598" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1379" y1="3362.2598" y2="3362.2598"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="3342.207">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="448" y="3326.8965">Request to persist transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="448" y="3342.207">(when Payee/Payer/crypto-condition validation fails)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="3357.5176">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="3357.5176">2003</text><polygon fill="#A80036" points="1795,3387.5703,1805,3391.5703,1795,3395.5703,1799,3391.5703" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1395" x2="1801" y1="3391.5703" y2="3391.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1402" y="3386.8281">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1424" y="3386.8281">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#f1k3d6d7g6g9qm)" points="1746,3434.5703,1877,3434.5703,1887,3483.5703,1877,3533.5703,1746,3533.5703,1736,3483.5703,1746,3434.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1748" y="3451.1387">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1748" y="3466.4492">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1748" y="3481.7598">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1748" y="3497.0703">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1748" y="3512.3809">transferError</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1748" y="3527.6914">ilpPacket</text><polygon fill="#A80036" points="430,3556.7441,420,3560.7441,430,3564.7441,426,3560.7441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1389" y1="3560.7441" y2="3560.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="3556.002">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="3556.002">Return success</text><path d="M325,3596.7441 L387,3596.7441 L387,3603.7441 L377,3613.7441 L325,3613.7441 L325,3596.7441 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="1015.5" x="325" y="3596.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="340" y="3610.3125">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="402" y="3609.3789">[Validate Prepare Transfer (success)]</text><path d="M424,3619.0547 L424,3996.0547 L686,3996.0547 L686,3629.0547 L676,3619.0547 L424,3619.0547 " fill="#FFFF00" filter="url(#f1k3d6d7g6g9qm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M676,3619.0547 L676,3629.0547 L686,3629.0547 L676,3619.0547 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="430" y="3636.623">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="3651.9336">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="3667.2441">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="446" y="3682.5547">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="446" y="3697.8652">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="3713.1758">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="446" y="3728.4863">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="462" y="3743.7969">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="462" y="3759.1074">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="446" y="3774.418">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="446" y="3789.7285">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="462" y="3805.0391">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="478" y="3820.3496">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="478" y="3835.6602">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="478" y="3850.9707">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="478" y="3866.2813">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="478" y="3881.5918">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="478" y="3896.9023">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="494" y="3912.2129">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="494" y="3927.5234">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="478" y="3942.834">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="3958.1445">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="446" y="3973.4551">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="3988.7656">}</text><polygon fill="#A80036" points="950,4038.1289,960,4042.1289,950,4046.1289,954,4042.1289" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="956" y1="4042.1289" y2="4042.1289"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="4029.7314">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="448" y="4022.0762">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="4037.3867">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="4037.3867">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="325" x2="1340.5" y1="4081.1289" y2="4081.1289"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="330" y="4091.7637">[Validate Prepare Transfer (failure)]</text><path d="M424,4100.084 L424,4569.084 L1031,4569.084 L1031,4110.084 L1021,4100.084 L424,4100.084 " fill="#FFFF00" filter="url(#f1k3d6d7g6g9qm)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1021,4100.084 L1021,4110.084 L1031,4110.084 L1021,4100.084 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="430" y="4117.6523">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="4132.9629">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="4148.2734">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="446" y="4163.584">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="4178.8945">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="4194.2051">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="446" y="4209.5156">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="462" y="4224.8262">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="462" y="4240.1367">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="478" y="4255.4473">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522" x="494" y="4270.7578">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="494" y="4286.0684">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="494" y="4301.3789">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="4316.6895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="446" y="4332">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="446" y="4347.3105">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="462" y="4362.6211">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="478" y="4377.9316">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="478" y="4393.2422">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="478" y="4408.5527">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="478" y="4423.8633">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="478" y="4439.1738">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="478" y="4454.4844">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="494" y="4469.7949">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="494" y="4485.1055">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="494" y="4500.416">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="478" y="4515.7266">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="4531.0371">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="446" y="4546.3477">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="4561.6582">}</text><polygon fill="#A80036" points="1240,4611.0215,1250,4615.0215,1240,4619.0215,1244,4615.0215" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1246" y1="4615.0215" y2="4615.0215"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="4602.624">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="448" y="4594.9688">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="4610.2793">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="4610.2793">2003</text><!--
@startuml
title 1.1.1.a. Prepare Handler Consume (single message)

autonumber


collections "Prepare-Topic-dfsp1" as TOPIC_PREPARE_DFSP1
control "Prepare Event Handler" as PREP_HANDLER
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_PREPARE_DFSP1
    participant PREP_HANDLER
    participant TOPIC_POSITION_DFSP1
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant TRANS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_PREPARE_DFSP1 <- PREP_HANDLER: Consume Prepare event message for Payer
    activate TOPIC_PREPARE_DFSP1
    deactivate TOPIC_PREPARE_DFSP1

    break
        group Validate Event
            PREP_HANDLER <-> PREP_HANDLER: Validate event - Rule: type == 'prepare' && action == 'prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0]]} \n
        |||
    end

    group Validate Prepare Transfer 
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Schema validation of the incoming message</color>
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Verify the message's signature (to be confirmed in future requirement)</color>
        note right of PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note
        group Validate Duplicate check
            PREP_HANDLER -> TRANS_DAO: Request to retrieve Transfer Hash for a transferId
            activate TRANS_DAO
            TRANS_DAO -> DB: Request Transfer Hash for a transferId
            activate DB
            hnote over DB #lightyellow
                transferDuplicateCheck
            end note
            TRANS_DAO <- - DB: Return hash if it exists
            deactivate DB
            PREP_HANDLER <- - TRANS_DAO: Return hash if it exists
            deactivate TRANS_DAO

            alt If transferId exists
                group Persist Event Information
                    |||
                    PREP_HANDLER -> TOPIC_EVENTS: Publish event information
                    ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0]]} \n
                    |||
                end
                PREP_HANDLER -> PREP_HANDLER: Generate Hash for the incoming message and compare hashes

                alt Transfer exists, hash matches    
                    PREP_HANDLER -> TRANS_DAO: Request to retrieve Transfer state \n<color #FF0000><b>Error code:</b> 2003</color>
                    activate TRANS_DAO
                    TRANS_DAO -> DB: Request Transfer state
                    hnote over DB #lightyellow
                        transfer
                        transferStateChange
                    end note
                    activate DB
                    TRANS_DAO <- - DB: Return Transfer state
                    deactivate DB
                    TRANS_DAO - -> PREP_HANDLER: Return Transfer state
                    deactivate TRANS_DAO
                    break
                        alt If transferState IN ['COMMITTED', 'ABORTED']
                            PREP_HANDLER -> TRANS_DAO: Request to retrieve fulfilment, completedTimestamp for the transferId
                            activate TRANS_DAO
                            TRANS_DAO -> DB: Request fulfilment, completedTimestamp for the transferId
                            activate DB
                            hnote over DB #lightyellow
                                transferFulfilment
                            end note
                            TRANS_DAO <- - DB: Return fulfilment, completedTimestamp (if they exist)
                            deactivate DB
                            PREP_HANDLER <- - TRANS_DAO: Return fulfilment, completedTimestamp (if they exist)
                            deactivate TRANS_DAO
                            note right of PREP_HANDLER #yellow
                            Message:
                            {
                                id: <transferMessage.transferId>
                                from: <transferMessage.payerFsp>,
                                to: <transferMessage.payeeFsp>,
                                type: application/json
                                content: {
                                    headers: <transferHeaders>,
                                    payload: {
                                        transferState: "COMMITTED",
                                        fulfilment: "WLctttbu2HvTsa1XWvUoGRcQozHsqeu9Ahl2JW9Bsu8",
                                        completedTimestamp: "2018-10-24T08:38:08.699-04:00"
                                    }
                                },
                                metadata: {
                                    event: {
                                        id: <uuid>,
                                        responseTo: <previous.uuid>,
                                        type: notification,
                                        action: prepare-duplicate,
                                        createdAt: <timestamp>,
                                        state: {
                                            status: "success",
                                            code: 0
                                        }
                                    }
                                }
                            }
                        end note
                            PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event for Payer with the completed transfer \nFor the Data Model, refer to the Swagger (transferState - mandatory, fulfilment, completedTimestamp - sample values above).
                        else If transferState IN ['RECEIVED', 'RESERVED']
                            PREP_HANDLER <-> PREP_HANDLER: This request can be ignored, because a callback is about to be sent to the client.
                        else If transferState does not exist
                            PREP_HANDLER -> TOPIC_NOTIFICATIONS: Send /error callback with appropriate error message\n(Invalid duplicate request)\n<color #FF0000><b>Error code:</b> 3100</color>
                        end
                    end
                else Transfer exists, hash does not match
                    break
                        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 3106</color> \nFor the Data Model, refer to the final step in this diagram (has the same text).
                    end
                end

            else If transferId does NOT exist
                PREP_HANDLER -> TRANS_DAO: Request to persist Transfer Hash \n<color #FF0000><b>Error code:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist Transfer message hash
                hnote over DB #lightyellow
                    transferDuplicateCheck
                end note
                TRANS_DAO - -> PREP_HANDLER: Return success
                deactivate TRANS_DAO
            end
            deactivate TRANS_DAO
            
        end

        group Validate Payer
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
        end
        group Validate Payee
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
        end
        PREP_HANDLER <-> PREP_HANDLER: Validate crypto-condition\n<color #FF0000><b>Error codes:</b> 3100</color>
        
        alt Validate Prepare Transfer (success)
            group Persist Transfer State (with transferState='RECEIVED-PREPARE')
                PREP_HANDLER -> TRANS_DAO: Request to persist transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    ilpPacket
                end note
                activate DB
                deactivate DB
                TRANS_DAO - -> PREP_HANDLER: Return success
                deactivate TRANS_DAO
            end
        else Validate Prepare Transfer (failure)
            group Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)
                PREP_HANDLER -> TRANS_DAO: Request to persist transfer\n(when Payee/Payer/crypto-condition validation fails)\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    transferError
                    ilpPacket
                end note
                activate DB
                deactivate DB
                TRANS_DAO - -> PREP_HANDLER: Return success
                deactivate TRANS_DAO
            end
        end

    end
    alt Validate Prepare Transfer (success)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_POSITION_DFSP1: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_POSITION_DFSP1
        deactivate TOPIC_POSITION_DFSP1
    else Validate Prepare Transfer (failure)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4430px" preserveAspectRatio="none" style="width:1737px;height:4430px;" version="1.1" viewBox="0 0 1737 4430" width="1737px" zoomAndPan="magnify"><defs><filter height="300%" id="f1ttjoq7h9cs2r" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="235" x="752" y="23.5352">2.3.1. Timeout Handler Consume</text><rect fill="#FFFFE0" height="4385.457" style="stroke: #A80036; stroke-width: 1.0;" width="1379.5" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="678.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="4211.1699" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="129.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="380" y="4285.457"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="748.5" y="3559.459"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="290.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="860.5" y="619.1875"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="860.5" y="970.1563"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="1575.8438" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="860.5" y="1167.3301"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110.5" y="302.4609"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="331.7715"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="648.498"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="999.4668"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="1263.2617"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="1539.6094"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="1846.5781"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="2122.9258"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="353.5215" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="2360.3418"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="4204.1699" style="stroke: #000000; stroke-width: 2.0;" width="1713" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="783" x="33" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="302.7266" style="stroke: #000000; stroke-width: 2.0;" width="1491" x="23" y="263.8398"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="400" x="33" y="499.9453"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="336.9688" style="stroke: #000000; stroke-width: 2.0;" width="1629" x="33" y="580.5664"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1529" x="33" y="931.5352"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="1622.4648" style="stroke: #000000; stroke-width: 2.0;" width="1683" x="33" y="1128.709"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="1149.7012" style="stroke: #000000; stroke-width: 2.0;" width="900" x="806" y="1182.3301"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="1565.2832" style="stroke: #000000; stroke-width: 2.0;" width="803" x="23" y="2765.1738"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="1454.3516" style="stroke: #000000; stroke-width: 2.0;" width="783" x="33" y="2869.1055"/><rect fill="#FFFFFF" height="725.998" style="stroke: none; stroke-width: 1.0;" width="783" x="33" y="3597.459"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="134" x2="134" y1="116.2871" y2="4354.457"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="385" x2="385" y1="116.2871" y2="4354.457"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="617" x2="617" y1="116.2871" y2="4354.457"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="753" x2="753" y1="116.2871" y2="4354.457"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="865" x2="865" y1="116.2871" y2="4354.457"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1115" x2="1115" y1="116.2871" y2="4354.457"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1366.5" x2="1366.5" y1="116.2871" y2="4354.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="177" x="43" y="113.334">Transfer Timeout Handler</text><ellipse cx="134.5" cy="83.7988" fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="130.5,71.7988,136.5,66.7988,134.5,71.7988,136.5,76.7988,130.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="177" x="43" y="4366.9922">Transfer Timeout Handler</text><ellipse cx="134.5" cy="4385.9453" fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="130.5,4373.9453,136.5,4368.9453,134.5,4373.9453,136.5,4378.9453,130.5,4373.9453" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="290" x="240" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="290" x="236" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="276" x="243" y="101.334">Topic-{currency}-DFSPn-Position-Abort</text><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="290" x="240" y="4353.457"/><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="290" x="236" y="4357.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="276" x="243" y="4377.9922">Topic-{currency}-DFSPn-Position-Abort</text><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="548" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="544" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="551" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="548" y="4353.457"/><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="544" y="4357.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="551" y="4377.9922">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="705" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="701" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="708" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="705" y="4353.457"/><rect fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="701" y="4357.457"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="708" y="4377.9922">Event-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="816" y="113.334">Transfer DAO</text><ellipse cx="865.5" cy="83.7988" fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="853.5" x2="877.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="816" y="4366.9922">Transfer DAO</text><ellipse cx="865.5" cy="4385.9453" fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="853.5" x2="877.5" y1="4399.9453" y2="4399.9453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="1065" y="113.334">Segment DAO</text><ellipse cx="1115.5" cy="83.7988" fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1103.5" x2="1127.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="1065" y="4366.9922">Segment DAO</text><ellipse cx="1115.5" cy="4385.9453" fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1103.5" x2="1127.5" y1="4399.9453" y2="4399.9453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1318.5" y="113.334">Central Store</text><path d="M1348.5,63.7988 C1348.5,53.7988 1366.5,53.7988 1366.5,53.7988 C1366.5,53.7988 1384.5,53.7988 1384.5,63.7988 L1384.5,89.7988 C1384.5,99.7988 1366.5,99.7988 1366.5,99.7988 C1366.5,99.7988 1348.5,99.7988 1348.5,89.7988 L1348.5,63.7988 " fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1348.5,63.7988 C1348.5,73.7988 1366.5,73.7988 1366.5,73.7988 C1366.5,73.7988 1384.5,73.7988 1384.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1318.5" y="4366.9922">Central Store</text><path d="M1348.5,4379.9453 C1348.5,4369.9453 1366.5,4369.9453 1366.5,4369.9453 C1366.5,4369.9453 1384.5,4369.9453 1384.5,4379.9453 L1384.5,4405.9453 C1384.5,4415.9453 1366.5,4415.9453 1366.5,4415.9453 C1366.5,4415.9453 1348.5,4415.9453 1348.5,4405.9453 L1348.5,4379.9453 " fill="#FEFECE" filter="url(#f1ttjoq7h9cs2r)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1348.5,4379.9453 C1348.5,4389.9453 1366.5,4389.9453 1366.5,4389.9453 C1366.5,4389.9453 1384.5,4389.9453 1384.5,4379.9453 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="4211.1699" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="129.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="380" y="4285.457"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="748.5" y="3559.459"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="290.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="860.5" y="619.1875"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="860.5" y="970.1563"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="1575.8438" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="860.5" y="1167.3301"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1110.5" y="302.4609"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="331.7715"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="648.498"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="999.4668"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="1263.2617"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="1539.6094"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="1846.5781"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="2122.9258"/><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="353.5215" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1361.5" y="2360.3418"/><path d="M13,133.2871 L239,133.2871 L239,140.2871 L229,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4204.1699" style="stroke: #000000; stroke-width: 2.0;" width="1713" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="28" y="146.8555">Timeout Handler Consume</text><path d="M33,157.5977 L248,157.5977 L248,164.5977 L238,174.5977 L33,174.5977 L33,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="783" x="33" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="48" y="171.166">Persist Event Information</text><polygon fill="#A80036" points="741.5,192.2188,751.5,196.2188,741.5,200.2188,745.5,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="747.5" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="146.5" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="159.5" y="191.4766">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1ttjoq7h9cs2r)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="765" x="40" y="204.2188"/><polygon fill="#EEEEEE" points="40,204.2188,104,204.2188,104,211.2188,94,221.2188,40,221.2188,40,204.2188" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="53" y="218.7871">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="325.5" y="237.7871">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="36" x="483.5" y="237.7871">9.1.0.</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="483.5" x2="519.5" y1="239.7871" y2="239.7871"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="519.5" y="237.7871">}</text><path d="M23,263.8398 L575,263.8398 L575,270.8398 L565,280.8398 L23,280.8398 L23,263.8398 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="302.7266" style="stroke: #000000; stroke-width: 2.0;" width="1491" x="23" y="263.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="507" x="38" y="277.4082">Get previous checkpoint of last record processed (Lower limit for inclusion)</text><polygon fill="#A80036" points="1098.5,298.4609,1108.5,302.4609,1098.5,306.4609,1102.5,302.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="1104.5" y1="302.4609" y2="302.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="146.5" y="297.7188">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="159.5" y="297.7188">Get last segment as @intervalMin</text><polygon fill="#A80036" points="1349.5,327.7715,1359.5,331.7715,1349.5,335.7715,1353.5,331.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1120.5" x2="1355.5" y1="331.7715" y2="331.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1127.5" y="327.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1140.5" y="327.0293">Get last segment as @intervalMin</text><polygon fill="#FFFFE0" filter="url(#f1ttjoq7h9cs2r)" points="1239,344.7715,1494,344.7715,1504,386.7715,1494,428.7715,1239,428.7715,1229,386.7715,1239,344.7715" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="1241" y="361.3398">SELECT value INTO @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1241" y="376.6504">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1281" y="376.6504">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1241" y="391.9609">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="1241" y="407.2715">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1241" y="422.582">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1131.5,451.6348,1121.5,455.6348,1131.5,459.6348,1127.5,455.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1125.5" x2="1365.5" y1="455.6348" y2="455.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1137.5" y="450.8926">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="1150.5" y="450.8926">Return @intervalMin</text><polygon fill="#A80036" points="150.5,480.9453,140.5,484.9453,150.5,488.9453,146.5,484.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="144.5" x2="1114.5" y1="484.9453" y2="484.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="156.5" y="480.2031">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="169.5" y="480.2031">Return @intervalMin</text><path d="M33,499.9453 L100,499.9453 L100,506.9453 L90,516.9453 L33,516.9453 L33,499.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="400" x="33" y="499.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="48" y="513.5137">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="115" y="512.5801">[@intervalMin IS NULL =&gt; segment record NOT FOUND]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="181.5" y1="538.5664" y2="538.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="181.5" x2="181.5" y1="538.5664" y2="551.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="140.5" x2="181.5" y1="551.5664" y2="551.5664"/><polygon fill="#A80036" points="150.5,547.5664,140.5,551.5664,150.5,555.5664,146.5,551.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="146.5" y="533.8242">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="159.5" y="533.8242">Set @intervalMin = 0</text><path d="M33,580.5664 L156,580.5664 L156,587.5664 L146,597.5664 L33,597.5664 L33,580.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="336.9688" style="stroke: #000000; stroke-width: 2.0;" width="1629" x="33" y="580.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="48" y="594.1348">Do Cleanup</text><polygon fill="#A80036" points="848.5,615.1875,858.5,619.1875,848.5,623.1875,852.5,619.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="854.5" y1="619.1875" y2="619.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="146.5" y="614.4453">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="159.5" y="614.4453">Clean up transferTimeout from finalised transfers</text><polygon fill="#A80036" points="1349.5,644.498,1359.5,648.498,1349.5,652.498,1353.5,648.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="870.5" x2="1355.5" y1="648.498" y2="648.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="877.5" y="643.7559">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="890.5" y="643.7559">Clean up transferTimeout from finalised transfers</text><polygon fill="#FFFFE0" filter="url(#f1ttjoq7h9cs2r)" points="1090,691.498,1642,691.498,1652,786.498,1642,882.498,1090,882.498,1080,786.498,1090,691.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="1092" y="708.0664">DELETE tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1092" y="723.377">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1132" y="723.377">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1246" y="723.377">AS tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="548" x="1092" y="738.6875">JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1116" y="753.998">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1156" y="753.998">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1270" y="753.998">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1116" y="769.3086">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1148" y="769.3086">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1291" y="769.3086">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1116" y="784.6191">ON tsc.transferId = tt1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1116" y="799.9297">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1092" y="815.2402">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1092" y="830.5508">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1124" y="830.5508">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1267" y="830.5508">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1092" y="845.8613">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="1092" y="861.1719">WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="485" x="1108" y="876.4824">, 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')</text><polygon fill="#A80036" points="150.5,905.5352,140.5,909.5352,150.5,913.5352,146.5,909.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="144.5" x2="864.5" y1="909.5352" y2="909.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="156.5" y="904.793">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="169.5" y="904.793">Return success</text><path d="M33,931.5352 L411,931.5352 L411,938.5352 L401,948.5352 L33,948.5352 L33,931.5352 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="1529" x="33" y="931.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="333" x="48" y="945.1035">Determine IntervalMax (Upper limit for inclusion)</text><polygon fill="#A80036" points="848.5,966.1563,858.5,970.1563,848.5,974.1563,852.5,970.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="854.5" y1="970.1563" y2="970.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="146.5" y="965.4141">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="168.5" y="965.4141">Get last transferStateChangeId as @intervalMax</text><polygon fill="#A80036" points="1349.5,995.4668,1359.5,999.4668,1349.5,1003.4668,1353.5,999.4668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="870.5" x2="1355.5" y1="999.4668" y2="999.4668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="877.5" y="994.7246">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="899.5" y="994.7246">Get last transferStateChangeId as @intervalMax</text><polygon fill="#FFFFE0" filter="url(#f1ttjoq7h9cs2r)" points="1190,1012.4668,1542,1012.4668,1552,1031.4668,1542,1050.4668,1190,1050.4668,1180,1031.4668,1190,1012.4668" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="1192" y="1029.0352">SELECT MAX(transferStateChangeId) INTO @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1192" y="1044.3457">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1232" y="1044.3457">transferStateChange</text><polygon fill="#A80036" points="881.5,1073.3984,871.5,1077.3984,881.5,1081.3984,877.5,1077.3984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="875.5" x2="1365.5" y1="1077.3984" y2="1077.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="887.5" y="1072.6563">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="909.5" y="1072.6563">Return @intervalMax</text><polygon fill="#A80036" points="150.5,1102.709,140.5,1106.709,150.5,1110.709,146.5,1106.709" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="144.5" x2="864.5" y1="1106.709" y2="1106.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="156.5" y="1101.9668">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="178.5" y="1101.9668">Return @intervalMax</text><path d="M33,1128.709 L388,1128.709 L388,1135.709 L378,1145.709 L33,1145.709 L33,1128.709 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1622.4648" style="stroke: #000000; stroke-width: 2.0;" width="1683" x="33" y="1128.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="310" x="48" y="1142.2773">Prepare data and return the list for expiration</text><polygon fill="#A80036" points="848.5,1163.3301,858.5,1167.3301,848.5,1171.3301,852.5,1167.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="854.5" y1="1167.3301" y2="1167.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="146.5" y="1162.5879">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="168.5" y="1162.5879">Prepare data and get transfers to be expired</text><path d="M806,1182.3301 L971,1182.3301 L971,1189.3301 L961,1199.3301 L806,1199.3301 L806,1182.3301 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1149.7012" style="stroke: #000000; stroke-width: 2.0;" width="900" x="806" y="1182.3301"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="821" y="1195.8984">DB TRANSACTION</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="870.5" x2="912.5" y1="1220.9512" y2="1220.9512"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="912.5" x2="912.5" y1="1220.9512" y2="1233.9512"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="871.5" x2="912.5" y1="1233.9512" y2="1233.9512"/><polygon fill="#A80036" points="881.5,1229.9512,871.5,1233.9512,881.5,1237.9512,877.5,1233.9512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="877.5" y="1216.209">15</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="899.5" y="1216.209">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="1055.5" y="1216.209">= now()</text><polygon fill="#A80036" points="1349.5,1259.2617,1359.5,1263.2617,1349.5,1267.2617,1353.5,1263.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="870.5" x2="1355.5" y1="1263.2617" y2="1263.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="877.5" y="1258.5195">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="899.5" y="1258.5195">Insert all new transfers still in processing state</text><polygon fill="#FFFFE0" filter="url(#f1ttjoq7h9cs2r)" points="1113,1306.2617,1619,1306.2617,1629,1401.2617,1619,1497.2617,1113,1497.2617,1103,1401.2617,1113,1306.2617" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1115" y="1322.8301">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1199" y="1322.8301">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="1309" y="1322.8301">(transferId, expirationDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="1115" y="1338.1406">SELECT t.transferId, t.expirationDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1115" y="1353.4512">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="1155" y="1353.4512">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1213" y="1353.4512">t</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="502" x="1115" y="1368.7617">JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1139" y="1384.0723">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1179" y="1384.0723">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="1139" y="1399.3828">WHERE transferStateChangeId &gt; @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="1139" y="1414.6934">AND transferStateChangeId &lt;= @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="1139" y="1430.0039">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="1115" y="1445.3145">ON ts.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1115" y="1460.625">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1147" y="1460.625">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1290" y="1460.625">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1115" y="1475.9355">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="1115" y="1491.2461">WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')</text><polygon fill="#A80036" points="1349.5,1535.6094,1359.5,1539.6094,1349.5,1543.6094,1353.5,1539.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="870.5" x2="1355.5" y1="1539.6094" y2="1539.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="877.5" y="1527.2119">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="899.5" y="1519.5566">Insert transfer state ABORTED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="899.5" y="1534.8672">expired RECEIVED_PREPARE transfers</text><polygon fill="#FFFFE0" filter="url(#f1ttjoq7h9cs2r)" points="1048,1582.6094,1685,1582.6094,1695,1693.6094,1685,1804.6094,1048,1804.6094,1038,1693.6094,1048,1582.6094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1050" y="1599.1777">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1134" y="1599.1777">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="633" x="1050" y="1614.4883">SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1050" y="1629.7988">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1090" y="1629.7988">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1204" y="1629.7988">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1050" y="1645.1094">JOIN (</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="460" x="1090" y="1645.1094">-- Following subquery is reused 3 times and may be optimized if needed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="528" x="1074" y="1660.4199">SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1074" y="1675.7305">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1114" y="1675.7305">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1257" y="1675.7305">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1074" y="1691.041">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1106" y="1691.041">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1220" y="1691.041">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="1074" y="1706.3516">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="1074" y="1721.6621">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1050" y="1736.9727">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1050" y="1752.2832">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1082" y="1752.2832">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1225" y="1752.2832">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1050" y="1767.5938">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1050" y="1782.9043">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="1050" y="1798.2148">AND tsc.transferStateId = 'RECEIVED_PREPARE'</text><polygon fill="#A80036" points="1349.5,1842.5781,1359.5,1846.5781,1349.5,1850.5781,1353.5,1846.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="870.5" x2="1355.5" y1="1846.5781" y2="1846.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="877.5" y="1834.1807">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="899.5" y="1826.5254">Insert transfer state EXPIRED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="899.5" y="1841.8359">expired RESERVED transfers</text><polygon fill="#FFFFE0" filter="url(#f1ttjoq7h9cs2r)" points="1047,1889.5781,1686,1889.5781,1696,1992.5781,1686,2096.5781,1047,2096.5781,1037,1992.5781,1047,1889.5781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1049" y="1906.1465">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1133" y="1906.1465">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="635" x="1049" y="1921.457">SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1049" y="1936.7676">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1089" y="1936.7676">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1203" y="1936.7676">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="564" x="1049" y="1952.0781">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1073" y="1967.3887">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1113" y="1967.3887">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1256" y="1967.3887">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1073" y="1982.6992">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1105" y="1982.6992">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1219" y="1982.6992">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="1073" y="1998.0098">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="1073" y="2013.3203">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1049" y="2028.6309">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1049" y="2043.9414">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1081" y="2043.9414">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1224" y="2043.9414">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1049" y="2059.252">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1049" y="2074.5625">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1049" y="2089.873">AND tsc.transferStateId = 'RESERVED'</text><polygon fill="#A80036" points="1349.5,2118.9258,1359.5,2122.9258,1349.5,2126.9258,1353.5,2122.9258" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="870.5" x2="1355.5" y1="2122.9258" y2="2122.9258"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="877.5" y="2118.1836">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="899.5" y="2118.1836">Update segment table to be used for the next run</text><polygon fill="#FFFFE0" filter="url(#f1ttjoq7h9cs2r)" points="1161,2165.9258,1571,2165.9258,1581,2245.9258,1571,2326.9258,1161,2326.9258,1151,2245.9258,1161,2165.9258" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="1163" y="2182.4941">IF @intervalMin = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1179" y="2197.8047">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1179" y="2213.1152">INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1215" y="2213.1152">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="1274" y="2213.1152">(segmentType, enumeration, tableName, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="1179" y="2228.4258">VALUES ('timeout', 0, 'transferStateChange', @intervalMax)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1163" y="2243.7363">ELSE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1179" y="2259.0469">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1233" y="2259.0469">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="1179" y="2274.3574">SET value = @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1179" y="2289.668">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="1179" y="2304.9785">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="1179" y="2320.2891">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1349.5,2356.3418,1359.5,2360.3418,1349.5,2364.3418,1353.5,2360.3418" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="870.5" x2="1355.5" y1="2360.3418" y2="2360.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="877.5" y="2355.5996">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="899.5" y="2355.5996">Get list of transfers to be expired with current state</text><polygon fill="#FFFFE0" filter="url(#f1ttjoq7h9cs2r)" points="1082,2373.3418,1650,2373.3418,1660,2530.3418,1650,2687.3418,1082,2687.3418,1072,2530.3418,1082,2373.3418" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="1084" y="2389.9102">SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="1116" y="2405.2207">tp2.participantCurrencyId payeeParticipantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1084" y="2420.5313">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1124" y="2420.5313">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1238" y="2420.5313">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="564" x="1084" y="2435.8418">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1116" y="2451.1523">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1156" y="2451.1523">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1299" y="2451.1523">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1116" y="2466.4629">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="1148" y="2466.4629">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1262" y="2466.4629">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="1116" y="2481.7734">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="1116" y="2497.084">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1084" y="2512.3945">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1084" y="2527.7051">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1116" y="2527.7051">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1259" y="2527.7051">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="1084" y="2543.0156">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1084" y="2558.3262">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1116" y="2558.3262">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1247" y="2558.3262">tp1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="1084" y="2573.6367">ON tp1.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="1084" y="2588.9473">AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="1084" y="2604.2578">AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1084" y="2619.5684">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1116" y="2619.5684">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1247" y="2619.5684">tp2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="1084" y="2634.8789">ON tp2.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="1084" y="2650.1895">AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="1084" y="2665.5">AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1084" y="2680.8105">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><polygon fill="#A80036" points="881.5,2709.8633,871.5,2713.8633,881.5,2717.8633,877.5,2713.8633" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="875.5" x2="1365.5" y1="2713.8633" y2="2713.8633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="887.5" y="2709.1211">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="909.5" y="2709.1211">Return list</text><polygon fill="#A80036" points="150.5,2739.1738,140.5,2743.1738,150.5,2747.1738,146.5,2743.1738" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="144.5" x2="864.5" y1="2743.1738" y2="2743.1738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="156.5" y="2738.4316">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="178.5" y="2738.4316">Return list</text><path d="M23,2765.1738 L97,2765.1738 L97,2772.1738 L87,2782.1738 L23,2782.1738 L23,2765.1738 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1565.2832" style="stroke: #000000; stroke-width: 2.0;" width="803" x="23" y="2765.1738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="2778.7422">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="160" x="112" y="2777.8086">[for each transfer in the list]</text><path d="M144,2812.4844 L144,2852.4844 L597,2852.4844 L597,2822.4844 L587,2812.4844 L144,2812.4844 " fill="#D3D3D3" filter="url(#f1ttjoq7h9cs2r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M587,2812.4844 L587,2822.4844 L597,2822.4844 L587,2812.4844 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="150" y="2830.0527">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="191" y="2830.0527">:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="199" y="2830.0527">Red</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="226" y="2830.0527">in the bellow messages is to be discussed with the DA</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="150" y="2845.3633">during review because at this point the referred data is not available.</text><path d="M33,2869.1055 L95,2869.1055 L95,2876.1055 L85,2886.1055 L33,2886.1055 L33,2869.1055 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1454.3516" style="stroke: #000000; stroke-width: 2.0;" width="783" x="33" y="2869.1055"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="48" y="2882.6738">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237" x="110" y="2881.7402">[transferStateId == 'RECEIVED_PREPARE']</text><path d="M144,2891.416 L144,3528.416 L548,3528.416 L548,2901.416 L538,2891.416 L144,2891.416 " fill="#FFFF00" filter="url(#f1ttjoq7h9cs2r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M538,2891.416 L538,2901.416 L548,2901.416 L538,2891.416 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="150" y="2908.9844">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="2924.2949">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="166" y="2939.6055">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="166" y="2954.916">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="166" y="2970.2266">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="166" y="2985.5371">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="166" y="3000.8477">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="182" y="3016.1582"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="182" y="3016.1582">headers:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="239" y="3016.1582">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="198" y="3031.4688">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="198" y="3046.7793">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="198" y="3062.0898">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="198" y="3077.4004">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="198" y="3092.7109">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="198" y="3108.0215">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="198" y="3123.332">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="198" y="3138.6426">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="198" y="3153.9531">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="198" y="3169.2637">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="182" y="3184.5742">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="182" y="3199.8848">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="202" y="3215.1953">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="218" y="3230.5059">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="218" y="3245.8164">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="218" y="3261.127">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="202" y="3276.4375">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="182" y="3291.748">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="166" y="3307.0586">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="166" y="3322.3691">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="182" y="3337.6797">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="198" y="3352.9902">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="198" y="3368.3008">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="198" y="3383.6113">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="198" y="3398.9219">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="198" y="3414.2324">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="214" y="3429.543">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="214" y="3444.8535">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="214" y="3460.1641">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="198" y="3475.4746">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="182" y="3490.7852">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3506.0957">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3521.4063">}</text><polygon fill="#A80036" points="736.5,3555.459,746.5,3559.459,736.5,3563.459,740.5,3559.459" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="742.5" y1="3559.459" y2="3559.459"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="146.5" y="3554.7168">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="168.5" y="3554.7168">Publish Notification event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="816" y1="3598.459" y2="3598.459"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="38" y="3609.0938">[transferStateId == 'RESERVED']</text><path d="M144,3617.4141 L144,4254.4141 L544,4254.4141 L544,3627.4141 L534,3617.4141 L144,3617.4141 " fill="#FFFF00" filter="url(#f1ttjoq7h9cs2r)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M534,3617.4141 L534,3627.4141 L544,3627.4141 L534,3617.4141 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="150" y="3634.9824">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3650.293">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="166" y="3665.6035">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="166" y="3680.9141">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="166" y="3696.2246">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="166" y="3711.5352">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="166" y="3726.8457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="182" y="3742.1563"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="53" x="182" y="3742.1563">headers:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="239" y="3742.1563">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="198" y="3757.4668">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="198" y="3772.7773">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="198" y="3788.0879">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="198" y="3803.3984">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="198" y="3818.709">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="198" y="3834.0195">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="198" y="3849.3301">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="198" y="3864.6406">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="198" y="3879.9512">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="198" y="3895.2617">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="182" y="3910.5723">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="182" y="3925.8828">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="198" y="3941.1934">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="214" y="3956.5039">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="214" y="3971.8145">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="214" y="3987.125">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="198" y="4002.4355">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="182" y="4017.7461">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="166" y="4033.0566">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="166" y="4048.3672">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="182" y="4063.6777">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="198" y="4078.9883">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="198" y="4094.2988">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="198" y="4109.6094">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="198" y="4124.9199">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="198" y="4140.2305">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="214" y="4155.541">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="214" y="4170.8516">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="214" y="4186.1621">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="198" y="4201.4727">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="182" y="4216.7832">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="4232.0938">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="4247.4043">}</text><polygon fill="#A80036" points="368,4281.457,378,4285.457,368,4289.457,372,4285.457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="374" y1="4285.457" y2="4285.457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="146.5" y="4280.7148">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="168.5" y="4280.7148">Route &amp; Publish Position event</text><!--
@startuml
title 2.3.1. Timeout Handler Consume 

autonumber


control "Transfer Timeout Handler" as TIMEOUT_HANDLER
collections "Topic-{currency}-DFSPn-Position-Abort" as TOPIC_POSITION_DFSP
collections "Notification-Topic" as NOTIFICATIONS_TOPIC
collections "Event-Topic" as EVENT_TOPIC
entity "Segment DAO" as SEGMENT_DAO
entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TIMEOUT_HANDLER
    participant TOPIC_POSITION_DFSP
    participant NOTIFICATIONS_TOPIC
    participant EVENT_TOPIC
    participant TRANSFER_DAO
    participant SEGMENT_DAO
    participant DB
end box


group Timeout Handler Consume
    activate TIMEOUT_HANDLER
    group Persist Event Information
        TIMEOUT_HANDLER -> EVENT_TOPIC: Publish event information
        ref over TIMEOUT_HANDLER, EVENT_TOPIC :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0.]]}
    end

    group Get previous checkpoint of last record processed (Lower limit for inclusion)
        TIMEOUT_HANDLER -> SEGMENT_DAO: Get last segment as @intervalMin
        activate SEGMENT_DAO
        SEGMENT_DAO -> DB: Get last segment as @intervalMin
        hnote over DB #lightyellow
            SELECT value INTO @intervalMin
            FROM **segment**
            WHERE segmentType = 'timeout'
            AND enumeration = 0
            AND tableName = 'transferStateChange'
        end note
        activate DB
        DB - -> SEGMENT_DAO: Return @intervalMin
        deactivate DB
        SEGMENT_DAO - -> TIMEOUT_HANDLER: Return @intervalMin
        deactivate SEGMENT_DAO
        opt @intervalMin IS NULL => segment record NOT FOUND
            TIMEOUT_HANDLER->TIMEOUT_HANDLER: Set @intervalMin = 0
        end
    end

    group Do Cleanup
        TIMEOUT_HANDLER -> TRANSFER_DAO: Clean up transferTimeout from finalised transfers
        activate TRANSFER_DAO
        TRANSFER_DAO -> DB: Clean up transferTimeout from finalised transfers
        hnote over DB #lightyellow
            DELETE tt
            FROM **transferTimeout** AS tt
            JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId
                  FROM **transferTimeout** tt1
                  JOIN **transferStateChange** tsc
                  ON tsc.transferId = tt1.transferId
                  GROUP BY transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'
                , 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')
        end note
        activate DB
        deactivate DB
        TRANSFER_DAO - -> TIMEOUT_HANDLER: Return success
        deactivate TRANSFER_DAO
    end

    group Determine IntervalMax (Upper limit for inclusion)
        TIMEOUT_HANDLER -> TRANSFER_DAO: Get last transferStateChangeId as @intervalMax
        activate TRANSFER_DAO
        TRANSFER_DAO -> DB: Get last transferStateChangeId as @intervalMax
        hnote over DB #lightyellow
            SELECT MAX(transferStateChangeId) INTO @intervalMax
            FROM **transferStateChange**
        end note
        activate DB
        DB - -> TRANSFER_DAO: Return @intervalMax
        deactivate DB
        TRANSFER_DAO - -> TIMEOUT_HANDLER: Return @intervalMax
        deactivate TRANSFER_DAO
    end

    
    group Prepare data and return the list for expiration
        TIMEOUT_HANDLER -> TRANSFER_DAO: Prepare data and get transfers to be expired
        activate TRANSFER_DAO
        group <color #blue>DB TRANSACTION</color>
            TRANSFER_DAO <-> TRANSFER_DAO: **transactionTimestamp** = now()
            TRANSFER_DAO -> DB: Insert all new transfers still in processing state
            hnote over DB #lightyellow
                INSERT INTO **transferTimeout**(transferId, expirationDate)
                SELECT t.transferId, t.expirationDate
                FROM **transfer** t
                JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange**
                      WHERE transferStateChangeId > @intervalMin
                      AND transferStateChangeId <= @intervalMax
                      GROUP BY transferId) ts
                ON ts.transferId = t.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')
            end note
            activate DB
            deactivate DB

            TRANSFER_DAO -> DB: Insert transfer state ABORTED for\nexpired RECEIVED_PREPARE transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN ( <color #FF0000>- - Following subquery is reused 3 times and may be optimized if needed</color>
                      SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RECEIVED_PREPARE'
            end note
            activate DB
            deactivate DB

            TRANSFER_DAO -> DB: Insert transfer state EXPIRED for\nexpired RESERVED transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RESERVED'
            end note
            activate DB
            deactivate DB

            TRANSFER_DAO -> DB: Update segment table to be used for the next run
            hnote over DB #lightyellow
                IF @intervalMin = 0
                    INSERT
                    INTO **segment**(segmentType, enumeration, tableName, value)
                    VALUES ('timeout', 0, 'transferStateChange', @intervalMax)
                ELSE
                    UPDATE **segment**
                    SET value = @intervalMax
                    WHERE segmentType = 'timeout'
                    AND enumeration = 0
                    AND tableName = 'transferStateChange'
            end note
            activate DB
            deactivate DB
        end

        TRANSFER_DAO -> DB: Get list of transfers to be expired with current state
        hnote over DB #lightyellow
            SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId, 
                    tp2.participantCurrencyId payeeParticipantId
            FROM **transferTimeout** tt
            JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                    FROM **transferStateChange** tsc1
                    JOIN **transferTimeout** tt1
                    ON tt1.transferId = tsc1.transferId
                    GROUP BY tsc1.transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            JOIN **transferParticipant** tp1
            ON tp1.transferId = tt.transferId
            AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}
            AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            JOIN **transferParticipant** tp2
            ON tp2.transferId = tt.transferId
            AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}
            AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            WHERE tt.expirationDate < {transactionTimestamp}
        end note
        activate DB
        TRANSFER_DAO <- - DB: Return list
        deactivate DB
        TRANSFER_DAO - -> TIMEOUT_HANDLER: Return list
        deactivate TRANSFER_DAO
    end

    loop for each transfer in the list
        |||
        note right of TIMEOUT_HANDLER #lightgray
            **TODO**: <color #FF0000>Red</color> in the bellow messages is to be discussed with the DA 
            during review because at this point the referred data is not available.
        end note

        alt transferStateId == 'RECEIVED_PREPARE'
            note right of TIMEOUT_HANDLER #yellow
                Message:
                {
                    id: <transferId>,
                    from: <payerParticipantId>,
                    to: <payeeParticipantId>,
                    type: application/json,
                    content: {
                        <color #FF0000>headers:</color> {
                            Content-Length: <Content-Length>,
                            Content-Type: <Content-Type>,
                            Date: <Date>,
                            X-Forwarded-For: <X-Forwarded-For>,
                            FSPIOP-Source: <FSPIOP-Source>,
                            FSPIOP-Destination: <FSPIOP-Destination>,
                            FSPIOP-Encryption: <FSPIOP-Encryption>,
                            FSPIOP-Signature: <FSPIOP-Signature>,
                            FSPIOP-URI: <FSPIOP-URI>,
                            FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                        },
                        payload: {
                             "errorInformation": {
                                 "errorCode": 3303,
                                 "errorDescription": "Transfer expired",
                                 "extensionList": <transferMessage.extensionList>
                             }
                        }
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            type: notification,
                            action: timeout-received,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            TIMEOUT_HANDLER -> EVENT_TOPIC: Publish Notification event
            activate EVENT_TOPIC
            deactivate EVENT_TOPIC
        else transferStateId == 'RESERVED'
            note right of TIMEOUT_HANDLER #yellow
                Message:
                {
                    id: <transferId>,
                    from: <payerParticipantId>,
                    to: <payeeParticipantId>,
                    type: application/json,
                    content: {
                        <color #FF0000>headers:</color> {
                            Content-Length: <Content-Length>,
                            Content-Type: <Content-Type>,
                            Date: <Date>,
                            X-Forwarded-For: <X-Forwarded-For>,
                            FSPIOP-Source: <FSPIOP-Source>,
                            FSPIOP-Destination: <FSPIOP-Destination>,
                            FSPIOP-Encryption: <FSPIOP-Encryption>,
                            FSPIOP-Signature: <FSPIOP-Signature>,
                            FSPIOP-URI: <FSPIOP-URI>,
                            FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                        },
                        payload: {
                            "errorInformation": {
                                "errorCode": 3303,
                                "errorDescription": "Transfer expired",
                                "extensionList": <transferMessage.extensionList>
                            }
                        }
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            type: position,
                            action: timeout-reserved,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            TIMEOUT_HANDLER -> TOPIC_POSITION_DFSP: Route & Publish Position event
            activate TOPIC_POSITION_DFSP
            deactivate TOPIC_POSITION_DFSP
        end

    end

    deactivate TIMEOUT_HANDLER
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3039px" preserveAspectRatio="none" style="width:1988px;height:3039px;" version="1.1" viewBox="0 0 1988 3039" width="1988px" zoomAndPan="magnify"><defs><filter height="300%" id="f1pt4h4rkscs2b" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="372" x="809" y="23.5352">1.1.2.a. Position Handler Consume (single message)</text><rect fill="#FFFFE0" height="2994.4023" style="stroke: #A80036; stroke-width: 1.0;" width="1905" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="921" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="2805.1152" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1689.6094"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293.5" y="2901.4023"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="556.3242"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="957.3613"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="1788.1855"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1540" y="706.877"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1540" y="1938.7383"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1656.5" y="1139.9141"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1656.5" y="2259.8438"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="585.6348"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="736.1875"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="986.6719"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1169.2246"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1817.4961"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1968.0488"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="2289.1543"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="2813.1152" style="stroke: #000000; stroke-width: 2.0;" width="1964" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="545" x="320" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="525" x="330" y="241.2188"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="895" x="330" y="321.8398"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="2446.0098" style="stroke: #000000; stroke-width: 2.0;" width="1647" x="320" y="493.3926"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="569.5898" style="stroke: #000000; stroke-width: 2.0;" width="1614" x="330" y="517.7031"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1627" x="330" y="1101.293"/><rect fill="#FFFFFF" height="1211.793" style="stroke: none; stroke-width: 1.0;" width="1647" x="320" y="1727.6094"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="457.6582" style="stroke: #000000; stroke-width: 2.0;" width="1614" x="330" y="1749.5645"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1627" x="330" y="2221.2227"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="108" x2="108" y1="116.2871" y2="2963.4023"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="420" x2="420" y1="116.2871" y2="2963.4023"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1037" x2="1037" y1="116.2871" y2="2963.4023"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1162" x2="1162" y1="116.2871" y2="2963.4023"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1298" x2="1298" y1="116.2871" y2="2963.4023"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1430" x2="1430" y1="116.2871" y2="2963.4023"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1545" x2="1545" y1="116.2871" y2="2963.4023"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1661" x2="1661" y1="116.2871" y2="2963.4023"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1872" x2="1872" y1="116.2871" y2="2963.4023"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="2962.4023"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="2966.4023"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="2986.9375">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="113.334">Position Event Handler</text><ellipse cx="420" cy="83.7988" fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,71.7988,422,66.7988,420,71.7988,422,76.7988,416,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="340" y="2975.9375">Position Event Handler</text><ellipse cx="420" cy="2994.8906" fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="416,2982.8906,422,2977.8906,420,2982.8906,422,2987.8906,416,2982.8906" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="978" y="2962.4023"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="974" y="2966.4023"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="981" y="2986.9375">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1114" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1110" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1117" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1114" y="2962.4023"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1110" y="2966.4023"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1117" y="2986.9375">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1229" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1225" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1232" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1229" y="2962.4023"/><rect fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1225" y="2966.4023"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1232" y="2986.9375">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1382" y="113.334">Position DAO</text><ellipse cx="1430" cy="83.7988" fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1418" x2="1442" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1382" y="2975.9375">Position DAO</text><ellipse cx="1430" cy="2994.8906" fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1418" x2="1442" y1="3008.8906" y2="3008.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1488" y="113.334">Participant DAO</text><ellipse cx="1545" cy="83.7988" fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1533" x2="1557" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1488" y="2975.9375">Participant DAO</text><ellipse cx="1545" cy="2994.8906" fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1533" x2="1557" y1="3008.8906" y2="3008.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1612" y="113.334">Transfer DAO</text><ellipse cx="1661.5" cy="83.7988" fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1649.5" x2="1673.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1612" y="2975.9375">Transfer DAO</text><ellipse cx="1661.5" cy="2994.8906" fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1649.5" x2="1673.5" y1="3008.8906" y2="3008.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1824" y="113.334">Central Store</text><path d="M1854,63.7988 C1854,53.7988 1872,53.7988 1872,53.7988 C1872,53.7988 1890,53.7988 1890,63.7988 L1890,89.7988 C1890,99.7988 1872,99.7988 1872,99.7988 C1872,99.7988 1854,99.7988 1854,89.7988 L1854,63.7988 " fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1854,63.7988 C1854,73.7988 1872,73.7988 1872,73.7988 C1872,73.7988 1890,73.7988 1890,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1824" y="2975.9375">Central Store</text><path d="M1854,2988.8906 C1854,2978.8906 1872,2978.8906 1872,2978.8906 C1872,2978.8906 1890,2978.8906 1890,2988.8906 L1890,3014.8906 C1890,3024.8906 1872,3024.8906 1872,3024.8906 C1872,3024.8906 1854,3024.8906 1854,3014.8906 L1854,2988.8906 " fill="#FEFECE" filter="url(#f1pt4h4rkscs2b)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1854,2988.8906 C1854,2998.8906 1872,2998.8906 1872,2998.8906 C1872,2998.8906 1890,2998.8906 1890,2988.8906 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.9082"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="2805.1152" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="415" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1032" y="1689.6094"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1293.5" y="2901.4023"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="556.3242"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="957.3613"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425" y="1788.1855"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1540" y="706.877"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1540" y="1938.7383"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1656.5" y="1139.9141"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1656.5" y="2259.8438"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="585.6348"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="736.1875"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="986.6719"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1169.2246"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1817.4961"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="1968.0488"/><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1867" y="2289.1543"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2813.1152" style="stroke: #000000; stroke-width: 2.0;" width="1964" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Position Handler Consume</text><polygon fill="#A80036" points="124,167.9082,114,171.9082,124,175.9082,120,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="118" x2="414" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="130" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="143" y="167.166">Consume Position event message for Payer</text><path d="M320,216.9082 L404,216.9082 L404,223.9082 L394,233.9082 L320,233.9082 L320,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="545" x="320" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="335" y="230.4766">break</text><path d="M330,241.2188 L472,241.2188 L472,248.2188 L462,258.2188 L330,258.2188 L330,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="525" x="330" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="345" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="279.8398" y2="279.8398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="279.8398" y2="292.8398"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="292.8398" y2="292.8398"/><polygon fill="#A80036" points="436,288.8398,426,292.8398,436,296.8398,432,292.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="275.0977">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="398" x="445" y="275.0977">Validate event - Rule: type == 'position' &amp;&amp; action == 'prepare'</text><path d="M330,321.8398 L545,321.8398 L545,328.8398 L535,338.8398 L330,338.8398 L330,321.8398 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="895" x="330" y="321.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="345" y="335.4082">Persist Event Information</text><polygon fill="#A80036" points="1150.5,381.4609,1160.5,385.4609,1150.5,389.4609,1154.5,385.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1156.5" y1="385.4609" y2="385.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="380.7188">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="445" y="380.7188">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1pt4h4rkscs2b)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="877" x="337" y="393.4609"/><polygon fill="#EEEEEE" points="337,393.4609,401,393.4609,401,400.4609,391,410.4609,337,410.4609,337,393.4609" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="350" y="408.0293">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="676.5" y="427.0293">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="36" x="834.5" y="427.0293">9.1.0.</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="834.5" x2="870.5" y1="429.0293" y2="429.0293"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="870.5" y="427.0293">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="680.5" y="442.3398"/><path d="M320,493.3926 L382,493.3926 L382,500.3926 L372,510.3926 L320,510.3926 L320,493.3926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2446.0098" style="stroke: #000000; stroke-width: 2.0;" width="1647" x="320" y="493.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="335" y="506.9609">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="397" y="506.0273">[Calulate &amp; Validate Latest Position (success)]</text><path d="M330,517.7031 L629,517.7031 L629,524.7031 L619,534.7031 L330,534.7031 L330,517.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="569.5898" style="stroke: #000000; stroke-width: 2.0;" width="1614" x="330" y="517.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="531.2715">Calculate position and persist change</text><polygon fill="#A80036" points="1413,552.3242,1423,556.3242,1413,560.3242,1417,556.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1419" y1="556.3242" y2="556.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="551.582">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="445" y="551.582">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1855,581.6348,1865,585.6348,1855,589.6348,1859,585.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435" x2="1861" y1="585.6348" y2="585.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1442" y="580.8926">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1455" y="580.8926">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1pt4h4rkscs2b)" points="1820,598.6348,1924,598.6348,1934,609.6348,1924,621.6348,1820,621.6348,1810,609.6348,1820,598.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="615.2031">transferPosition</text><polygon fill="#A80036" points="1446,644.2559,1436,648.2559,1446,652.2559,1442,648.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1440" x2="1871" y1="648.2559" y2="648.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1452" y="643.5137">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1465" y="643.5137">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="436,673.5664,426,677.5664,436,681.5664,432,677.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1429" y1="677.5664" y2="677.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="442" y="672.8242">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="455" y="672.8242">Return latest position</text><polygon fill="#A80036" points="1528,702.877,1538,706.877,1528,710.877,1532,706.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1534" y1="706.877" y2="706.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="432" y="702.1348">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="445" y="702.1348">Request position limits for Payer Participant</text><polygon fill="#A80036" points="1855,732.1875,1865,736.1875,1855,740.1875,1859,736.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1550" x2="1861" y1="736.1875" y2="736.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1557" y="731.4453">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1570" y="731.4453">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f1pt4h4rkscs2b)" points="1820,749.1875,1924,749.1875,1934,768.1875,1924,787.1875,1820,787.1875,1810,768.1875,1820,749.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1822" y="765.7559">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="781.0664">participantLimit</text><polygon fill="#A80036" points="1561,810.1191,1551,814.1191,1561,818.1191,1557,814.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1555" x2="1871" y1="814.1191" y2="814.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1567" y="809.377">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="1589" y="809.377">Return position limits</text><polygon fill="#A80036" points="436,839.4297,426,843.4297,436,847.4297,432,843.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1544" y1="843.4297" y2="843.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="838.6875">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="464" y="838.6875">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="872.7402" y2="872.7402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="872.7402" y2="885.7402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="885.7402" y2="885.7402"/><polygon fill="#A80036" points="436,881.7402,426,885.7402,436,889.7402,432,885.7402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="867.998">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="454" y="867.998">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="915.0508" y2="915.0508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="915.0508" y2="928.0508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="928.0508" y2="928.0508"/><polygon fill="#A80036" points="436,924.0508,426,928.0508,436,932.0508,432,928.0508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="910.3086">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="454" y="910.3086">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1413,953.3613,1423,957.3613,1413,961.3613,1417,957.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1419" y1="957.3613" y2="957.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="952.6191">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="454" y="952.6191">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1855,982.6719,1865,986.6719,1855,990.6719,1859,986.6719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435" x2="1861" y1="986.6719" y2="986.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442" y="981.9297">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1464" y="981.9297">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1pt4h4rkscs2b)" points="1820,1029.6719,1924,1029.6719,1934,1040.6719,1924,1052.6719,1820,1052.6719,1810,1040.6719,1820,1029.6719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="1046.2402">transferPosition</text><polygon fill="#A80036" points="436,1075.293,426,1079.293,436,1083.293,432,1079.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1429" y1="1079.293" y2="1079.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1074.5508">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="1074.5508">Return success</text><path d="M330,1101.293 L894,1101.293 L894,1108.293 L884,1118.293 L330,1118.293 L330,1101.293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1627" x="330" y="1101.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="345" y="1114.8613">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1644.5,1135.9141,1654.5,1139.9141,1644.5,1143.9141,1648.5,1139.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1650.5" y1="1139.9141" y2="1139.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1135.1719">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="1135.1719">Request to persist transfer</text><polygon fill="#A80036" points="1855,1165.2246,1865,1169.2246,1855,1173.2246,1859,1169.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1666.5" x2="1861" y1="1169.2246" y2="1169.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1673.5" y="1164.4824">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1695.5" y="1164.4824">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1pt4h4rkscs2b)" points="1806,1212.2246,1937,1212.2246,1947,1223.2246,1937,1235.2246,1806,1235.2246,1796,1223.2246,1806,1212.2246" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1808" y="1228.793">transferStateChange</text><polygon fill="#A80036" points="436,1257.8457,426,1261.8457,436,1265.8457,432,1261.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1660.5" y1="1261.8457" y2="1261.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1257.1035">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="1257.1035">Return success</text><path d="M430,1281.8457 L430,1658.8457 L692,1658.8457 L692,1291.8457 L682,1281.8457 L430,1281.8457 " fill="#FFFF00" filter="url(#f1pt4h4rkscs2b)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M682,1281.8457 L682,1291.8457 L692,1291.8457 L682,1281.8457 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="1299.4141">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1314.7246">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="1330.0352">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="452" y="1345.3457">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="452" y="1360.6563">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="1375.9668">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="1391.2773">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="1406.5879">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="468" y="1421.8984">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="1437.209">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="1452.5195">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="1467.8301">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="1483.1406">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="1498.4512">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="484" y="1513.7617">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="1529.0723">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="1544.3828">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="1559.6934">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="500" y="1575.0039">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="500" y="1590.3145">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="1605.625">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="1620.9355">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="1636.2461">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="1651.5566">}</text><polygon fill="#A80036" points="1020,1685.6094,1030,1689.6094,1020,1693.6094,1024,1689.6094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1026" y1="1689.6094" y2="1689.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1684.8672">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="454" y="1684.8672">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="320" x2="1967" y1="1728.6094" y2="1728.6094"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="325" y="1739.2441">[Calculate &amp; Validate Latest Position (failure)]</text><path d="M330,1749.5645 L629,1749.5645 L629,1756.5645 L619,1766.5645 L330,1766.5645 L330,1749.5645 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="457.6582" style="stroke: #000000; stroke-width: 2.0;" width="1614" x="330" y="1749.5645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="345" y="1763.1328">Calculate position and persist change</text><polygon fill="#A80036" points="1413,1784.1855,1423,1788.1855,1413,1792.1855,1417,1788.1855" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1419" y1="1788.1855" y2="1788.1855"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1783.4434">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="454" y="1783.4434">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1855,1813.4961,1865,1817.4961,1855,1821.4961,1859,1817.4961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435" x2="1861" y1="1817.4961" y2="1817.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442" y="1812.7539">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1464" y="1812.7539">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1pt4h4rkscs2b)" points="1820,1830.4961,1924,1830.4961,1934,1841.4961,1924,1853.4961,1820,1853.4961,1810,1841.4961,1820,1830.4961" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="1847.0645">transferPosition</text><polygon fill="#A80036" points="1446,1876.1172,1436,1880.1172,1446,1884.1172,1442,1880.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1440" x2="1871" y1="1880.1172" y2="1880.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1452" y="1875.375">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1474" y="1875.375">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="436,1905.4277,426,1909.4277,436,1913.4277,432,1909.4277" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1429" y1="1909.4277" y2="1909.4277"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="1904.6855">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="464" y="1904.6855">Return latest position</text><polygon fill="#A80036" points="1528,1934.7383,1538,1938.7383,1528,1942.7383,1532,1938.7383" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1534" y1="1938.7383" y2="1938.7383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="1933.9961">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="454" y="1933.9961">Request position limits for Payer Participant</text><polygon fill="#A80036" points="1855,1964.0488,1865,1968.0488,1855,1972.0488,1859,1968.0488" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1550" x2="1861" y1="1968.0488" y2="1968.0488"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1557" y="1963.3066">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="1579" y="1963.3066">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f1pt4h4rkscs2b)" points="1820,1981.0488,1924,1981.0488,1934,2000.0488,1924,2019.0488,1820,2019.0488,1810,2000.0488,1820,1981.0488" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1822" y="1997.6172">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1822" y="2012.9277">participantLimit</text><polygon fill="#A80036" points="1561,2041.9805,1551,2045.9805,1561,2049.9805,1557,2045.9805" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1555" x2="1871" y1="2045.9805" y2="2045.9805"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1567" y="2041.2383">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="1589" y="2041.2383">Return position limits</text><polygon fill="#A80036" points="436,2071.291,426,2075.291,436,2079.291,432,2075.291" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1544" y1="2075.291" y2="2075.291"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="2070.5488">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="464" y="2070.5488">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="2104.6016" y2="2104.6016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="2104.6016" y2="2117.6016"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="2117.6016" y2="2117.6016"/><polygon fill="#A80036" points="436,2113.6016,426,2117.6016,436,2121.6016,432,2117.6016" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="2099.8594">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="454" y="2099.8594">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="467" y1="2146.9121" y2="2146.9121"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="467" x2="467" y1="2146.9121" y2="2159.9121"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="426" x2="467" y1="2159.9121" y2="2159.9121"/><polygon fill="#A80036" points="436,2155.9121,426,2159.9121,436,2163.9121,432,2159.9121" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="2142.1699">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="454" y="2142.1699">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><path d="M430,2172.9121 L430,2197.9121 L562,2197.9121 L562,2182.9121 L552,2172.9121 L430,2172.9121 " fill="#FF0000" filter="url(#f1pt4h4rkscs2b)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M552,2172.9121 L552,2182.9121 L562,2182.9121 L552,2172.9121 " fill="#FF0000" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="436" y="2190.4805">Validation failure!</text><path d="M330,2221.2227 L891,2221.2227 L891,2228.2227 L881,2238.2227 L330,2238.2227 L330,2221.2227 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1627" x="330" y="2221.2227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="516" x="345" y="2234.791">Persist Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="1644.5,2255.8438,1654.5,2259.8438,1644.5,2263.8438,1648.5,2259.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1650.5" y1="2259.8438" y2="2259.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="2255.1016">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="454" y="2255.1016">Request to persist transfer</text><polygon fill="#A80036" points="1855,2285.1543,1865,2289.1543,1855,2293.1543,1859,2289.1543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1666.5" x2="1861" y1="2289.1543" y2="2289.1543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1673.5" y="2284.4121">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1695.5" y="2284.4121">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1pt4h4rkscs2b)" points="1806,2332.1543,1937,2332.1543,1947,2343.1543,1937,2355.1543,1806,2355.1543,1796,2343.1543,1806,2332.1543" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1808" y="2348.7227">transferStateChange</text><polygon fill="#A80036" points="436,2377.7754,426,2381.7754,436,2385.7754,432,2381.7754" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="430" x2="1660.5" y1="2381.7754" y2="2381.7754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="442" y="2377.0332">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="464" y="2377.0332">Return success</text><path d="M430,2401.7754 L430,2870.7754 L840,2870.7754 L840,2411.7754 L830,2401.7754 L430,2401.7754 " fill="#FFFF00" filter="url(#f1pt4h4rkscs2b)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M830,2401.7754 L830,2411.7754 L840,2411.7754 L830,2401.7754 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="436" y="2419.3438">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="2434.6543">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="2449.9648">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="452" y="2465.2754">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="452" y="2480.5859">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="452" y="2495.8965">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="452" y="2511.207">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="468" y="2526.5176">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="468" y="2541.8281">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="484" y="2557.1387">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="500" y="2572.4492">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="325" x="500" y="2587.7598">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="500" y="2603.0703">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2618.3809">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="452" y="2633.6914">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="452" y="2649.002">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="468" y="2664.3125">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="2679.623">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="484" y="2694.9336">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="484" y="2710.2441">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="484" y="2725.5547">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="484" y="2740.8652">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="484" y="2756.1758">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="500" y="2771.4863">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="500" y="2786.7969">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="500" y="2802.1074">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="484" y="2817.418">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="468" y="2832.7285">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="452" y="2848.0391">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="436" y="2863.3496">}</text><polygon fill="#A80036" points="1281.5,2897.4023,1291.5,2901.4023,1281.5,2905.4023,1285.5,2901.4023" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="425" x2="1287.5" y1="2901.4023" y2="2901.4023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="432" y="2896.6602">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="454" y="2896.6602">Publish Notification (failure) event for Payer</text><!--
@startuml
title 1.1.2.a. Position Handler Consume (single message)

autonumber


collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Participant DAO" as PARTICIPANT_DAO
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume
    TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event message for Payer
    activate TOPIC_POSITION_DFSP1
    deactivate TOPIC_POSITION_DFSP1

    break
        group Validate Event
            POS_HANDLER <-> POS_HANDLER: Validate event - Rule: type == 'position' && action == 'prepare'
        end
    end

    group Persist Event Information
        |||
        POS_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over POS_HANDLER, TOPIC_EVENTS :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0.]]} \n
        |||
    end

    alt Calulate & Validate Latest Position (success)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            activate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            DB - -> POS_DAO: Retrieve latest position from DB for Payer
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER -> PARTICIPANT_DAO: Request position limits for Payer Participant
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request position limits for Payer Participant
            activate DB
            hnote over DB #lightyellow
                participant
                participantLimit
            end note
            DB - -> PARTICIPANT_DAO: Return position limits
            deactivate DB
            deactivate DB
            PARTICIPANT_DAO - -> POS_HANDLER: Return position limits
            deactivate PARTICIPANT_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    else Calculate & Validate Latest Position (failure)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            activate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            DB - -> POS_DAO: Retrieve latest position from DB for Payer
            deactivate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER -> PARTICIPANT_DAO: Request position limits for Payer Participant
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request position limits for Payer Participant
            activate DB
            hnote over DB #lightyellow
                participant
                participantLimit
            end note
            DB - -> PARTICIPANT_DAO: Return position limits
            deactivate DB
            deactivate DB
            PARTICIPANT_DAO - -> POS_HANDLER: Return position limits
            deactivate PARTICIPANT_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            note right of POS_HANDLER #red: Validation failure!
        end
        
        group Persist Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
        deactivate POS_HANDLER
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
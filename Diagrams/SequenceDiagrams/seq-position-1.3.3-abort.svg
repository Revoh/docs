<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3545px" preserveAspectRatio="none" style="width:1676px;height:3545px;" version="1.1" viewBox="0 0 1676 3545" width="1676px" zoomAndPan="magnify"><defs><filter height="300%" id="f1r180sdc5o2s6" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="279" x="699.5" y="23.5352">1.3.3. Abort Position Handler Consume</text><rect fill="#FFFFE0" height="3499.8691" style="stroke: #A80036; stroke-width: 1.0;" width="1409.5" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="693.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="3332.582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="663.5" y="2413.584"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="663.5" y="3406.8691"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="810" y="1512.1621"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="211.5293"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="502.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="474.6348"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="1618.0938"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="1865.8887"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2519.5156"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2752"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="240.8398"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="528.2559"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="662.498"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="770.4297"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1647.4043"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1919.5098"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="2548.8262"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="2805.6211"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="3318.582" style="stroke: #000000; stroke-width: 2.0;" width="1652" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="1392.5645" style="stroke: #000000; stroke-width: 2.0;" width="1632" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1612" x="33" y="420.7031"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="746.5" x="888.5" y="489.6348"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="887.4219" style="stroke: #000000; stroke-width: 2.0;" width="1459" x="23" y="1564.1621"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1431.5" x="33" y="1811.957"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="888.5" y="1880.8887"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="979.2852" style="stroke: #000000; stroke-width: 2.0;" width="1459" x="23" y="2465.584"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1431.5" x="33" y="2698.0684"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="888.5" y="2767"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="116.2871" y2="3468.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="668.5" x2="668.5" y1="116.2871" y2="3468.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="814.5" x2="814.5" y1="116.2871" y2="3468.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="946.5" x2="946.5" y1="116.2871" y2="3468.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1396.5" x2="1396.5" y1="116.2871" y2="3468.8691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="113.334">Position Handler</text><ellipse cx="102.5" cy="83.7988" fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,71.7988,104.5,66.7988,102.5,71.7988,104.5,76.7988,98.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="3481.4043">Position Handler</text><ellipse cx="102.5" cy="3500.3574" fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,3488.3574,104.5,3483.3574,102.5,3488.3574,104.5,3493.3574,98.5,3488.3574" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="609.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="605.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="612.5" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="609.5" y="3467.8691"/><rect fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="605.5" y="3471.8691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="612.5" y="3492.4043">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="745.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="741.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="748.5" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="745.5" y="3467.8691"/><rect fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="741.5" y="3471.8691"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="748.5" y="3492.4043">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="898.5" y="113.334">Position DAO</text><ellipse cx="946.5" cy="83.7988" fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="934.5" x2="958.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="898.5" y="3481.4043">Position DAO</text><ellipse cx="946.5" cy="3500.3574" fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="934.5" x2="958.5" y1="3514.3574" y2="3514.3574"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1348.5" y="113.334">Central Store</text><path d="M1378.5,63.7988 C1378.5,53.7988 1396.5,53.7988 1396.5,53.7988 C1396.5,53.7988 1414.5,53.7988 1414.5,63.7988 L1414.5,89.7988 C1414.5,99.7988 1396.5,99.7988 1396.5,99.7988 C1396.5,99.7988 1378.5,99.7988 1378.5,89.7988 L1378.5,63.7988 " fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1378.5,63.7988 C1378.5,73.7988 1396.5,73.7988 1396.5,73.7988 C1396.5,73.7988 1414.5,73.7988 1414.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1348.5" y="3481.4043">Central Store</text><path d="M1378.5,3494.3574 C1378.5,3484.3574 1396.5,3484.3574 1396.5,3484.3574 C1396.5,3484.3574 1414.5,3484.3574 1414.5,3494.3574 L1414.5,3520.3574 C1414.5,3530.3574 1396.5,3530.3574 1396.5,3530.3574 C1396.5,3530.3574 1378.5,3530.3574 1378.5,3520.3574 L1378.5,3494.3574 " fill="#FEFECE" filter="url(#f1r180sdc5o2s6)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1378.5,3494.3574 C1378.5,3504.3574 1396.5,3504.3574 1396.5,3504.3574 C1396.5,3504.3574 1414.5,3504.3574 1414.5,3494.3574 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="3332.582" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="663.5" y="2413.584"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="663.5" y="3406.8691"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="810" y="1512.1621"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="211.5293"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="502.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="474.6348"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="1618.0938"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="1865.8887"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2519.5156"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="941.5" y="2752"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="240.8398"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="528.2559"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="662.498"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="770.4297"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1647.4043"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="1919.5098"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="2548.8262"/><rect fill="#FFFFFF" filter="url(#f1r180sdc5o2s6)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1391.5" y="2805.6211"/><path d="M13,133.2871 L278,133.2871 L278,140.2871 L268,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3318.582" style="stroke: #000000; stroke-width: 2.0;" width="1652" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="220" x="28" y="146.8555">Abort Position Handler Consume</text><path d="M23,157.5977 L90,157.5977 L90,164.5977 L80,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1392.5645" style="stroke: #000000; stroke-width: 2.0;" width="1632" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="171.166">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="105" y="170.2324">[type == 'position' &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="929.5,207.5293,939.5,211.5293,929.5,215.5293,933.5,211.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="935.5" y1="211.5293" y2="211.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="199.1318">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="127.5" y="191.4766">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="206.7871">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="206.7871">2003</text><polygon fill="#A80036" points="1379.5,236.8398,1389.5,240.8398,1379.5,244.8398,1383.5,240.8398" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1385.5" y1="240.8398" y2="240.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="958.5" y="236.0977">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="971.5" y="236.0977">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1r180sdc5o2s6)" points="1331,253.8398,1462,253.8398,1472,272.8398,1462,291.8398,1331,291.8398,1321,272.8398,1331,253.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1333" y="270.4082">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1333" y="285.7188">transferParticipant</text><polygon fill="#A80036" points="962.5,314.7715,952.5,318.7715,962.5,322.7715,958.5,318.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="956.5" x2="1395.5" y1="318.7715" y2="318.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="968.5" y="314.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="981.5" y="314.0293">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,344.082,108.5,348.082,118.5,352.082,114.5,348.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="945.5" y1="348.082" y2="348.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="124.5" y="343.3398">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="137.5" y="343.3398">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="392.7031" y2="392.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="392.7031" y2="405.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="405.7031" y2="405.7031"/><polygon fill="#A80036" points="118.5,401.7031,108.5,405.7031,118.5,409.7031,114.5,405.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="380.3057">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="529" x="127.5" y="372.6504">Validate current state (transferStateChange.transferStateId == 'RESERVED_TIMEOUT')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="387.9609">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="387.9609">2001</text><path d="M33,420.7031 L234,420.7031 L234,427.7031 L224,437.7031 L33,437.7031 L33,420.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1612" x="33" y="420.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="48" y="434.2715">Persist Position change</text><polygon fill="#A80036" points="929.5,470.6348,939.5,474.6348,929.5,478.6348,933.5,474.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="935.5" y1="474.6348" y2="474.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="462.2373">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="127.5" y="454.582">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="469.8926">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="469.8926">2003</text><path d="M888.5,489.6348 L1180.5,489.6348 L1180.5,496.6348 L1170.5,506.6348 L888.5,506.6348 L888.5,489.6348 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="746.5" x="888.5" y="489.6348"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="903.5" y="503.2031">DB TRANSACTION IMPLEMENTATION</text><polygon fill="#A80036" points="1379.5,524.2559,1389.5,528.2559,1379.5,532.2559,1383.5,528.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1385.5" y1="528.2559" y2="528.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="958.5" y="523.5137">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="971.5" y="523.5137">Select participantPosition.value FOR UPDATE for payerCurrencyId</text><polygon fill="#FFFFE0" filter="url(#f1r180sdc5o2s6)" points="1335,541.2559,1458,541.2559,1468,552.2559,1458,564.2559,1335,564.2559,1325,552.2559,1335,541.2559" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1337" y="557.8242">participantPosition</text><polygon fill="#A80036" points="962.5,586.877,952.5,590.877,962.5,594.877,958.5,590.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="956.5" x2="1395.5" y1="590.877" y2="590.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="968.5" y="586.1348">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="981.5" y="586.1348">Return participantPosition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="993.5" y1="620.1875" y2="620.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="993.5" x2="993.5" y1="620.1875" y2="633.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="952.5" x2="993.5" y1="633.1875" y2="633.1875"/><polygon fill="#A80036" points="962.5,629.1875,952.5,633.1875,962.5,637.1875,958.5,633.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="958.5" y="615.4453">9</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="971.5" y="615.4453">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1065.5" y="615.4453">= participantPosition - payload.amount.amount</text><polygon fill="#A80036" points="1379.5,658.498,1389.5,662.498,1379.5,666.498,1383.5,662.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1385.5" y1="662.498" y2="662.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="958.5" y="657.7559">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="980.5" y="657.7559">Persist latestPosition to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1r180sdc5o2s6)" points="1304,705.498,1489,705.498,1499,724.498,1489,743.498,1304,743.498,1294,724.498,1304,705.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1306" y="722.0664">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1360" y="722.0664">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1306" y="737.377">SET value = latestPosition</text><polygon fill="#A80036" points="1379.5,766.4297,1389.5,770.4297,1379.5,774.4297,1383.5,770.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1385.5" y1="770.4297" y2="770.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="958.5" y="765.6875">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="980.5" y="765.6875">Persist participant position change and state change</text><polygon fill="#FFFFE0" filter="url(#f1r180sdc5o2s6)" points="1178,813.4297,1615,813.4297,1625,878.4297,1615,943.4297,1178,943.4297,1168,878.4297,1178,813.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1180" y="829.998">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1228" y="829.998">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="1371" y="829.998">transferStateId = 'EXPIRED_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1184" y="845.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1180" y="860.6191">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1228" y="860.6191">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="1180" y="875.9297">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="1180" y="891.2402">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1180" y="906.5508">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1180" y="921.8613">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1180" y="937.1719">createdDate = new Date()</text><polygon fill="#A80036" points="118.5,973.2246,108.5,977.2246,118.5,981.2246,114.5,977.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="945.5" y1="977.2246" y2="977.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="972.4824">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="972.4824">Return success</text><path d="M112,997.2246 L112,1466.2246 L516,1466.2246 L516,1007.2246 L506,997.2246 L112,997.2246 " fill="#FFFF00" filter="url(#f1r180sdc5o2s6)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M506,997.2246 L506,1007.2246 L516,1007.2246 L506,997.2246 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="1014.793">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="1030.1035">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="1045.4141">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="1060.7246">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="1076.0352">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="1091.3457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="1106.6563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="1121.9668">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="1137.2773">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="1152.5879">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="186" y="1167.8984">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="1183.209">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="1198.5195">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1213.8301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="1229.1406">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="1244.4512">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="1259.7617">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="1275.0723">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="1290.3828">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="1305.6934">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="1321.0039">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="1336.3145">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="1351.625">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="1366.9355">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="1382.2461">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="1397.5566">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="1412.8672">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1428.1777">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="1443.4883">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="1458.7988">}</text><polygon fill="#A80036" points="798,1508.1621,808,1512.1621,798,1516.1621,802,1512.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="804" y1="1512.1621" y2="1512.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1499.7646">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="136.5" y="1492.1094">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1507.4199">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1507.4199">2003</text><path d="M23,1564.1621 L90,1564.1621 L90,1571.1621 L80,1581.1621 L23,1581.1621 L23,1564.1621 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="887.4219" style="stroke: #000000; stroke-width: 2.0;" width="1459" x="23" y="1564.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="1577.7305">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="105" y="1576.7969">[type == 'position' &amp;&amp; action == 'reject']</text><polygon fill="#A80036" points="929.5,1614.0938,939.5,1618.0938,929.5,1622.0938,933.5,1618.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="935.5" y1="1618.0938" y2="1618.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1605.6963">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="1598.041">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1613.3516">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1613.3516">2003</text><polygon fill="#A80036" points="1379.5,1643.4043,1389.5,1647.4043,1379.5,1651.4043,1383.5,1647.4043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1385.5" y1="1647.4043" y2="1647.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="958.5" y="1642.6621">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="980.5" y="1642.6621">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1r180sdc5o2s6)" points="1331,1660.4043,1462,1660.4043,1472,1671.4043,1462,1683.4043,1331,1683.4043,1321,1671.4043,1331,1660.4043" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1333" y="1676.9727">transferStateChange</text><polygon fill="#A80036" points="962.5,1706.0254,952.5,1710.0254,962.5,1714.0254,958.5,1710.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="956.5" x2="1395.5" y1="1710.0254" y2="1710.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="968.5" y="1705.2832">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="990.5" y="1705.2832">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,1735.3359,108.5,1739.3359,118.5,1743.3359,114.5,1739.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="945.5" y1="1739.3359" y2="1739.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1734.5938">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="1734.5938">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="1783.957" y2="1783.957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="1783.957" y2="1796.957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="1796.957" y2="1796.957"/><polygon fill="#A80036" points="118.5,1792.957,108.5,1796.957,118.5,1800.957,114.5,1796.957" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1771.5596">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="463" x="136.5" y="1763.9043">Validate current state (transferStateChange.transferStateId == 'REJECTED')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1779.2148">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1779.2148">2001</text><path d="M33,1811.957 L735,1811.957 L735,1818.957 L725,1828.957 L33,1828.957 L33,1811.957 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1431.5" x="33" y="1811.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="657" x="48" y="1825.5254">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="929.5,1861.8887,939.5,1865.8887,929.5,1869.8887,933.5,1865.8887" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="935.5" y1="1865.8887" y2="1865.8887"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1853.4912">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="1845.8359">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1861.1465">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1861.1465">2003</text><path d="M888.5,1880.8887 L1299.5,1880.8887 L1299.5,1887.8887 L1289.5,1897.8887 L888.5,1897.8887 L888.5,1880.8887 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="888.5" y="1880.8887"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="903.5" y="1894.457">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1379.5,1915.5098,1389.5,1919.5098,1379.5,1923.5098,1383.5,1919.5098" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1385.5" y1="1919.5098" y2="1919.5098"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="958.5" y="1914.7676">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="980.5" y="1914.7676">Refer to implementation above</text><polygon fill="#A80036" points="118.5,1981.8203,108.5,1985.8203,118.5,1989.8203,114.5,1985.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="945.5" y1="1985.8203" y2="1985.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1981.0781">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="1981.0781">Return success</text><path d="M112,2005.8203 L112,2367.8203 L374,2367.8203 L374,2015.8203 L364,2005.8203 L112,2005.8203 " fill="#FFFF00" filter="url(#f1r180sdc5o2s6)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M364,2005.8203 L364,2015.8203 L374,2015.8203 L364,2005.8203 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="2023.3887">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2038.6992">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2054.0098">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2069.3203">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2084.6309">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2099.9414">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2115.252">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="150" y="2130.5625">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2145.873">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2161.1836">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="2176.4941">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="2191.8047">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="2207.1152">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="2222.4258">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="2237.7363">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="2253.0469">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="2268.3574">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="182" y="2283.668">status: "rejected",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="182" y="2298.9785">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="2314.2891">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="2329.5996">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="2344.9102">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2360.2207">}</text><polygon fill="#A80036" points="651.5,2409.584,661.5,2413.584,651.5,2417.584,655.5,2413.584" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="657.5" y1="2413.584" y2="2413.584"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2401.1865">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="136.5" y="2393.5313">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2408.8418">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2408.8418">2003</text><path d="M23,2465.584 L90,2465.584 L90,2472.584 L80,2482.584 L23,2482.584 L23,2465.584 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="979.2852" style="stroke: #000000; stroke-width: 2.0;" width="1459" x="23" y="2465.584"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="2479.1523">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="455" x="105" y="2478.2188">[type == 'position' &amp;&amp; action == 'fail' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="929.5,2515.5156,939.5,2519.5156,929.5,2523.5156,933.5,2519.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="935.5" y1="2519.5156" y2="2519.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2507.1182">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="2499.4629">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2514.7734">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2514.7734">2003</text><polygon fill="#A80036" points="1379.5,2544.8262,1389.5,2548.8262,1379.5,2552.8262,1383.5,2548.8262" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1385.5" y1="2548.8262" y2="2548.8262"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="958.5" y="2544.084">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="980.5" y="2544.084">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1r180sdc5o2s6)" points="1331,2561.8262,1462,2561.8262,1472,2572.8262,1462,2584.8262,1331,2584.8262,1321,2572.8262,1331,2561.8262" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1333" y="2578.3945">transferStateChange</text><polygon fill="#A80036" points="962.5,2607.4473,952.5,2611.4473,962.5,2615.4473,958.5,2611.4473" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="956.5" x2="1395.5" y1="2611.4473" y2="2611.4473"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="968.5" y="2606.7051">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="990.5" y="2606.7051">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,2636.7578,108.5,2640.7578,118.5,2644.7578,114.5,2640.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="945.5" y1="2640.7578" y2="2640.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2636.0156">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="2636.0156">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="2670.0684" y2="2670.0684"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="2670.0684" y2="2683.0684"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="2683.0684" y2="2683.0684"/><polygon fill="#A80036" points="118.5,2679.0684,108.5,2683.0684,118.5,2687.0684,114.5,2683.0684" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2665.3262">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="136.5" y="2665.3262">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M33,2698.0684 L735,2698.0684 L735,2705.0684 L725,2715.0684 L33,2715.0684 L33,2698.0684 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1431.5" x="33" y="2698.0684"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="657" x="48" y="2711.6367">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="929.5,2748,939.5,2752,929.5,2756,933.5,2752" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="935.5" y1="2752" y2="2752"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2739.6025">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="2731.9473">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2747.2578">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2747.2578">2003</text><path d="M888.5,2767 L1299.5,2767 L1299.5,2774 L1289.5,2784 L888.5,2784 L888.5,2767 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="888.5" y="2767"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="903.5" y="2780.5684">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1379.5,2801.6211,1389.5,2805.6211,1379.5,2809.6211,1383.5,2805.6211" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="951.5" x2="1385.5" y1="2805.6211" y2="2805.6211"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="958.5" y="2800.8789">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="980.5" y="2800.8789">Refer to implementation above</text><polygon fill="#A80036" points="118.5,2867.9316,108.5,2871.9316,118.5,2875.9316,114.5,2871.9316" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="945.5" y1="2871.9316" y2="2871.9316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2867.1895">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="2867.1895">Return success</text><path d="M112,2891.9316 L112,3360.9316 L516,3360.9316 L516,2901.9316 L506,2891.9316 L112,2891.9316 " fill="#FFFF00" filter="url(#f1r180sdc5o2s6)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M506,2891.9316 L506,2901.9316 L516,2901.9316 L506,2891.9316 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="2909.5">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2924.8105">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2940.1211">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2955.4316">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2970.7422">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2986.0527">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="3001.3633">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="3016.6738">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="3031.9844">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="3047.2949">"errorCode": 3100,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="186" y="3062.6055">"errorDescription": "Transfer failed",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="3077.916">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="3093.2266">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="154" y="3108.5371">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="3123.8477">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="3139.1582">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="3154.4688">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="3169.7793">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="3185.0898">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="3200.4004">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="3215.7109">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="3231.0215">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="3246.332">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="3261.6426">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="3276.9531">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="3292.2637">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3307.5742">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3322.8848">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="3338.1953">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="3353.5059">}</text><polygon fill="#A80036" points="651.5,3402.8691,661.5,3406.8691,651.5,3410.8691,655.5,3406.8691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="657.5" y1="3406.8691" y2="3406.8691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3394.4717">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="136.5" y="3386.8164">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3402.127">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3402.127">2003</text><!--
@startuml
title 1.3.3. Abort Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type == 'position' && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
            transferParticipant
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'RESERVED_TIMEOUT')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION IMPLEMENTATION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE for payerCurrencyId
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payer
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist participant position change and state change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** transferStateId = 'EXPIRED_RESERVED'

                        INSERT **participantPositionChange**
                        SET participantPositionId = participantPosition.participantPositionId,
                        transferStateChangeId = transferStateChange.transferStateChangeId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3303,
                             "errorDescription": "Transfer expired",
                             "extensionList": <transferMessage.extensionList>
                         }
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
    opt type == 'position' && action == 'reject'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'REJECTED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: "rejected",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    end
    opt type == 'position' && action == 'fail' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3100,
                             "errorDescription": "Transfer failed",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3560px" preserveAspectRatio="none" style="width:1646px;height:3560px;" version="1.1" viewBox="0 0 1646 3560" width="1646px" zoomAndPan="magnify"><defs><filter height="300%" id="f10c0fc7htuh97" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="279" x="684.5" y="23.5352">1.3.3. Abort Position Handler Consume</text><rect fill="#FFFFE0" height="3515.1797" style="stroke: #A80036; stroke-width: 1.0;" width="1380" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="678.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="3347.8926" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="1512.1621"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="2428.8945"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="3422.1797"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="211.5293"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="502.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="474.6348"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="1618.0938"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="1881.1992"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="2534.8262"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="2767.3105"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="240.8398"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="528.2559"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="662.498"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="770.4297"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1647.4043"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1934.8203"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2564.1367"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2820.9316"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="3333.8926" style="stroke: #000000; stroke-width: 2.0;" width="1622" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="1392.5645" style="stroke: #000000; stroke-width: 2.0;" width="1602" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1582" x="33" y="420.7031"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="746" x="859" y="489.6348"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="902.7324" style="stroke: #000000; stroke-width: 2.0;" width="1429" x="23" y="1564.1621"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="197.1738" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="33" y="1811.957"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="859" y="1896.1992"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="979.2852" style="stroke: #000000; stroke-width: 2.0;" width="1429" x="23" y="2480.8945"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="33" y="2713.3789"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="859" y="2782.3105"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="116.2871" y2="3484.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="785" x2="785" y1="116.2871" y2="3484.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="917" x2="917" y1="116.2871" y2="3484.1797"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1367" x2="1367" y1="116.2871" y2="3484.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="113.334">Position Handler</text><ellipse cx="102.5" cy="83.7988" fill="#FEFECE" filter="url(#f10c0fc7htuh97)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,71.7988,104.5,66.7988,102.5,71.7988,104.5,76.7988,98.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="3496.7148">Position Handler</text><ellipse cx="102.5" cy="3515.668" fill="#FEFECE" filter="url(#f10c0fc7htuh97)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,3503.668,104.5,3498.668,102.5,3503.668,104.5,3508.668,98.5,3503.668" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f10c0fc7htuh97)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="716" y="76.7988"/><rect fill="#FEFECE" filter="url(#f10c0fc7htuh97)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="712" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="719" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f10c0fc7htuh97)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="716" y="3483.1797"/><rect fill="#FEFECE" filter="url(#f10c0fc7htuh97)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="712" y="3487.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="719" y="3507.7148">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="869" y="113.334">Position DAO</text><ellipse cx="917" cy="83.7988" fill="#FEFECE" filter="url(#f10c0fc7htuh97)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="905" x2="929" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="869" y="3496.7148">Position DAO</text><ellipse cx="917" cy="3515.668" fill="#FEFECE" filter="url(#f10c0fc7htuh97)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="905" x2="929" y1="3529.668" y2="3529.668"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1319" y="113.334">Central Store</text><path d="M1349,63.7988 C1349,53.7988 1367,53.7988 1367,53.7988 C1367,53.7988 1385,53.7988 1385,63.7988 L1385,89.7988 C1385,99.7988 1367,99.7988 1367,99.7988 C1367,99.7988 1349,99.7988 1349,89.7988 L1349,63.7988 " fill="#FEFECE" filter="url(#f10c0fc7htuh97)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1349,63.7988 C1349,73.7988 1367,73.7988 1367,73.7988 C1367,73.7988 1385,73.7988 1385,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1319" y="3496.7148">Central Store</text><path d="M1349,3509.668 C1349,3499.668 1367,3499.668 1367,3499.668 C1367,3499.668 1385,3499.668 1385,3509.668 L1385,3535.668 C1385,3545.668 1367,3545.668 1367,3545.668 C1367,3545.668 1349,3545.668 1349,3535.668 L1349,3509.668 " fill="#FEFECE" filter="url(#f10c0fc7htuh97)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1349,3509.668 C1349,3519.668 1367,3519.668 1367,3519.668 C1367,3519.668 1385,3519.668 1385,3509.668 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="3347.8926" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="1512.1621"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="2428.8945"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="780.5" y="3422.1797"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="211.5293"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="502.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="474.6348"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="1618.0938"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="1881.1992"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="2534.8262"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="119.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="912" y="2767.3105"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="240.8398"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="528.2559"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="662.498"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="770.4297"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1647.4043"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="1934.8203"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2564.1367"/><rect fill="#FFFFFF" filter="url(#f10c0fc7htuh97)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1362" y="2820.9316"/><path d="M13,133.2871 L278,133.2871 L278,140.2871 L268,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3333.8926" style="stroke: #000000; stroke-width: 2.0;" width="1622" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="220" x="28" y="146.8555">Abort Position Handler Consume</text><path d="M23,157.5977 L90,157.5977 L90,164.5977 L80,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1392.5645" style="stroke: #000000; stroke-width: 2.0;" width="1602" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="171.166">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="105" y="170.2324">[type == 'position' &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="900,207.5293,910,211.5293,900,215.5293,904,211.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="211.5293" y2="211.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="199.1318">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="127.5" y="191.4766">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="206.7871">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="206.7871">2003</text><polygon fill="#A80036" points="1350,236.8398,1360,240.8398,1350,244.8398,1354,240.8398" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="240.8398" y2="240.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="929" y="236.0977">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="942" y="236.0977">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f10c0fc7htuh97)" points="1301,253.8398,1432,253.8398,1442,272.8398,1432,291.8398,1301,291.8398,1291,272.8398,1301,253.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1303" y="270.4082">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1303" y="285.7188">transferParticipant</text><polygon fill="#A80036" points="933,314.7715,923,318.7715,933,322.7715,929,318.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="927" x2="1366" y1="318.7715" y2="318.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="939" y="314.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="952" y="314.0293">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,344.082,108.5,348.082,118.5,352.082,114.5,348.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="348.082" y2="348.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="124.5" y="343.3398">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="137.5" y="343.3398">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="392.7031" y2="392.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="392.7031" y2="405.7031"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="405.7031" y2="405.7031"/><polygon fill="#A80036" points="118.5,401.7031,108.5,405.7031,118.5,409.7031,114.5,405.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="380.3057">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="529" x="127.5" y="372.6504">Validate current state (transferStateChange.transferStateId == 'RESERVED_TIMEOUT')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="387.9609">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="387.9609">2001</text><path d="M33,420.7031 L234,420.7031 L234,427.7031 L224,437.7031 L33,437.7031 L33,420.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1582" x="33" y="420.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="48" y="434.2715">Persist Position change</text><polygon fill="#A80036" points="900,470.6348,910,474.6348,900,478.6348,904,474.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="474.6348" y2="474.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="462.2373">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="127.5" y="454.582">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="469.8926">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="469.8926">2003</text><path d="M859,489.6348 L1151,489.6348 L1151,496.6348 L1141,506.6348 L859,506.6348 L859,489.6348 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="746" x="859" y="489.6348"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="874" y="503.2031">DB TRANSACTION IMPLEMENTATION</text><polygon fill="#A80036" points="1350,524.2559,1360,528.2559,1350,532.2559,1354,528.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="528.2559" y2="528.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="929" y="523.5137">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="942" y="523.5137">Select participantPosition.value FOR UPDATE for payerCurrencyId</text><polygon fill="#FFFFE0" filter="url(#f10c0fc7htuh97)" points="1305,541.2559,1428,541.2559,1438,552.2559,1428,564.2559,1305,564.2559,1295,552.2559,1305,541.2559" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1307" y="557.8242">participantPosition</text><polygon fill="#A80036" points="933,586.877,923,590.877,933,594.877,929,590.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="927" x2="1366" y1="590.877" y2="590.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="939" y="586.1348">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="952" y="586.1348">Return participantPosition</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="964" y1="620.1875" y2="620.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="964" x2="964" y1="620.1875" y2="633.1875"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="923" x2="964" y1="633.1875" y2="633.1875"/><polygon fill="#A80036" points="933,629.1875,923,633.1875,933,637.1875,929,633.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="929" y="615.4453">9</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="942" y="615.4453">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="1036" y="615.4453">= participantPosition - payload.amount.amount</text><polygon fill="#A80036" points="1350,658.498,1360,662.498,1350,666.498,1354,662.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="662.498" y2="662.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="657.7559">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="951" y="657.7559">Persist latestPosition to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f10c0fc7htuh97)" points="1274,705.498,1459,705.498,1469,724.498,1459,743.498,1274,743.498,1264,724.498,1274,705.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1276" y="722.0664">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1330" y="722.0664">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1276" y="737.377">SET value = latestPosition</text><polygon fill="#A80036" points="1350,766.4297,1360,770.4297,1350,774.4297,1354,770.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="770.4297" y2="770.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="765.6875">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="951" y="765.6875">Persist participant position change and state change</text><polygon fill="#FFFFE0" filter="url(#f10c0fc7htuh97)" points="1148,813.4297,1585,813.4297,1595,878.4297,1585,943.4297,1148,943.4297,1138,878.4297,1148,813.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1150" y="829.998">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1198" y="829.998">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="1341" y="829.998">transferStateId = 'EXPIRED_RESERVED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1154" y="845.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1150" y="860.6191">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1198" y="860.6191">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="1150" y="875.9297">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="1150" y="891.2402">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1150" y="906.5508">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1150" y="921.8613">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1150" y="937.1719">createdDate = new Date()</text><polygon fill="#A80036" points="118.5,973.2246,108.5,977.2246,118.5,981.2246,114.5,977.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="977.2246" y2="977.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="972.4824">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="972.4824">Return success</text><path d="M112,997.2246 L112,1466.2246 L516,1466.2246 L516,1007.2246 L506,997.2246 L112,997.2246 " fill="#FFFF00" filter="url(#f10c0fc7htuh97)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M506,997.2246 L506,1007.2246 L516,1007.2246 L506,997.2246 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="1014.793">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="1030.1035">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="1045.4141">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="1060.7246">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="1076.0352">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="1091.3457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="1106.6563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="1121.9668">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="1137.2773">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="1152.5879">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="186" y="1167.8984">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="1183.209">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="1198.5195">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1213.8301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="1229.1406">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="1244.4512">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="1259.7617">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="1275.0723">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="1290.3828">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="1305.6934">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="1321.0039">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="1336.3145">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="1351.625">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="1366.9355">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="1382.2461">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="1397.5566">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="1412.8672">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1428.1777">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="1443.4883">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="1458.7988">}</text><polygon fill="#A80036" points="768.5,1508.1621,778.5,1512.1621,768.5,1516.1621,772.5,1512.1621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="774.5" y1="1512.1621" y2="1512.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1499.7646">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="136.5" y="1492.1094">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1507.4199">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1507.4199">2003</text><path d="M23,1564.1621 L90,1564.1621 L90,1571.1621 L80,1581.1621 L23,1581.1621 L23,1564.1621 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="902.7324" style="stroke: #000000; stroke-width: 2.0;" width="1429" x="23" y="1564.1621"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="1577.7305">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="105" y="1576.7969">[type == 'position' &amp;&amp; (action IN ['reject', 'abort'])]</text><polygon fill="#A80036" points="900,1614.0938,910,1618.0938,900,1622.0938,904,1618.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="1618.0938" y2="1618.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1605.6963">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="1598.041">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1613.3516">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1613.3516">2003</text><polygon fill="#A80036" points="1350,1643.4043,1360,1647.4043,1350,1651.4043,1354,1647.4043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="1647.4043" y2="1647.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="1642.6621">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="951" y="1642.6621">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f10c0fc7htuh97)" points="1301,1660.4043,1432,1660.4043,1442,1671.4043,1432,1683.4043,1301,1683.4043,1291,1671.4043,1301,1660.4043" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1303" y="1676.9727">transferStateChange</text><polygon fill="#A80036" points="933,1706.0254,923,1710.0254,933,1714.0254,929,1710.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="927" x2="1366" y1="1710.0254" y2="1710.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="939" y="1705.2832">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="961" y="1705.2832">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,1735.3359,108.5,1739.3359,118.5,1743.3359,114.5,1739.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="1739.3359" y2="1739.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1734.5938">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="1734.5938">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="1783.957" y2="1783.957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="1783.957" y2="1796.957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="1796.957" y2="1796.957"/><polygon fill="#A80036" points="118.5,1792.957,108.5,1796.957,118.5,1800.957,114.5,1796.957" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1771.5596">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="637" x="136.5" y="1763.9043">Validate current state (transferStateChange.transferStateId IN ['RECEIVED_REJECT', 'RECEIVED_ERROR'])</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1779.2148">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1779.2148">2001</text><path d="M33,1811.957 L363,1811.957 L363,1818.957 L353,1828.957 L33,1828.957 L33,1811.957 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="197.1738" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="33" y="1811.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="285" x="48" y="1825.5254">Persist Position change and Transfer State</text><polygon fill="#A80036" points="900,1877.1992,910,1881.1992,900,1885.1992,904,1881.1992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="1881.1992" y2="1881.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1861.1465">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="1845.8359">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1861.1465">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1861.1465">2003</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="249.5" y="1861.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="622" x="136.5" y="1876.457">transferState=(action=='reject' ? 'ABORTED_REJECTED' : 'ABORTED_ERROR' ) on position check pass</text><path d="M859,1896.1992 L1270,1896.1992 L1270,1903.1992 L1260,1913.1992 L859,1913.1992 L859,1896.1992 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="859" y="1896.1992"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="874" y="1909.7676">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1350,1930.8203,1360,1934.8203,1350,1938.8203,1354,1934.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="1934.8203" y2="1934.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="1930.0781">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="951" y="1930.0781">Refer to implementation above</text><polygon fill="#A80036" points="118.5,1997.1309,108.5,2001.1309,118.5,2005.1309,114.5,2001.1309" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="2001.1309" y2="2001.1309"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1996.3887">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="1996.3887">Return success</text><path d="M112,2021.1309 L112,2383.1309 L374,2383.1309 L374,2031.1309 L364,2021.1309 L112,2021.1309 " fill="#FFFF00" filter="url(#f10c0fc7htuh97)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M364,2021.1309 L364,2031.1309 L374,2031.1309 L364,2021.1309 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="2038.6992">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2054.0098">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2069.3203">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2084.6309">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2099.9414">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2115.252">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2130.5625">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="150" y="2145.873">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2161.1836">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2176.4941">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="2191.8047">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="2207.1152">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="2222.4258">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="2237.7363">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="2253.0469">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="2268.3574">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="2283.668">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="182" y="2298.9785">status: "aborted",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="182" y="2314.2891">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="2329.5996">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="2344.9102">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="2360.2207">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2375.5313">}</text><polygon fill="#A80036" points="768.5,2424.8945,778.5,2428.8945,768.5,2432.8945,772.5,2428.8945" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="774.5" y1="2428.8945" y2="2428.8945"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2416.4971">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="136.5" y="2408.8418">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2424.1523">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2424.1523">2003</text><path d="M23,2480.8945 L90,2480.8945 L90,2487.8945 L80,2497.8945 L23,2497.8945 L23,2480.8945 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="979.2852" style="stroke: #000000; stroke-width: 2.0;" width="1429" x="23" y="2480.8945"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="2494.4629">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="455" x="105" y="2493.5293">[type == 'position' &amp;&amp; action == 'fail' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="900,2530.8262,910,2534.8262,900,2538.8262,904,2534.8262" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="2534.8262" y2="2534.8262"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2522.4287">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="2514.7734">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2530.084">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2530.084">2003</text><polygon fill="#A80036" points="1350,2560.1367,1360,2564.1367,1350,2568.1367,1354,2564.1367" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="2564.1367" y2="2564.1367"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="2559.3945">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="951" y="2559.3945">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f10c0fc7htuh97)" points="1301,2577.1367,1432,2577.1367,1442,2588.1367,1432,2600.1367,1301,2600.1367,1291,2588.1367,1301,2577.1367" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1303" y="2593.7051">transferStateChange</text><polygon fill="#A80036" points="933,2622.7578,923,2626.7578,933,2630.7578,929,2626.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="927" x2="1366" y1="2626.7578" y2="2626.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="939" y="2622.0156">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="961" y="2622.0156">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,2652.0684,108.5,2656.0684,118.5,2660.0684,114.5,2656.0684" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="2656.0684" y2="2656.0684"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2651.3262">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="2651.3262">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="2685.3789" y2="2685.3789"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="2685.3789" y2="2698.3789"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="2698.3789" y2="2698.3789"/><polygon fill="#A80036" points="118.5,2694.3789,108.5,2698.3789,118.5,2702.3789,114.5,2698.3789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2680.6367">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="136.5" y="2680.6367">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M33,2713.3789 L735,2713.3789 L735,2720.3789 L725,2730.3789 L33,2730.3789 L33,2713.3789 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1402" x="33" y="2713.3789"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="657" x="48" y="2726.9473">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="900,2763.3105,910,2767.3105,900,2771.3105,904,2767.3105" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="906" y1="2767.3105" y2="2767.3105"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2754.9131">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="2747.2578">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2762.5684">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2762.5684">2003</text><path d="M859,2782.3105 L1270,2782.3105 L1270,2789.3105 L1260,2799.3105 L859,2799.3105 L859,2782.3105 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="566" x="859" y="2782.3105"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="874" y="2795.8789">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1350,2816.9316,1360,2820.9316,1350,2824.9316,1354,2820.9316" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="922" x2="1356" y1="2820.9316" y2="2820.9316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="929" y="2816.1895">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="951" y="2816.1895">Refer to implementation above</text><polygon fill="#A80036" points="118.5,2883.2422,108.5,2887.2422,118.5,2891.2422,114.5,2887.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="916" y1="2887.2422" y2="2887.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2882.5">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="2882.5">Return success</text><path d="M112,2907.2422 L112,3376.2422 L516,3376.2422 L516,2917.2422 L506,2907.2422 L112,2907.2422 " fill="#FFFF00" filter="url(#f10c0fc7htuh97)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M506,2907.2422 L506,2917.2422 L516,2917.2422 L506,2907.2422 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="2924.8105">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2940.1211">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2955.4316">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2970.7422">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2986.0527">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="3001.3633">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="3016.6738">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="3031.9844">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="3047.2949">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="3062.6055">"errorCode": 3100,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="186" y="3077.916">"errorDescription": "Transfer failed",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="3093.2266">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="3108.5371">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="154" y="3123.8477">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="3139.1582">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="3154.4688">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="3169.7793">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="3185.0898">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="3200.4004">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="3215.7109">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="3231.0215">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="3246.332">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="3261.6426">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="3276.9531">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="3292.2637">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="3307.5742">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3322.8848">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3338.1953">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="3353.5059">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="3368.8164">}</text><polygon fill="#A80036" points="768.5,3418.1797,778.5,3422.1797,768.5,3426.1797,772.5,3422.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="774.5" y1="3422.1797" y2="3422.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3409.7822">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="136.5" y="3402.127">Publish Notification event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3417.4375">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3417.4375">2003</text><!--
@startuml
title 1.3.3. Abort Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type == 'position' && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
            transferParticipant
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'RESERVED_TIMEOUT')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION IMPLEMENTATION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE for payerCurrencyId
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payer
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist participant position change and state change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** transferStateId = 'EXPIRED_RESERVED'

                        INSERT **participantPositionChange**
                        SET participantPositionId = participantPosition.participantPositionId,
                        transferStateChangeId = transferStateChange.transferStateChangeId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3303,
                             "errorDescription": "Transfer expired",
                             "extensionList": <transferMessage.extensionList>
                         }
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
    opt type == 'position' && (action IN ['reject', 'abort'])
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId IN ['RECEIVED_REJECT', 'RECEIVED_ERROR'])\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer State
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color> \ntransferState=(action=='reject' ? 'ABORTED_REJECTED' : 'ABORTED_ERROR' ) on position check pass
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: "aborted",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
    opt type == 'position' && action == 'fail' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3100,
                             "errorDescription": "Transfer failed",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.12(Sun Oct 21 15:45:15 IST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_151-b12
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1760px" preserveAspectRatio="none" style="width:1430px;height:1760px;" version="1.1" viewBox="0 0 1430 1760" width="1430px" zoomAndPan="magnify"><defs><filter height="300%" id="frfja3clx9w49" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="293" x="569.5" y="23.5352">2.2.2. Position Handler Consume (Reject)</text><rect fill="#FFFFE0" height="1714.9434" style="stroke: #A80036; stroke-width: 1.0;" width="1336.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="646.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="119" y="196.2188"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="1547.6563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="476.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972.5" y="1567.6777"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1107.5" y="491.0137"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1107.5" y="835.4297"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1107.5" y="1017.9824"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="520.3242"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="864.7402"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="1047.293"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="1533.6563" style="stroke: #000000; stroke-width: 2.0;" width="1406" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="1502.3457" style="stroke: #000000; stroke-width: 2.0;" width="1386" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="533" x="381.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="513" x="391.5" y="265.5293"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="215" y="346.1504"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="983.5" x="391.5" y="452.3926"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="133.2422" style="stroke: #000000; stroke-width: 2.0;" width="606" x="381.5" y="649.5664"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="101.9316" style="stroke: #000000; stroke-width: 2.0;" width="586" x="391.5" y="673.877"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="993.5" x="391.5" y="796.8086"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1007.5" x="391.5" y="979.3613"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1386" x="23" y="1605.6777"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="124" x2="124" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="277" x2="277" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="481.5" x2="481.5" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="977.5" x2="977.5" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1112.5" x2="1112.5" y1="116.2871" y2="1683.9434"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1313.5" x2="1313.5" y1="116.2871" y2="1683.9434"/><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="40" y="101.334">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="37" y="1682.9434"/><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="174" x="33" y="1686.9434"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="160" x="40" y="1707.4785">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="229" y="76.7988"/><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="225" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="232" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="229" y="1682.9434"/><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="225" y="1686.9434"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="232" y="1707.4785">Event-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="401.5" y="113.334">Position Event Handler</text><ellipse cx="481.5" cy="83.7988" fill="#FEFECE" filter="url(#frfja3clx9w49)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="477.5,71.7988,483.5,66.7988,481.5,71.7988,483.5,76.7988,477.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="401.5" y="1696.4785">Position Event Handler</text><ellipse cx="481.5" cy="1715.4316" fill="#FEFECE" filter="url(#frfja3clx9w49)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="477.5,1703.4316,483.5,1698.4316,481.5,1703.4316,483.5,1708.4316,477.5,1703.4316" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="146" x="904.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="146" x="900.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="132" x="907.5" y="101.334">Notifications-Topic</text><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="146" x="904.5" y="1682.9434"/><rect fill="#FEFECE" filter="url(#frfja3clx9w49)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="146" x="900.5" y="1686.9434"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="132" x="907.5" y="1707.4785">Notifications-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1064.5" y="113.334">Position DAO</text><ellipse cx="1112.5" cy="83.7988" fill="#FEFECE" filter="url(#frfja3clx9w49)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1100.5" x2="1124.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1064.5" y="1696.4785">Position DAO</text><ellipse cx="1112.5" cy="1715.4316" fill="#FEFECE" filter="url(#frfja3clx9w49)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1100.5" x2="1124.5" y1="1729.4316" y2="1729.4316"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1265.5" y="113.334">Central Store</text><path d="M1295.5,63.7988 C1295.5,53.7988 1313.5,53.7988 1313.5,53.7988 C1313.5,53.7988 1331.5,53.7988 1331.5,63.7988 L1331.5,89.7988 C1331.5,99.7988 1313.5,99.7988 1313.5,99.7988 C1313.5,99.7988 1295.5,99.7988 1295.5,89.7988 L1295.5,63.7988 " fill="#FEFECE" filter="url(#frfja3clx9w49)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1295.5,63.7988 C1295.5,73.7988 1313.5,73.7988 1313.5,73.7988 C1313.5,73.7988 1331.5,73.7988 1331.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1265.5" y="1696.4785">Central Store</text><path d="M1295.5,1709.4316 C1295.5,1699.4316 1313.5,1699.4316 1313.5,1699.4316 C1313.5,1699.4316 1331.5,1699.4316 1331.5,1709.4316 L1331.5,1735.4316 C1331.5,1745.4316 1313.5,1745.4316 1313.5,1745.4316 C1313.5,1745.4316 1295.5,1745.4316 1295.5,1735.4316 L1295.5,1709.4316 " fill="#FEFECE" filter="url(#frfja3clx9w49)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1295.5,1709.4316 C1295.5,1719.4316 1313.5,1719.4316 1313.5,1719.4316 C1313.5,1719.4316 1331.5,1719.4316 1331.5,1709.4316 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="119" y="196.2188"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="1547.6563" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="476.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="972.5" y="1567.6777"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1107.5" y="491.0137"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1107.5" y="835.4297"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1107.5" y="1017.9824"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="520.3242"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="864.7402"/><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="1047.293"/><path d="M13,133.2871 L291,133.2871 L291,140.2871 L281,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1533.6563" style="stroke: #000000; stroke-width: 2.0;" width="1406" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="233" x="28" y="146.8555">Position Handler Consume (Reject)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1502.3457" style="stroke: #000000; stroke-width: 2.0;" width="1386" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="140,192.2188,130,196.2188,140,200.2188,136,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="134" x2="475.5" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="146" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="159" y="191.4766">Consume Position event message for Payer</text><path d="M381.5,241.2188 L465.5,241.2188 L465.5,248.2188 L455.5,258.2188 L381.5,258.2188 L381.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.9316" style="stroke: #000000; stroke-width: 2.0;" width="533" x="381.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="396.5" y="254.7871">break</text><path d="M391.5,265.5293 L533.5,265.5293 L533.5,272.5293 L523.5,282.5293 L391.5,282.5293 L391.5,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="513" x="391.5" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="406.5" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="528.5" y1="304.1504" y2="304.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="528.5" x2="528.5" y1="304.1504" y2="317.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="487.5" x2="528.5" y1="317.1504" y2="317.1504"/><polygon fill="#A80036" points="497.5,313.1504,487.5,317.1504,497.5,321.1504,493.5,317.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="493.5" y="299.4082">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="506.5" y="299.4082">Validate event - Rule: type == 'position' &amp;&amp; action == 'reject'</text><path d="M215,346.1504 L430,346.1504 L430,353.1504 L420,363.1504 L215,363.1504 L215,346.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="215" y="346.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="230" y="359.7188">Persist Event Information</text><polygon fill="#A80036" points="288.5,380.7715,278.5,384.7715,288.5,388.7715,284.5,384.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="282.5" x2="475.5" y1="384.7715" y2="384.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="294.5" y="380.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="307.5" y="380.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#frfja3clx9w49)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="338.5" x="222" y="392.7715"/><polygon fill="#EEEEEE" points="222,392.7715,286,392.7715,286,399.7715,276,409.7715,222,409.7715,222,392.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="235" y="407.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="294.25" y="426.3398">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/master/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/master/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="36" x="452.25" y="426.3398">9.1.0.</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="452.25" x2="488.25" y1="428.3398" y2="428.3398"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="488.25" y="426.3398">}</text><path d="M391.5,452.3926 L660.5,452.3926 L660.5,459.3926 L650.5,469.3926 L391.5,469.3926 L391.5,452.3926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.1738" style="stroke: #000000; stroke-width: 2.0;" width="983.5" x="391.5" y="452.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="406.5" y="465.9609">Retrieve Current Transfer Details</text><polygon fill="#A80036" points="1095.5,487.0137,1105.5,491.0137,1095.5,495.0137,1099.5,491.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="1101.5" y1="491.0137" y2="491.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="493.5" y="486.2715">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="506.5" y="486.2715">Request to retrieve expirationDate &amp; transferStateId</text><polygon fill="#A80036" points="1296.5,516.3242,1306.5,520.3242,1296.5,524.3242,1300.5,520.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1117.5" x2="1302.5" y1="520.3242" y2="520.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1124.5" y="515.582">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1137.5" y="515.582">Fetch from database</text><polygon fill="#A80036" points="1128.5,545.6348,1118.5,549.6348,1128.5,553.6348,1124.5,549.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1122.5" x2="1312.5" y1="549.6348" y2="549.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1134.5" y="544.8926">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1151.5" y="544.8926"/><polygon fill="#FFFFE0" filter="url(#frfja3clx9w49)" points="1271,562.6348,1355,562.6348,1365,581.6348,1355,600.6348,1271,600.6348,1261,581.6348,1271,562.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1273" y="579.2031">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="1273" y="594.5137">transferState</text><polygon fill="#A80036" points="497.5,623.5664,487.5,627.5664,497.5,631.5664,493.5,627.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="491.5" x2="1111.5" y1="627.5664" y2="627.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="503.5" y="622.8242">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="516.5" y="622.8242">Return transfer.expirationDate &amp; transferState.transferStateId</text><path d="M381.5,649.5664 L465.5,649.5664 L465.5,656.5664 L455.5,666.5664 L381.5,666.5664 L381.5,649.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="133.2422" style="stroke: #000000; stroke-width: 2.0;" width="606" x="381.5" y="649.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="396.5" y="663.1348">break</text><path d="M391.5,673.877 L553.5,673.877 L553.5,680.877 L543.5,690.877 L391.5,690.877 L391.5,673.877 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="101.9316" style="stroke: #000000; stroke-width: 2.0;" width="586" x="391.5" y="673.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="406.5" y="687.4453">Validate Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="528.5" y1="712.498" y2="712.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="528.5" x2="528.5" y1="712.498" y2="725.498"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="487.5" x2="528.5" y1="725.498" y2="725.498"/><polygon fill="#A80036" points="497.5,721.498,487.5,725.498,497.5,729.498,493.5,725.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="493.5" y="707.7559">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="400" x="506.5" y="707.7559">Validate transfer expiration - Rule: Date.now() &lt; expirationDate</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="528.5" y1="754.8086" y2="754.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="528.5" x2="528.5" y1="754.8086" y2="767.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="487.5" x2="528.5" y1="767.8086" y2="767.8086"/><polygon fill="#A80036" points="497.5,763.8086,487.5,767.8086,497.5,771.8086,493.5,767.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="493.5" y="750.0664">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="506.5" y="750.0664">Validate transfer state - Rule:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="695.5" y="750.0664">transferState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="782.5" y="750.0664">Id corresponds to 'RESERVED'</text><path d="M391.5,796.8086 L664.5,796.8086 L664.5,803.8086 L654.5,813.8086 L391.5,813.8086 L391.5,796.8086 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="993.5" x="391.5" y="796.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="228" x="406.5" y="810.377">Decrement Payer Position (DFSP1)</text><polygon fill="#A80036" points="1095.5,831.4297,1105.5,835.4297,1095.5,839.4297,1099.5,835.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="1101.5" y1="835.4297" y2="835.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="493.5" y="830.6875">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="515.5" y="830.6875">Request to decrement latest position for Payer</text><polygon fill="#A80036" points="1296.5,860.7402,1306.5,864.7402,1296.5,868.7402,1300.5,864.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1117.5" x2="1302.5" y1="864.7402" y2="864.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1124.5" y="859.998">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="1146.5" y="859.998">Persist decrement to DB</text><polygon fill="#FFFFE0" filter="url(#frfja3clx9w49)" points="1261,907.7402,1365,907.7402,1375,918.7402,1365,930.7402,1261,930.7402,1251,918.7402,1261,907.7402" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1263" y="924.3086">transferPosition</text><polygon fill="#A80036" points="497.5,953.3613,487.5,957.3613,497.5,961.3613,493.5,957.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="491.5" x2="1111.5" y1="957.3613" y2="957.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="503.5" y="952.6191">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="525.5" y="952.6191">Return success</text><path d="M391.5,979.3613 L795.5,979.3613 L795.5,986.3613 L785.5,996.3613 L391.5,996.3613 L391.5,979.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1007.5" x="391.5" y="979.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="359" x="406.5" y="992.9297">Persist Transfer State (with transferState='ABORTED')</text><polygon fill="#A80036" points="1095.5,1013.9824,1105.5,1017.9824,1095.5,1021.9824,1099.5,1017.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="1101.5" y1="1017.9824" y2="1017.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="493.5" y="1013.2402">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="515.5" y="1013.2402">Request to persist transfer state</text><polygon fill="#A80036" points="1296.5,1043.293,1306.5,1047.293,1296.5,1051.293,1300.5,1047.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1117.5" x2="1302.5" y1="1047.293" y2="1047.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1124.5" y="1042.5508">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1146.5" y="1042.5508">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#frfja3clx9w49)" points="1248,1090.293,1379,1090.293,1389,1101.293,1379,1113.293,1248,1113.293,1238,1101.293,1248,1090.293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1250" y="1106.8613">transferStateChange</text><polygon fill="#A80036" points="497.5,1135.9141,487.5,1139.9141,497.5,1143.9141,493.5,1139.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="491.5" x2="1111.5" y1="1139.9141" y2="1139.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="503.5" y="1135.1719">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="525.5" y="1135.1719">Return success</text><path d="M491,1159.9141 L491,1536.9141 L800,1536.9141 L800,1169.9141 L790,1159.9141 L491,1159.9141 " fill="#FFFF00" filter="url(#frfja3clx9w49)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M790,1159.9141 L790,1169.9141 L800,1169.9141 L790,1159.9141 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="497" y="1177.4824">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="497" y="1192.793">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="513" y="1208.1035">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="513" y="1223.4141">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="513" y="1238.7246">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="513" y="1254.0352">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="513" y="1269.3457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="529" y="1284.6563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="529" y="1299.9668">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="513" y="1315.2773">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="513" y="1330.5879">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="529" y="1345.8984">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="545" y="1361.209">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="545" y="1376.5195">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="545" y="1391.8301">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="86" x="545" y="1407.1406">action: reject,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="545" y="1422.4512">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="545" y="1437.7617">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="561" y="1453.0723">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="561" y="1468.3828">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="545" y="1483.6934">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="529" y="1499.0039">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="513" y="1514.3145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="497" y="1529.625">}</text><polygon fill="#A80036" points="960.5,1563.6777,970.5,1567.6777,960.5,1571.6777,964.5,1567.6777" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="486.5" x2="966.5" y1="1567.6777" y2="1567.6777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="493.5" y="1562.9355">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="515.5" y="1562.9355">Publish Notification event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1409" y1="1606.6777" y2="1606.6777"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="1617.3125">[Consume Batch Messages]</text><path d="M253,1625.6328 L253,1650.6328 L467,1650.6328 L467,1635.6328 L457,1625.6328 L253,1625.6328 " fill="#ADD8E6" filter="url(#frfja3clx9w49)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M457,1625.6328 L457,1635.6328 L467,1635.6328 L457,1625.6328 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="259" y="1643.2012">To be delivered by future story</text><!--
@startuml
title 2.2.2. Position Handler Consume (Reject)

autonumber


collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
control "Position Event Handler" as POS_HANDLER
collections "Notifications-Topic" as TOPIC_NOTIFICATIONS
collections "Event-Topic" as TOPIC_EVENT
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant POS_HANDLER
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume (Reject)
    alt Consume Single Message
        TOPIC_TRANSFER_POSITION <- POS_HANDLER: Consume Position event message for Payer
        activate TOPIC_TRANSFER_POSITION
        deactivate TOPIC_TRANSFER_POSITION

        break
            group Validate Event
                POS_HANDLER <-> POS_HANDLER: Validate event - Rule: type == 'position' && action == 'reject'
            end
        end

        group Persist Event Information
            POS_HANDLER -> TOPIC_EVENT: Publish event information
	        ref over POS_HANDLER, TOPIC_EVENT :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/master/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0.]]}
        end

        group Retrieve Current Transfer Details
            POS_HANDLER -> POS_DAO: Request to retrieve expirationDate & transferStateId
            activate POS_DAO
            POS_DAO -> DB: Fetch from database
            activate DB
            DB - -> POS_DAO
            deactivate DB
            hnote over DB #lightyellow
                transfer
                transferState
            end note
            POS_HANDLER <- - POS_DAO: Return transfer.expirationDate & transferState.transferStateId
            deactivate POS_DAO
        end

        break
            group Validate Transfer
                POS_HANDLER <-> POS_HANDLER: Validate transfer expiration - Rule: Date.now() < expirationDate
                POS_HANDLER <-> POS_HANDLER: Validate transfer state - Rule: **transferState**Id corresponds to 'RESERVED'
            end
        end

        group Decrement Payer Position (DFSP1)
            POS_HANDLER -> POS_DAO: Request to decrement latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist decrement to DB
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='ABORTED')
            POS_HANDLER -> POS_DAO: Request to persist transfer state
            activate POS_DAO
            POS_DAO -> DB: Persist transfer state
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferStateChange
            end note
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
    
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <ID>,
                from: <transferHeaders.FSPIOP-Source>,
                to: <transferHeaders.FSPIOP-Destination>,
                type: application/json,
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: reject,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS

    else Consume Batch Messages
        note left of POS_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.12(Sun Oct 21 15:45:15 IST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_151-b12
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1527px" preserveAspectRatio="none" style="width:1478px;height:1527px;" version="1.1" viewBox="0 0 1478 1527" width="1478px" zoomAndPan="magnify"><defs><filter height="300%" id="f1d6xhben3g614" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="277" x="601.5" y="23.5352">1.3.2. Fulfil Position Handler Consume</text><rect fill="#FFFFE0" height="1481.9883" style="stroke: #A80036; stroke-width: 1.0;" width="1231.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="594.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="1314.7012" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="87.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="484.5" y="1395.3672"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="136.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="617.5" y="186.5977"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="502.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="733.5" y="449.7031"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1203.5" y="216.2188"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1203.5" y="503.6348"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1203.5" y="637.877"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1203.5" y="745.8086"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="1300.7012" style="stroke: #000000; stroke-width: 2.0;" width="1454" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1434" x="23" y="396.3926"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="775" x="672" y="465.3242"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="92" x2="92" y1="116.2871" y2="1450.9883"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="489" x2="489" y1="116.2871" y2="1450.9883"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="622" x2="622" y1="116.2871" y2="1450.9883"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="738" x2="738" y1="116.2871" y2="1450.9883"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1208.5" x2="1208.5" y1="116.2871" y2="1450.9883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="33" y="113.334">Position Handler</text><ellipse cx="92.5" cy="83.7988" fill="#FEFECE" filter="url(#f1d6xhben3g614)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="88.5,71.7988,94.5,66.7988,92.5,71.7988,94.5,76.7988,88.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="33" y="1463.5234">Position Handler</text><ellipse cx="92.5" cy="1482.4766" fill="#FEFECE" filter="url(#f1d6xhben3g614)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="88.5,1470.4766,94.5,1465.4766,92.5,1470.4766,94.5,1475.4766,88.5,1470.4766" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1d6xhben3g614)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="420" y="76.7988"/><rect fill="#FEFECE" filter="url(#f1d6xhben3g614)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="416" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="423" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1d6xhben3g614)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="420" y="1449.9883"/><rect fill="#FEFECE" filter="url(#f1d6xhben3g614)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="416" y="1453.9883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="423" y="1474.5234">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="573" y="113.334">Transfer DAO</text><ellipse cx="622.5" cy="83.7988" fill="#FEFECE" filter="url(#f1d6xhben3g614)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="610.5" x2="634.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="573" y="1463.5234">Transfer DAO</text><ellipse cx="622.5" cy="1482.4766" fill="#FEFECE" filter="url(#f1d6xhben3g614)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="610.5" x2="634.5" y1="1496.4766" y2="1496.4766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="682" y="113.334">Position Facade</text><ellipse cx="738.5" cy="83.7988" fill="#FEFECE" filter="url(#f1d6xhben3g614)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="726.5" x2="750.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="682" y="1463.5234">Position Facade</text><ellipse cx="738.5" cy="1482.4766" fill="#FEFECE" filter="url(#f1d6xhben3g614)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="726.5" x2="750.5" y1="1496.4766" y2="1496.4766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1160.5" y="113.334">Central Store</text><path d="M1190.5,63.7988 C1190.5,53.7988 1208.5,53.7988 1208.5,53.7988 C1208.5,53.7988 1226.5,53.7988 1226.5,63.7988 L1226.5,89.7988 C1226.5,99.7988 1208.5,99.7988 1208.5,99.7988 C1208.5,99.7988 1190.5,99.7988 1190.5,89.7988 L1190.5,63.7988 " fill="#FEFECE" filter="url(#f1d6xhben3g614)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1190.5,63.7988 C1190.5,73.7988 1208.5,73.7988 1208.5,73.7988 C1208.5,73.7988 1226.5,73.7988 1226.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1160.5" y="1463.5234">Central Store</text><path d="M1190.5,1476.4766 C1190.5,1466.4766 1208.5,1466.4766 1208.5,1466.4766 C1208.5,1466.4766 1226.5,1466.4766 1226.5,1476.4766 L1226.5,1502.4766 C1226.5,1512.4766 1208.5,1512.4766 1208.5,1512.4766 C1208.5,1512.4766 1190.5,1512.4766 1190.5,1502.4766 L1190.5,1476.4766 " fill="#FEFECE" filter="url(#f1d6xhben3g614)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1190.5,1476.4766 C1190.5,1486.4766 1208.5,1486.4766 1208.5,1486.4766 C1208.5,1486.4766 1226.5,1486.4766 1226.5,1476.4766 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="1314.7012" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="87.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="484.5" y="1395.3672"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="136.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="617.5" y="186.5977"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="502.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="733.5" y="449.7031"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1203.5" y="216.2188"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1203.5" y="503.6348"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1203.5" y="637.877"/><rect fill="#FFFFFF" filter="url(#f1d6xhben3g614)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1203.5" y="745.8086"/><path d="M13,133.2871 L273,133.2871 L273,140.2871 L263,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1300.7012" style="stroke: #000000; stroke-width: 2.0;" width="1454" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="28" y="146.8555">Fulfil Position Handler Consume</text><polygon fill="#A80036" points="605.5,182.5977,615.5,186.5977,605.5,190.5977,609.5,186.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="611.5" y1="186.5977" y2="186.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="104.5" y="174.8213">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="117.5" y="167.166">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="117.5" y="182.4766">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="194.5" y="182.4766">2003</text><polygon fill="#A80036" points="1191.5,212.2188,1201.5,216.2188,1191.5,220.2188,1195.5,216.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="627.5" x2="1197.5" y1="216.2188" y2="216.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="634.5" y="211.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="647.5" y="211.7871">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1d6xhben3g614)" points="1143,229.5293,1274,229.5293,1284,248.5293,1274,267.5293,1143,267.5293,1133,248.5293,1143,229.5293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1145" y="246.0977">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1145" y="261.4082">transferParticipant</text><polygon fill="#A80036" points="638.5,290.1504,628.5,294.1504,638.5,298.1504,634.5,294.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="632.5" x2="1207.5" y1="294.1504" y2="294.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="644.5" y="289.7188">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="657.5" y="289.7188">Return current state of transfer from DB</text><polygon fill="#A80036" points="108.5,319.4609,98.5,323.4609,108.5,327.4609,104.5,323.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="102.5" x2="621.5" y1="323.4609" y2="323.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="319.0293">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="127.5" y="319.0293">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="139.5" y1="368.3926" y2="368.3926"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="139.5" y1="368.3926" y2="381.3926"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="98.5" x2="139.5" y1="381.3926" y2="381.3926"/><polygon fill="#A80036" points="108.5,377.3926,98.5,381.3926,108.5,385.3926,104.5,381.3926" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="104.5" y="355.9951">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="117.5" y="348.3398">Validate current state (transferState is 'RECEIVED-FULFIL')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="117.5" y="363.6504">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="194.5" y="363.6504">2001</text><path d="M23,396.3926 L744,396.3926 L744,403.3926 L734,413.3926 L23,413.3926 L23,396.3926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1434" x="23" y="396.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="676" x="38" y="409.9609">Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)</text><polygon fill="#A80036" points="721.5,445.7031,731.5,449.7031,721.5,453.7031,725.5,449.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="727.5" y1="449.7031" y2="449.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="104.5" y="437.9268">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="117.5" y="430.2715">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="117.5" y="445.582">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="194.5" y="445.582">2003</text><path d="M672,465.3242 L837,465.3242 L837,472.3242 L827,482.3242 L672,482.3242 L672,465.3242 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="775" x="672" y="465.3242"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="687" y="478.8926">DB TRANSACTION</text><polygon fill="#A80036" points="1191.5,499.6348,1201.5,503.6348,1191.5,507.6348,1195.5,503.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="1197.5" y1="503.6348" y2="503.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="750.5" y="499.2031">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="763.5" y="499.2031">Select participantPosition.value FOR UPDATE from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f1d6xhben3g614)" points="1147,516.9453,1270,516.9453,1280,527.9453,1270,539.9453,1147,539.9453,1137,527.9453,1147,516.9453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1149" y="533.5137">participantPosition</text><polygon fill="#A80036" points="754.5,562.2559,744.5,566.2559,754.5,570.2559,750.5,566.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="748.5" x2="1207.5" y1="566.2559" y2="566.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="760.5" y="561.8242">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="773.5" y="561.8242">Return participantPosition.value from DB for Payee</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="785.5" y1="595.877" y2="595.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="785.5" x2="785.5" y1="595.877" y2="608.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="744.5" x2="785.5" y1="608.877" y2="608.877"/><polygon fill="#A80036" points="754.5,604.877,744.5,608.877,754.5,612.877,750.5,608.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="750.5" y="591.1348">9</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="763.5" y="591.1348">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="857.5" y="591.1348">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="1191.5,633.877,1201.5,637.877,1191.5,641.877,1195.5,637.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="1197.5" y1="637.877" y2="637.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="750.5" y="633.4453">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="772.5" y="633.4453">Persist latestPosition to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f1d6xhben3g614)" points="1116,681.1875,1301,681.1875,1311,700.1875,1301,719.1875,1116,719.1875,1106,700.1875,1116,681.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1118" y="697.7559">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1172" y="697.7559">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1118" y="713.0664">SET value = latestPosition</text><polygon fill="#A80036" points="1191.5,741.8086,1201.5,745.8086,1191.5,749.8086,1195.5,745.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="743.5" x2="1197.5" y1="745.8086" y2="745.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="750.5" y="741.377">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="772.5" y="741.377">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#f1d6xhben3g614)" points="990,789.1191,1427,789.1191,1437,854.1191,1427,919.1191,990,919.1191,980,854.1191,990,789.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="992" y="805.6875">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1040" y="805.6875">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1183" y="805.6875">transferStateId = 'COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="996" y="820.998"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="992" y="836.3086">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1040" y="836.3086">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="992" y="851.6191">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="992" y="866.9297">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="992" y="882.2402">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="992" y="897.5508">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="992" y="912.8613">createdDate = new Date()</text><polygon fill="#A80036" points="108.5,948.6035,98.5,952.6035,108.5,956.6035,104.5,952.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="102.5" x2="737.5" y1="952.6035" y2="952.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="948.1719">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="136.5" y="948.1719">Return success</text><path d="M102,972.9141 L102,1349.9141 L364,1349.9141 L364,982.9141 L354,972.9141 L102,972.9141 " fill="#FFFF00" filter="url(#f1d6xhben3g614)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M354,972.9141 L354,982.9141 L364,982.9141 L354,972.9141 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="108" y="990.4824">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="108" y="1005.793">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="124" y="1021.1035">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="124" y="1036.4141">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="124" y="1051.7246">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="124" y="1067.0352">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="124" y="1082.3457">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="140" y="1097.6563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="140" y="1112.9668">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="124" y="1128.2773">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="124" y="1143.5879">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="140" y="1158.8984">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="156" y="1174.209">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="156" y="1189.5195">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="156" y="1204.8301">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="156" y="1220.1406">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="156" y="1235.4512">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="156" y="1250.7617">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="172" y="1266.0723">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="172" y="1281.3828">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="156" y="1296.6934">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="140" y="1312.0039">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="124" y="1327.3145">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="108" y="1342.625">}</text><polygon fill="#A80036" points="472.5,1391.3672,482.5,1395.3672,472.5,1399.3672,476.5,1395.3672" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="478.5" y1="1395.3672" y2="1395.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="104.5" y="1383.5908">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="126.5" y="1375.9355">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="126.5" y="1391.2461">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="203.5" y="1391.2461">2003</text><!--
@startuml
title 1.3.2. Fulfil Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Notification-Topic" as TOPIC_NOTIFICATION
entity "Position Facade" as POS_FACADE
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_NOTIFICATION
    participant TRANS_DAO
    participant POS_FACADE
    participant DB
end box

activate POS_HANDLER
group Fulfil Position Handler Consume
    POS_HANDLER -> TRANS_DAO: Request current state of transfer from DB \n<color #FF0000><b>Error code:</b> 2003</color>
    activate TRANS_DAO
    TRANS_DAO -> DB: Retrieve current state of transfer from DB
    activate DB
    hnote over DB #lightyellow
        transferStateChange
        transferParticipant
    end note
    DB - -> TRANS_DAO: Return current state of transfer from DB
    deactivate DB
    TRANS_DAO - -> POS_HANDLER: Return current state of transfer from DB
    deactivate TRANS_DAO
    POS_HANDLER <-> POS_HANDLER: Validate current state (transferState is 'RECEIVED-FULFIL')\n<color #FF0000><b>Error code:</b> 2001</color>
    group Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)
        POS_HANDLER -> POS_FACADE: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
        group <color #blue>DB TRANSACTION</color>
            activate POS_FACADE
            POS_FACADE -> DB: Select participantPosition.value FOR UPDATE from DB for Payee
            activate DB
            hnote over DB #lightyellow
                participantPosition
            end note
            DB - -> POS_FACADE: Return participantPosition.value from DB for Payee
            deactivate DB
            POS_FACADE <-> POS_FACADE: **latestPosition** = participantPosition.value - payload.amount.amount
            POS_FACADE->DB: Persist latestPosition to DB for Payee
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = latestPosition
            end note
            activate DB
            deactivate DB
            POS_FACADE -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                    INSERT **transferStateChange** transferStateId = 'COMMITTED'

                    INSERT **participantPositionChange**
                    SET participantPositionId = participantPosition.participantPositionId,
                    transferStateChangeId = transferStateChange.transferStateChangeId,
                    value = latestPosition,
                    reservedValue = participantPosition.reservedValue
                    createdDate = new Date()
            end note
            activate DB
            deactivate DB
            deactivate TRANS_DAO
        end
        POS_FACADE - -> POS_HANDLER: Return success
        deactivate POS_FACADE
    end

    note right of POS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: transfer,
                    action: commit,
                    createdAt: <timestamp>,
                    state: {
                        status: "success",
                        code: 0
                    }
                }
            }
        }
    end note
    POS_HANDLER -> TOPIC_NOTIFICATION: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_NOTIFICATION
    deactivate TOPIC_NOTIFICATION
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b20
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1660px" preserveAspectRatio="none" style="width:766px;height:1660px;" version="1.1" viewBox="0 0 766 1660" width="766px" zoomAndPan="magnify"><defs><filter height="300%" id="fftpwzqhewm2q" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="262" y="23.5352">6.3.1. Settlement Transfer Prepare</text><rect fill="#90EE90" height="1615.2773" style="stroke: #A80036; stroke-width: 1.0;" width="130" x="35" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="38" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1615.2773" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="380" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="383" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="1447.9902" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="95" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="226.5293"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="489.5664"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="597.498"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="736.0508"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="1114.3086"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="1329.4141"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="1433.9902" style="stroke: #000000; stroke-width: 2.0;" width="742" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="1133.6426" style="stroke: #000000; stroke-width: 2.0;" width="722" x="23" y="426.6348"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="1102.332" style="stroke: #000000; stroke-width: 2.0;" width="702" x="33" y="450.9453"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="381" x="100" y="920.8457"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="381" x="100" y="977.4668"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="381" x="100" y="1031.7324"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="100" x2="100" y1="116.2871" y2="1584.2773"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="437" x2="437" y1="116.2871" y2="1584.2773"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="43" y="113.334">Settlement DAO</text><ellipse cx="100" cy="83.7988" fill="#FEFECE" filter="url(#fftpwzqhewm2q)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="88" x2="112" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="43" y="1596.8125">Settlement DAO</text><ellipse cx="100" cy="1615.7656" fill="#FEFECE" filter="url(#fftpwzqhewm2q)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="88" x2="112" y1="1629.7656" y2="1629.7656"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="389" y="113.334">Central Store</text><path d="M419,63.7988 C419,53.7988 437,53.7988 437,53.7988 C437,53.7988 455,53.7988 455,63.7988 L455,89.7988 C455,99.7988 437,99.7988 437,99.7988 C437,99.7988 419,99.7988 419,89.7988 L419,63.7988 " fill="#FEFECE" filter="url(#fftpwzqhewm2q)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M419,63.7988 C419,73.7988 437,73.7988 437,73.7988 C437,73.7988 455,73.7988 455,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="389" y="1596.8125">Central Store</text><path d="M419,1609.7656 C419,1599.7656 437,1599.7656 437,1599.7656 C437,1599.7656 455,1599.7656 455,1609.7656 L455,1635.7656 C455,1645.7656 437,1645.7656 437,1645.7656 C437,1645.7656 419,1645.7656 419,1635.7656 L419,1609.7656 " fill="#FEFECE" filter="url(#fftpwzqhewm2q)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M419,1609.7656 C419,1619.7656 437,1619.7656 437,1619.7656 C437,1619.7656 455,1619.7656 455,1609.7656 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="1447.9902" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="95" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="226.5293"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="489.5664"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="597.498"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="736.0508"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="1114.3086"/><rect fill="#FFFFFF" filter="url(#fftpwzqhewm2q)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="432" y="1329.4141"/><path d="M13,133.2871 L249,133.2871 L249,140.2871 L239,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1433.9902" style="stroke: #000000; stroke-width: 2.0;" width="742" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="191" x="28" y="146.8555">Settlement Transfer Prepare</text><path d="M110,155.5977 L110,195.5977 L517,195.5977 L517,165.5977 L507,155.5977 L110,155.5977 " fill="#D3D3D3" filter="url(#fftpwzqhewm2q)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M507,155.5977 L507,165.5977 L517,165.5977 L507,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="116" y="173.166">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="159" y="173.166">: settlementId, transactionTimestamp as</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="417" y="173.166">tTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="498" y="173.166">,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="132" y="188.4766">expDelaySeconds</text><polygon fill="#A80036" points="420,222.5293,430,226.5293,420,230.5293,424,226.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="426" y1="226.5293" y2="226.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="221.7871">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="125" y="221.7871">Retrieve the list of SETTLED, but not prepared</text><polygon fill="#FFFFE0" filter="url(#fftpwzqhewm2q)" points="255,239.5293,618,239.5293,628,311.5293,618,384.5293,255,384.5293,245,311.5293,255,239.5293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="257" y="256.0977">SELECT spc.*, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="257" y="271.4082">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="297" y="271.4082">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="508" y="271.4082">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="257" y="286.7188">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="289" y="286.7188">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="429" y="286.7188">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="257" y="302.0293">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="257" y="317.3398">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="322" y="317.3398">transferDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="20" x="485" y="317.3398">tdc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="257" y="332.6504">ON tdc.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="257" y="347.9609">WHERE spc.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="257" y="363.2715">AND tdc.transferId IS NULL</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="261" y="378.582"/><polygon fill="#A80036" points="116,407.6348,106,411.6348,116,415.6348,112,411.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="110" x2="436" y1="411.6348" y2="411.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="406.8926">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="135" y="406.8926">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="180" y="406.8926">settlementTransferList</text><path d="M23,426.6348 L97,426.6348 L97,433.6348 L87,443.6348 L23,443.6348 L23,426.6348 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1133.6426" style="stroke: #000000; stroke-width: 2.0;" width="722" x="23" y="426.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="38" y="440.2031">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="112" y="439.2695">[t IN settlementTransferList]</text><path d="M33,450.9453 L198,450.9453 L198,457.9453 L188,467.9453 L33,467.9453 L33,450.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1102.332" style="stroke: #000000; stroke-width: 2.0;" width="702" x="33" y="450.9453"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="48" y="464.5137">DB TRANSACTION</text><polygon fill="#A80036" points="420,485.5664,430,489.5664,420,493.5664,424,489.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="426" y1="489.5664" y2="489.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="484.8242">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="125" y="484.8242">Insert transferDuplicateCheck</text><polygon fill="#FFFFE0" filter="url(#fftpwzqhewm2q)" points="181,532.5664,693,532.5664,703,551.5664,693,570.5664,181,570.5664,171,551.5664,181,532.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="183" y="549.1348">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="159" x="267" y="549.1348">transferDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="430" y="549.1348">(transferId, hash, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="508" x="183" y="564.4453">VALUES (t.settlementTransferId, hashCode(t.settlementTransferId), {tTimestamp})</text><polygon fill="#A80036" points="420,593.498,430,597.498,420,601.498,424,597.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="426" y1="597.498" y2="597.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="592.7559">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="125" y="592.7559">Insert transfer</text><polygon fill="#FFFFE0" filter="url(#fftpwzqhewm2q)" points="215,640.498,658,640.498,668,674.498,658,709.498,215,709.498,205,674.498,215,640.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="217" y="657.0664">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="301" y="657.0664">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="359" y="657.0664">(transferId, amount, currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="245" y="672.377">ilpCondition, expirationDate, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="217" y="687.6875">VALUES (t.settlementTransferId, t.netAmount, t.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="245" y="702.998">0, new Date(+new Date()+1000*expDelaySeconds), {tTimestamp})</text><polygon fill="#A80036" points="420,732.0508,430,736.0508,420,740.0508,424,736.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="426" y1="736.0508" y2="736.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="731.3086">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="247" x="125" y="731.3086">Retrieve participant settlement account</text><polygon fill="#FFFFE0" filter="url(#fftpwzqhewm2q)" points="248,749.0508,625,749.0508,635,814.0508,625,879.0508,248,879.0508,238,814.0508,248,749.0508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="250" y="765.6191">SELECT pc2.participantCurrencyId AS settlementAccountId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="250" y="780.9297">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="290" y="780.9297">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="430" y="780.9297">pc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="250" y="796.2402">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="282" y="796.2402">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="422" y="796.2402">pc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="256" x="250" y="811.5508">ON pc2.participantId = pc1.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="237" x="250" y="826.8613">AND pc2.currencyId = pc1.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="250" y="842.1719">AND pc2.ledgerAccountType = {SETTLEMENT}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="250" y="857.4824">AND pc2.isActive = 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="250" y="872.793">WHERE pc1.participantCurrencyId = t.participantCurrencyId</text><polygon fill="#A80036" points="116,901.8457,106,905.8457,116,909.8457,112,905.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="110" x2="436" y1="905.8457" y2="905.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="901.1035">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="135" y="901.1035">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="180" y="901.1035">settlementAccountId</text><path d="M100,920.8457 L162,920.8457 L162,927.8457 L152,937.8457 L100,937.8457 L100,920.8457 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="381" x="100" y="920.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="115" y="934.4141">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="177" y="933.4805">[t.netAmount &lt; 0]</text><path d="M110,943.1563 L110,968.1563 L467,968.1563 L467,953.1563 L457,943.1563 L110,943.1563 " fill="#D3D3D3" filter="url(#fftpwzqhewm2q)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M457,943.1563 L457,953.1563 L467,953.1563 L457,943.1563 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="116" y="960.7246">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="247" y="960.7246">= {SETTLEMENT_NET_RECIPIENT}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="100" x2="481" y1="978.4668" y2="978.4668"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="105" y="989.1016">[t.netAmount &gt; 0]</text><path d="M110,997.4219 L110,1022.4219 L452,1022.4219 L452,1007.4219 L442,997.4219 L110,997.4219 " fill="#D3D3D3" filter="url(#fftpwzqhewm2q)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M442,997.4219 L442,1007.4219 L452,1007.4219 L442,997.4219 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="116" y="1014.9902">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="247" y="1014.9902">= {SETTLEMENT_NET_SENDER}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="100" x2="481" y1="1032.7324" y2="1032.7324"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="105" y="1043.3672">[t.netAmount == 0]</text><path d="M110,1051.6875 L110,1076.6875 L436,1076.6875 L436,1061.6875 L426,1051.6875 L110,1051.6875 " fill="#D3D3D3" filter="url(#fftpwzqhewm2q)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M426,1051.6875 L426,1061.6875 L436,1061.6875 L426,1051.6875 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="116" y="1069.2559">ledgerEntryTypeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="247" y="1069.2559">= {SETTLEMENT_NET_ZERO}</text><polygon fill="#A80036" points="420,1110.3086,430,1114.3086,420,1118.3086,424,1114.3086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="426" y1="1114.3086" y2="1114.3086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="1109.5664">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="125" y="1109.5664">Insert transferParticipant records</text><polygon fill="#FFFFE0" filter="url(#fftpwzqhewm2q)" points="167,1157.3086,707,1157.3086,717,1229.3086,707,1302.3086,167,1302.3086,157,1229.3086,167,1157.3086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="169" y="1173.877">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="253" y="1173.877">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="384" y="1173.877">(transferId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="197" y="1189.1875">transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="169" y="1204.498">VALUES (t.settlementTransferId, {settlementAccountId},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="508" x="197" y="1219.8086">{DFSP_SETTLEMENT_ACCOUNT}, {ledgerEntryTypeId}, t.netAmount, {tTimestamp})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="173" y="1235.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="169" y="1250.4297">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="253" y="1250.4297">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="384" y="1250.4297">(transferId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="197" y="1265.7402">transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="169" y="1281.0508">VALUES (t.settlementTransferId, t.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="197" y="1296.3613">{DFSP_POSITION_ACCOUNT}, {ledgerEntryTypeId}, -t.netAmount, {tTimestamp})</text><polygon fill="#A80036" points="420,1325.4141,430,1329.4141,420,1333.4141,424,1329.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="105" x2="426" y1="1329.4141" y2="1329.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="1324.6719">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="125" y="1324.6719">Insert transferStateChange</text><polygon fill="#FFFFE0" filter="url(#fftpwzqhewm2q)" points="158,1372.4141,715,1372.4141,725,1391.4141,715,1410.4141,158,1410.4141,148,1391.4141,158,1372.4141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="160" y="1388.9824">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="244" y="1388.9824">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="387" y="1388.9824">(transferId, transferStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="553" x="160" y="1404.293">VALUES (t.settlementTransferId, {RESERVED}, 'Settlement transfer prepare', {tTimestamp})</text><path d="M110,1446.0352 L110,1486.0352 L555,1486.0352 L555,1456.0352 L545,1446.0352 L110,1446.0352 " fill="#D3D3D3" filter="url(#fftpwzqhewm2q)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M545,1446.0352 L545,1456.0352 L555,1456.0352 L545,1446.0352 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="116" y="1463.6035">TODO:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="378" x="162" y="1463.6035">Store the external settlement transaction reference provided</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="116" y="1478.9141">by the API during updateSettlementById as a transferExtension.</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="105" x2="147" y1="1532.2773" y2="1532.2773"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="147" x2="147" y1="1532.2773" y2="1545.2773"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="106" x2="147" y1="1545.2773" y2="1545.2773"/><polygon fill="#A80036" points="116,1541.2773,106,1545.2773,116,1549.2773,112,1545.2773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="112" y="1519.8799">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="125" y="1512.2246">Omit ilpPacket, participantPosition &amp;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="125" y="1527.5352">participantPositionChange</text><!--
@startuml
title 6.3.1. Settlement Transfer Prepare
autonumber

entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Settlement Service" #lightgreen
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

activate SETTLE_DAO
group Settlement Transfer Prepare
    note right of SETTLE_DAO #lightgray
        **Inputs**: settlementId, transactionTimestamp as **tTimestamp**,
            expDelaySeconds
    end note
    SETTLE_DAO -> DB: Retrieve the list of SETTLED, but not prepared
    activate DB
    hnote over DB #lightyellow
        SELECT spc.*, pc.currencyId
        FROM **settlementParticipantCurrency** spc
        JOIN **participantCurrency** pc
        ON pc.participantCurrencyId = spc.participantCurrencyId
        LEFT JOIN **transferDuplicateCheck** tdc
        ON tdc.transferId = spc.settlementTransferId
        WHERE spc.settlementId = {settlementId}
        AND tdc.transferId IS NULL

    end hnote
    DB - -> SETTLE_DAO: Return **settlementTransferList**
    deactivate DB
    loop t IN settlementTransferList
        group <color #blue>DB TRANSACTION</color>
            SETTLE_DAO -> DB: Insert transferDuplicateCheck
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferDuplicateCheck** (transferId, hash, createdDate)
                VALUES (t.settlementTransferId, hashCode(t.settlementTransferId), {tTimestamp})
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert transfer
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transfer** (transferId, amount, currencyId, 
                       ilpCondition, expirationDate, createdDate)
                VALUES (t.settlementTransferId, t.netAmount, t.currencyId,
                       0, new Date(+new Date()+1000*expDelaySeconds), {tTimestamp})
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Retrieve participant settlement account
            activate DB
            hnote over DB #lightyellow
                SELECT pc2.participantCurrencyId AS settlementAccountId
                FROM **participantCurrency** pc1
                JOIN **participantCurrency** pc2
                ON pc2.participantId = pc1.participantId
                AND pc2.currencyId = pc1.currencyId
                AND pc2.ledgerAccountType = {SETTLEMENT}
                AND pc2.isActive = 1
                WHERE pc1.participantCurrencyId = t.participantCurrencyId
            end hnote
            DB - -> SETTLE_DAO: Return **settlementAccountId**
            deactivate DB
            alt t.netAmount < 0
                note right of SETTLE_DAO #lightgray
                    **ledgerEntryTypeId** = {SETTLEMENT_NET_RECIPIENT}
                end note
            else t.netAmount > 0
                note right of SETTLE_DAO #lightgray
                    **ledgerEntryTypeId** = {SETTLEMENT_NET_SENDER}
                end note
            else t.netAmount == 0
                note right of SETTLE_DAO #lightgray
                    **ledgerEntryTypeId** = {SETTLEMENT_NET_ZERO}
                end note
            end
            SETTLE_DAO -> DB: Insert transferParticipant records
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferParticipant** (transferId, participantCurrencyId, 
                       transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)
                VALUES (t.settlementTransferId, {settlementAccountId},
                       {DFSP_SETTLEMENT_ACCOUNT}, {ledgerEntryTypeId}, t.netAmount, {tTimestamp})
                
                INSERT INTO **transferParticipant** (transferId, participantCurrencyId, 
                       transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)
                VALUES (t.settlementTransferId, t.participantCurrencyId,
                       {DFSP_POSITION_ACCOUNT}, {ledgerEntryTypeId}, -t.netAmount, {tTimestamp})
            end hnote
            deactivate DB
            SETTLE_DAO -> DB: Insert transferStateChange
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange** (transferId, transferStateId, reason, createdDate)
                VALUES (t.settlementTransferId, {RESERVED}, 'Settlement transfer prepare', {tTimestamp})
            end hnote
            deactivate DB
            |||
            note right of SETTLE_DAO #lightgray
                <color #red>TODO:</color> Store the external settlement transaction reference provided
                by the API during updateSettlementById as a transferExtension.
            end note
            SETTLE_DAO - -> SETTLE_DAO: Omit ilpPacket, participantPosition &\nparticipantPositionChange
        end
    end
end
deactivate SETTLE_DAO

@enduml

PlantUML version 1.2018.05(Sat May 05 22:00:17 CEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1455px" preserveAspectRatio="none" style="width:823px;height:1455px;" version="1.1" viewBox="0 0 823 1455" width="823px" zoomAndPan="magnify"><defs><filter height="300%" id="ft2sj9epxmikl" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="248" x="288.5" y="23.5352">6.3.2. Settlement Transfer Commit</text><rect fill="#90EE90" height="1409.6777" style="stroke: #A80036; stroke-width: 1.0;" width="130" x="45" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="48" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="1409.6777" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="476" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="479" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="1242.3906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="126.2871"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="211.2188"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="535.498"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="673.3613"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="865.8457"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="1138.5723"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="1228.3906" style="stroke: #000000; stroke-width: 2.0;" width="799" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="882.1113" style="stroke: #000000; stroke-width: 2.0;" width="779" x="23" y="472.5664"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="850.8008" style="stroke: #000000; stroke-width: 2.0;" width="759" x="33" y="496.877"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="90.2422" style="stroke: #000000; stroke-width: 2.0;" width="481" x="43" y="1020.0195"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="110" x2="110" y1="116.2871" y2="1378.6777"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="533" x2="533" y1="116.2871" y2="1378.6777"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="113.334">Settlement DAO</text><ellipse cx="110" cy="83.7988" fill="#FEFECE" filter="url(#ft2sj9epxmikl)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="98" x2="122" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="53" y="1391.2129">Settlement DAO</text><ellipse cx="110" cy="1410.166" fill="#FEFECE" filter="url(#ft2sj9epxmikl)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="98" x2="122" y1="1424.166" y2="1424.166"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="485" y="113.334">Central Store</text><path d="M515,63.7988 C515,53.7988 533,53.7988 533,53.7988 C533,53.7988 551,53.7988 551,63.7988 L551,89.7988 C551,99.7988 533,99.7988 533,99.7988 C533,99.7988 515,99.7988 515,89.7988 L515,63.7988 " fill="#FEFECE" filter="url(#ft2sj9epxmikl)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M515,63.7988 C515,73.7988 533,73.7988 533,73.7988 C533,73.7988 551,73.7988 551,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="485" y="1391.2129">Central Store</text><path d="M515,1404.166 C515,1394.166 533,1394.166 533,1394.166 C533,1394.166 551,1394.166 551,1404.166 L551,1430.166 C551,1440.166 533,1440.166 533,1440.166 C533,1440.166 515,1440.166 515,1430.166 L515,1404.166 " fill="#FEFECE" filter="url(#ft2sj9epxmikl)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M515,1404.166 C515,1414.166 533,1414.166 533,1414.166 C533,1414.166 551,1414.166 551,1404.166 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="1242.3906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="126.2871"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="211.2188"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="535.498"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="673.3613"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="865.8457"/><rect fill="#FFFFFF" filter="url(#ft2sj9epxmikl)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="528" y="1138.5723"/><path d="M13,133.2871 L248,133.2871 L248,140.2871 L238,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1228.3906" style="stroke: #000000; stroke-width: 2.0;" width="799" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="190" x="28" y="146.8555">Settlement Transfer Commit</text><path d="M120,155.5977 L120,180.5977 L452,180.5977 L452,165.5977 L442,155.5977 L120,155.5977 " fill="#D3D3D3" filter="url(#ft2sj9epxmikl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M442,155.5977 L442,165.5977 L452,165.5977 L442,155.5977 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="126" y="173.166">Inputs</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="169" y="173.166">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="177" y="173.166">settlementId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="266" y="173.166">that has just been SETTLED</text><polygon fill="#A80036" points="516,207.2188,526,211.2188,516,215.2188,520,211.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="522" y1="211.2188" y2="211.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="206.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="135" y="206.4766">Retrieve the list of RESERVED, but not COMMITTED</text><polygon fill="#FFFFE0" filter="url(#ft2sj9epxmikl)" points="348,224.2188,718,224.2188,728,327.2188,718,431.2188,348,431.2188,338,327.2188,348,224.2188" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="361" x="350" y="240.7871">SELECT tp.transferId, tp.participantCurrencyId, tp.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="350" y="256.0977">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="390" y="256.0977">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="601" y="256.0977">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="350" y="271.4082">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="382" y="271.4082">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="525" y="271.4082">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="350" y="286.7188">ON tsc1.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="350" y="302.0293">AND tsc1.transferStateId = {RESERVED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="350" y="317.3398">LEFT JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="415" y="317.3398">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="558" y="317.3398">tsc2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="350" y="332.6504">ON tsc2.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="350" y="347.9609">AND tsc2.transferStateId = {COMMITTED}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="350" y="363.2715">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="382" y="363.2715">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="513" y="363.2715">tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="350" y="378.582">ON tp.transferId = spc.settlementTransferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="350" y="393.8926">AND tp.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="350" y="409.2031">WHERE spc.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="350" y="424.5137">AND tsc2.transferId IS NULL</text><polygon fill="#A80036" points="126,453.5664,116,457.5664,126,461.5664,122,457.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="532" y1="457.5664" y2="457.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="452.8242">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="452.8242">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="190" y="452.8242">settlementTransferList</text><path d="M23,472.5664 L188,472.5664 L188,479.5664 L178,489.5664 L23,489.5664 L23,472.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="882.1113" style="stroke: #000000; stroke-width: 2.0;" width="779" x="23" y="472.5664"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="38" y="486.1348">DB TRANSACTION</text><path d="M33,496.877 L107,496.877 L107,503.877 L97,513.877 L33,513.877 L33,496.877 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="850.8008" style="stroke: #000000; stroke-width: 2.0;" width="759" x="33" y="496.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="48" y="510.4453">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="122" y="509.5117">[t IN settlementTransferList]</text><polygon fill="#A80036" points="516,531.498,526,535.498,516,539.498,520,535.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="522" y1="535.498" y2="535.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="530.7559">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="243" x="135" y="530.7559">Select participantPosition FOR UPDATE</text><polygon fill="#FFFFE0" filter="url(#ft2sj9epxmikl)" points="358,548.498,708,548.498,718,582.498,708,617.498,358,617.498,348,582.498,358,548.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="360" y="565.0664">SELECT value positionValue, reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="360" y="580.377">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="400" y="580.377">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="360" y="595.6875">WHERE participantCurrencyId = t.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="360" y="610.998">FOR UPDATE</text><polygon fill="#A80036" points="126,640.0508,116,644.0508,126,648.0508,122,644.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="532" y1="644.0508" y2="644.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="639.3086">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="639.3086">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="190" y="639.3086">positionValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="286" y="639.3086">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="313" y="639.3086">reservedValue</text><polygon fill="#A80036" points="516,669.3613,526,673.3613,516,677.3613,520,673.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="522" y1="673.3613" y2="673.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="668.6191">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="135" y="668.6191">Select participant NET_DEBIT_CAP limit</text><polygon fill="#FFFFE0" filter="url(#ft2sj9epxmikl)" points="352,686.3613,713,686.3613,723,720.3613,713,755.3613,352,755.3613,342,720.3613,352,686.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="357" x="354" y="702.9297">SELECT value AS netDebitCap, thresholdAlarmPercentage</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="354" y="718.2402">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="394" y="718.2402">participantLimit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="354" y="733.5508">WHERE participantCurrencyId = t.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="301" x="354" y="748.8613">AND participantLimitTypeId = {NET_DEBIT_CAP}</text><polygon fill="#A80036" points="126,777.9141,116,781.9141,126,785.9141,122,781.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="532" y1="781.9141" y2="781.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="777.1719">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="777.1719">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="190" y="777.1719">netDebitCap</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="278" y="777.1719">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="182" x="305" y="777.1719">thresholdAlarmPercentage</text><path d="M120,794.9141 L120,834.9141 L651,834.9141 L651,804.9141 L641,794.9141 L120,794.9141 " fill="#D3D3D3" filter="url(#ft2sj9epxmikl)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M641,794.9141 L641,804.9141 L651,804.9141 L641,794.9141 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="126" y="812.4824">isLimitExceeded</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="240" y="812.4824">= netDebitCap - positionValue - reservedValue - t.amount &lt; 0</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="126" y="827.793">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="220" y="827.793">= positionValue + t.amount</text><polygon fill="#A80036" points="516,861.8457,526,865.8457,516,869.8457,520,865.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="522" y1="865.8457" y2="865.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="861.1035">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="135" y="861.1035">Persist latestPosition</text><polygon fill="#FFFFE0" filter="url(#ft2sj9epxmikl)" points="327,878.8457,738,878.8457,748,927.8457,738,977.8457,327,977.8457,317,927.8457,327,878.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="329" y="895.4141">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="383" y="895.4141">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="329" y="910.7246">SET value = {latestPosition},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="391" x="345" y="926.0352">participantPositionId = LAST_INSERT_ID(participantPositionId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="329" y="941.3457">WHERE participantCurrencyId = t.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="333" y="956.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="329" y="971.9668">SELECT LAST_INSERT_ID() AS participantPositionId</text><polygon fill="#A80036" points="126,1001.0195,116,1005.0195,126,1009.0195,122,1005.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="120" x2="532" y1="1005.0195" y2="1005.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="1000.2773">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="145" y="1000.2773">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="190" y="1000.2773">participantPositionId</text><path d="M43,1020.0195 L110,1020.0195 L110,1027.0195 L100,1037.0195 L43,1037.0195 L43,1020.0195 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.2422" style="stroke: #000000; stroke-width: 2.0;" width="481" x="43" y="1020.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="58" y="1033.5879">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="146" x="125" y="1032.6543">[isLimitExceeded == true]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="157" y1="1089.2617" y2="1089.2617"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="157" x2="157" y1="1089.2617" y2="1102.2617"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="116" x2="157" y1="1102.2617" y2="1102.2617"/><polygon fill="#A80036" points="126,1098.2617,116,1102.2617,126,1106.2617,122,1102.2617" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="122" y="1069.209">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="326" x="135" y="1053.8984">Increase NET_DEBIT_CAP with the value of t.amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="135" y="1069.209">(using this method:</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/central-ledger/blob/develop/src/models/participant/facade.js#L320" xlink:show="new" xlink:title="https://github.com/mojaloop/central-ledger/blob/develop/src/models/participant/facade.js#L320" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="193" x="262" y="1069.209">participantFacade.adjustLimits</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="262" x2="455" y1="1071.209" y2="1071.209"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="455" y="1069.209">)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="135" y="1084.5195">TODO:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="181" y="1084.5195">Notify DFSP for NDC change  is not implemented yet</text><polygon fill="#A80036" points="516,1134.5723,526,1138.5723,516,1142.5723,520,1138.5723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="115" x2="522" y1="1138.5723" y2="1138.5723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="122" y="1133.8301">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="144" y="1133.8301">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#ft2sj9epxmikl)" points="294,1181.5723,772,1181.5723,782,1261.5723,772,1342.5723,294,1342.5723,284,1261.5723,294,1181.5723" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="296" y="1198.1406">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="380" y="1198.1406">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="506" y="1198.1406">(transferId, ilpFulfilment, completedDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="324" y="1213.4512">isValid, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="368" x="296" y="1228.7617">VALUES (t.transferId, 0, tTimestamp, 1, NULL, tTimestamp)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="300" y="1244.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="296" y="1259.3828">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="380" y="1259.3828">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="523" y="1259.3828">(transferId, transferStateId, reason)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="409" x="296" y="1274.6934">VALUES (t.transferId, {COMMITTED}, 'Settlement transfer commit')</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="300" y="1290.0039"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="296" y="1305.3145">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="380" y="1305.3145">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="324" y="1320.625">(participantPositionId, transferStateChangeId, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="296" y="1335.9355">VALUES ({participantPositionId}, {COMMITTED}, {latestPosition})</text><!--
@startuml
title 6.3.2. Settlement Transfer Commit
autonumber

entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Settlement Service" #lightgreen
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

activate SETTLE_DAO
group Settlement Transfer Commit
    note right of SETTLE_DAO #lightgray
        **Inputs**: **settlementId** that has just been SETTLED
    end note
    SETTLE_DAO -> DB: Retrieve the list of RESERVED, but not COMMITTED
    activate DB
    hnote over DB #lightyellow
        SELECT tp.transferId, tp.participantCurrencyId, tp.amount
        FROM **settlementParticipantCurrency** spc
        JOIN **transferStateChange** tsc1
        ON tsc1.transferId = spc.settlementTransferId
        AND tsc1.transferStateId = {RESERVED}
        LEFT JOIN **transferStateChange** tsc2
        ON tsc2.transferId = spc.settlementTransferId
        AND tsc2.transferStateId = {COMMITTED}
        JOIN **transferParticipant** tp
        ON tp.transferId = spc.settlementTransferId
        AND tp.participantCurrencyId = spc.participantCurrencyId
        WHERE spc.settlementId = {settlementId}
        AND tsc2.transferId IS NULL
    end hnote
    DB - -> SETTLE_DAO: Return **settlementTransferList**
    deactivate DB
    group <color #blue>DB TRANSACTION</color>
        loop t IN settlementTransferList
            SETTLE_DAO -> DB: Select participantPosition FOR UPDATE
            activate DB
            hnote over DB #lightyellow
                SELECT value positionValue, reservedValue
                FROM **participantPosition**
                WHERE participantCurrencyId = t.participantCurrencyId
                FOR UPDATE
            end note
            DB - -> SETTLE_DAO: Return **positionValue** and **reservedValue**
            deactivate DB
            SETTLE_DAO -> DB: Select participant NET_DEBIT_CAP limit
            activate DB
            hnote over DB #lightyellow
                SELECT value AS netDebitCap, thresholdAlarmPercentage
                FROM **participantLimit**
                WHERE participantCurrencyId = t.participantCurrencyId
                AND participantLimitTypeId = {NET_DEBIT_CAP}
            end note
            DB - -> SETTLE_DAO: Return **netDebitCap** and **thresholdAlarmPercentage**
            deactivate DB
            note right of SETTLE_DAO #lightgray
                **isLimitExceeded** = netDebitCap - positionValue - reservedValue - t.amount < 0
                **latestPosition** = positionValue + t.amount
            end note
            SETTLE_DAO->DB: Persist latestPosition
            activate DB
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = {latestPosition},
                    participantPositionId = LAST_INSERT_ID(participantPositionId)
                WHERE participantCurrencyId = t.participantCurrencyId

                SELECT LAST_INSERT_ID() AS participantPositionId
            end note
            DB- ->SETTLE_DAO: Return **participantPositionId**
            deactivate DB
            opt isLimitExceeded == true
                SETTLE_DAO->SETTLE_DAO: Increase NET_DEBIT_CAP with the value of t.amount\n(using this method: [[https://github.com/mojaloop/central-ledger/blob/develop/src/models/participant/facade.js#L320 participantFacade.adjustLimits]])\n<color #red>TODO:</color> Notify DFSP for NDC change  is not implemented yet
            end
            deactivate DB
            SETTLE_DAO -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                INSERT INTO **transferFulfilment** (transferId, ilpFulfilment, completedDate, 
                       isValid, settlementWindowId, createdDate)
                VALUES (t.transferId, 0, tTimestamp, 1, NULL, tTimestamp)

                INSERT INTO **transferStateChange** (transferId, transferStateId, reason)
                VALUES (t.transferId, {COMMITTED}, 'Settlement transfer commit')

                INSERT INTO **participantPositionChange**
                       (participantPositionId, transferStateChangeId, value)
                VALUES ({participantPositionId}, {COMMITTED}, {latestPosition})
            end note
            activate DB
            deactivate DB
        end
    end
end
deactivate SETTLE_DAO

@enduml

PlantUML version 1.2018.05(Sat May 05 22:00:17 CEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>
<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1557px" preserveAspectRatio="none" style="width:1768px;height:1557px;" version="1.1" viewBox="0 0 1768 1557" width="1768px" zoomAndPan="magnify"><defs><filter height="300%" id="f13ytn3qc3vnot" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="376" x="697" y="23.5352">1.1.2.b. Position Handler Consume (batch messages)</text><rect fill="#FFFFE0" height="1512.5039" style="stroke: #A80036; stroke-width: 1.0;" width="1684.5" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="810.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="1345.2168" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="478" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1214" y="1419.1934"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1345.5" y="451.082"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1345.5" y="686.9453"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1453" y="869.498"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1646.5" y="480.3926"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1646.5" y="716.2559"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1646.5" y="898.8086"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="1331.2168" style="stroke: #000000; stroke-width: 2.0;" width="1744" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="752.5" x="393" y="216.9082"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="1069.043" style="stroke: #000000; stroke-width: 2.0;" width="1364" x="383" y="388.4609"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1330" x="393" y="412.7715"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1344" x="393" y="831.1875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="108" x2="108" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="483" x2="483" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1090.5" x2="1090.5" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1218.5" x2="1218.5" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1350.5" x2="1350.5" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1457.5" x2="1457.5" y1="116.2871" y2="1481.5039"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1651.5" x2="1651.5" y1="116.2871" y2="1481.5039"/><rect fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="27" y="1480.5039"/><rect fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="23" y="1484.5039"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="30" y="1505.0391">Position-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="403" y="113.334">Position Event Handler</text><ellipse cx="483" cy="83.7988" fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="479,71.7988,485,66.7988,483,71.7988,485,76.7988,479,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="154" x="403" y="1494.0391">Position Event Handler</text><ellipse cx="483" cy="1512.9922" fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="479,1500.9922,485,1495.9922,483,1500.9922,485,1505.9922,479,1500.9922" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1046.5" y="113.334">Event-Topic</text><ellipse cx="1091" cy="83.7988" fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1079" x2="1103" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1046.5" y="1494.0391">Event-Topic</text><ellipse cx="1091" cy="1512.9922" fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1079" x2="1103" y1="1526.9922" y2="1526.9922"/><rect fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1149.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1145.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1152.5" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1149.5" y="1480.5039"/><rect fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1145.5" y="1484.5039"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1152.5" y="1505.0391">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1302.5" y="113.334">Position DAO</text><ellipse cx="1350.5" cy="83.7988" fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1338.5" x2="1362.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1302.5" y="1494.0391">Position DAO</text><ellipse cx="1350.5" cy="1512.9922" fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1338.5" x2="1362.5" y1="1526.9922" y2="1526.9922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1408.5" y="113.334">Transfer DAO</text><ellipse cx="1458" cy="83.7988" fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1446" x2="1470" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1408.5" y="1494.0391">Transfer DAO</text><ellipse cx="1458" cy="1512.9922" fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1446" x2="1470" y1="1526.9922" y2="1526.9922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1603.5" y="113.334">Central Store</text><path d="M1633.5,63.7988 C1633.5,53.7988 1651.5,53.7988 1651.5,53.7988 C1651.5,53.7988 1669.5,53.7988 1669.5,63.7988 L1669.5,89.7988 C1669.5,99.7988 1651.5,99.7988 1651.5,99.7988 C1651.5,99.7988 1633.5,99.7988 1633.5,89.7988 L1633.5,63.7988 " fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1633.5,63.7988 C1633.5,73.7988 1651.5,73.7988 1651.5,73.7988 C1651.5,73.7988 1669.5,73.7988 1669.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1603.5" y="1494.0391">Central Store</text><path d="M1633.5,1506.9922 C1633.5,1496.9922 1651.5,1496.9922 1651.5,1496.9922 C1651.5,1496.9922 1669.5,1496.9922 1669.5,1506.9922 L1669.5,1532.9922 C1669.5,1542.9922 1651.5,1542.9922 1651.5,1542.9922 C1651.5,1542.9922 1633.5,1542.9922 1633.5,1532.9922 L1633.5,1506.9922 " fill="#FEFECE" filter="url(#f13ytn3qc3vnot)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1633.5,1506.9922 C1633.5,1516.9922 1651.5,1516.9922 1651.5,1516.9922 C1651.5,1516.9922 1669.5,1516.9922 1669.5,1506.9922 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="103" y="171.5977"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="1345.2168" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="478" y="126.2871"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1214" y="1419.1934"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1345.5" y="451.082"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1345.5" y="686.9453"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1453" y="869.498"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1646.5" y="480.3926"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1646.5" y="716.2559"/><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1646.5" y="898.8086"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1331.2168" style="stroke: #000000; stroke-width: 2.0;" width="1744" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Position Handler Consume</text><polygon fill="#A80036" points="124,167.5977,114,171.5977,124,175.5977,120,171.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="118" x2="477" y1="171.5977" y2="171.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="130" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="143" y="167.166">Consume Position event batch of messages for Payer</text><path d="M393,216.9082 L608,216.9082 L608,223.9082 L598,233.9082 L393,233.9082 L393,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="752.5" x="393" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="408" y="230.4766">Persist Event Information</text><polygon fill="#A80036" points="1079,276.2188,1089,280.2188,1079,284.2188,1083,280.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1085" y1="280.2188" y2="280.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="275.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="508" y="275.7871">Publish event information</text><rect fill="#FFFFFF" filter="url(#f13ytn3qc3vnot)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="734.5" x="400" y="288.5293"/><polygon fill="#EEEEEE" points="400,288.5293,464,288.5293,464,295.5293,454,305.5293,400,305.5293,400,288.5293" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="413" y="303.0977">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="668.25" y="322.0977">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="36" x="826.25" y="322.0977">9.1.0.</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="826.25" x2="862.25" y1="324.0977" y2="324.0977"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="862.25" y="322.0977">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="672.25" y="337.4082"/><path d="M383,388.4609 L457,388.4609 L457,395.4609 L447,405.4609 L383,405.4609 L383,388.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1069.043" style="stroke: #000000; stroke-width: 2.0;" width="1364" x="383" y="388.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="398" y="402.0293">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="155" x="472" y="401.0957">[for each message in batch]</text><path d="M393,412.7715 L692,412.7715 L692,419.7715 L682,429.7715 L393,429.7715 L393,412.7715 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="404.416" style="stroke: #000000; stroke-width: 2.0;" width="1330" x="393" y="412.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="408" y="426.3398">Calculate position and persist change</text><polygon fill="#A80036" points="1333.5,447.082,1343.5,451.082,1333.5,455.082,1337.5,451.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1339.5" y1="451.082" y2="451.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="446.6504">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="508" y="446.6504">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1634.5,476.3926,1644.5,480.3926,1634.5,484.3926,1638.5,480.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1355.5" x2="1640.5" y1="480.3926" y2="480.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1362.5" y="475.9609">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="1375.5" y="475.9609">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f13ytn3qc3vnot)" points="1599,523.7031,1703,523.7031,1713,534.7031,1703,546.7031,1599,546.7031,1589,534.7031,1599,523.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1601" y="540.2715">transferPosition</text><polygon fill="#A80036" points="499,569.0137,489,573.0137,499,577.0137,495,573.0137" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="493" x2="1349.5" y1="573.0137" y2="573.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="505" y="568.582">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="518" y="568.582">Return latest position</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="530" y1="602.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="530" x2="530" y1="602.6348" y2="615.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489" x2="530" y1="615.6348" y2="615.6348"/><polygon fill="#A80036" points="499,611.6348,489,615.6348,499,619.6348,495,615.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="597.8926">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="424" x="508" y="597.8926">Calculate latest position (lpos) by incrementing transfer for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="530" y1="644.9453" y2="644.9453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="530" x2="530" y1="644.9453" y2="657.9453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="489" x2="530" y1="657.9453" y2="657.9453"/><polygon fill="#A80036" points="499,653.9453,489,657.9453,499,661.9453,495,657.9453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="640.2031">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="508" y="640.2031">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1333.5,682.9453,1343.5,686.9453,1333.5,690.9453,1337.5,686.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1339.5" y1="686.9453" y2="686.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="682.5137">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="508" y="682.5137">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1634.5,712.2559,1644.5,716.2559,1634.5,720.2559,1638.5,716.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1355.5" x2="1640.5" y1="716.2559" y2="716.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1362.5" y="711.8242">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="1375.5" y="711.8242">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f13ytn3qc3vnot)" points="1599,759.5664,1703,759.5664,1713,770.5664,1703,782.5664,1599,782.5664,1589,770.5664,1599,759.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1601" y="776.1348">transferPosition</text><polygon fill="#A80036" points="499,804.877,489,808.877,499,812.877,495,808.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="493" x2="1349.5" y1="808.877" y2="808.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="505" y="804.4453">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="527" y="804.4453">Return success</text><path d="M393,831.1875 L957,831.1875 L957,838.1875 L947,848.1875 L393,848.1875 L393,831.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1344" x="393" y="831.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="519" x="408" y="844.7559">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1441,865.498,1451,869.498,1441,873.498,1445,869.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1447" y1="869.498" y2="869.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="495" y="865.0664">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="517" y="865.0664">Request to persist batch transfer</text><polygon fill="#A80036" points="1634.5,894.8086,1644.5,898.8086,1634.5,902.8086,1638.5,898.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1463" x2="1640.5" y1="898.8086" y2="898.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1470" y="894.377">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1492" y="894.377">Persist batch transfer</text><polygon fill="#FFFFE0" filter="url(#f13ytn3qc3vnot)" points="1586,942.1191,1717,942.1191,1727,953.1191,1717,965.1191,1586,965.1191,1576,953.1191,1586,942.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1588" y="958.6875">transferStateChange</text><polygon fill="#A80036" points="499,987.4297,489,991.4297,499,995.4297,495,991.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="493" x2="1457" y1="991.4297" y2="991.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="505" y="986.998">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="527" y="986.998">Return success</text><path d="M493,1011.7402 L493,1388.7402 L755,1388.7402 L755,1021.7402 L745,1011.7402 L493,1011.7402 " fill="#FFFF00" filter="url(#f13ytn3qc3vnot)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M745,1011.7402 L745,1021.7402 L755,1021.7402 L745,1011.7402 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="499" y="1029.3086">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="499" y="1044.6191">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="515" y="1059.9297">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="515" y="1075.2402">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="515" y="1090.5508">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="515" y="1105.8613">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="515" y="1121.1719">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="531" y="1136.4824">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="531" y="1151.793">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="515" y="1167.1035">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="515" y="1182.4141">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="531" y="1197.7246">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="547" y="1213.0352">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="547" y="1228.3457">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="547" y="1243.6563">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="547" y="1258.9668">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="547" y="1274.2773">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="547" y="1289.5879">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="563" y="1304.8984">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="563" y="1320.209">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="547" y="1335.5195">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="531" y="1350.8301">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="515" y="1366.1406">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="499" y="1381.4512">}</text><polygon fill="#A80036" points="1202,1415.1934,1212,1419.1934,1202,1423.1934,1206,1419.1934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="488" x2="1208" y1="1419.1934" y2="1419.1934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="495" y="1414.7617">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="517" y="1414.7617">Publish Notification event</text><!--
@startuml
title 1.1.2.b. Position Handler Consume (batch messages)

autonumber


collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
control "Position Event Handler" as POS_HANDLER
entity "Position DAO" as POS_DAO
entity "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_POSITION_DFSP1
    participant POS_HANDLER
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume
    TOPIC_POSITION_DFSP1 <- POS_HANDLER: Consume Position event batch of messages for Payer
    activate TOPIC_POSITION_DFSP1
    deactivate TOPIC_POSITION_DFSP1

    group Persist Event Information
        |||
        POS_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over POS_HANDLER, TOPIC_EVENTS : Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0.]]} \n
        |||
    end

    loop for each message in batch
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) by incrementing transfer for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap

            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist batch transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist batch transfer
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b20
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>